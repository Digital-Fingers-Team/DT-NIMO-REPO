<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم الطالب - DT Edu</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
      :root {
        --primary: #4a6cf7;
        --primary-dark: #3a56d4;
        --secondary: #6c5ce7;
        --accent: #00b894;
        --light: #f8f9fa;
        --dark: #2d3436;
        --text: #333;
        --text-light: #666;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        --sidebar-width: 260px;
      }

      .dark-mode {
        --light: #1a1a2e;
        --dark: #f8f9fa;
        --text: #e6e6e6;
        --text-light: #b0b0b0;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Tajawal", "Segoe UI", sans-serif;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f8ff 0%, #e1f0fa 100%);
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
      }

      body.dark-mode {
        background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
      }

      body.rtl {
        direction: rtl;
      }

      body.ltr {
        direction: ltr;
      }

      /* التصميم الرئيسي */
      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      /* الشريط الجانبي */
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          180deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 20px 0;
        box-shadow: var(--shadow);
        z-index: 100;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: var(--transition);
      }

      body.rtl .sidebar {
        right: 0;
      }

      body.rtl .main-content {
        margin-right: var(--sidebar-width);
      }

      body.ltr .sidebar {
        left: 0;
      }

      body.ltr .main-content {
        margin-left: var(--sidebar-width);
        margin-right: 0;
      }

      .sidebar-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
      }

      .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .logo {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .logo img {
        width: 140px;
        height: auto;
        object-fit: contain;
        border-radius: 50%;
      }

      .logo-text {
        font-size: 24px;
        font-weight: 800;
        background: linear-gradient(135deg, white, #e1f0fa);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .user-info {
        text-align: center;
        margin-top: 10px;
      }

      .user-name {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
      }

      .user-type {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-block;
      }

      .sidebar-menu {
        list-style: none;
        padding: 0 15px;
        margin-bottom: 20px;
      }

      .menu-item {
        margin-bottom: 8px;
        border-radius: 10px;
        overflow: hidden;
      }

      .menu-item a {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: white;
        text-decoration: none;
        transition: var(--transition);
      }

      .menu-item a:hover,
      .menu-item.active a {
        background: rgba(255, 255, 255, 0.15);
      }

      body.rtl .menu-item a:hover,
      body.rtl .menu-item.active a {
        transform: translateX(-5px);
      }

      body.ltr .menu-item a:hover,
      body.ltr .menu-item.active a {
        transform: translateX(5px);
      }

      .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      body.rtl .menu-item i {
        margin-left: 10px;
      }

      body.ltr .menu-item i {
        margin-right: 10px;
      }

      .menu-item span {
        flex: 1;
      }

      .notification-badge {
        background: #e74c3c;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 5px;
      }

      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: auto;
      }

      .sidebar-footer .menu-item a {
        padding: 10px 15px;
      }

      /* المحتوى الرئيسي */
      .main-content {
        flex: 1;
        padding: 20px;
        transition: var(--transition);
      }

      .header {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .header {
        background: var(--light);
        color: var(--dark);
      }

      .header h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 700;
      }

      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .dark-mode-toggle,
      .logout-btn {
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dark-mode-toggle {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
      }

      .dark-mode-toggle:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      .logout-btn {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .logout-btn:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      /* بطاقات الإحصائيات */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        display: flex;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .stat-card {
        background: var(--light);
        color: var(--dark);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      body.rtl .stat-icon {
        margin-left: 15px;
      }

      body.ltr .stat-icon {
        margin-right: 15px;
      }

      .stat-info {
        flex: 1;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 5px;
      }

      .stat-label {
        color: var(--text-light);
        font-size: 14px;
      }

      /* الشبكة الرئيسية */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .dashboard-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      body.dark-mode .dashboard-card {
        background: var(--light);
        color: var(--dark);
      }

      .dashboard-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
      }

      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        background: var(--primary);
      }

      body.rtl .card-icon {
        margin-left: 15px;
      }

      body.ltr .card-icon {
        margin-right: 15px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text);
      }

      .card-content {
        color: var(--text-light);
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .card-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .badge-new {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .badge-pending {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .badge-graded {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
      }

      .card-actions {
        display: flex;
        justify-content: flex-end;
      }

      .card-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      /* قسم الفصل الدراسي */
      .classroom-section {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
      }

      body.dark-mode .classroom-section {
        background: var(--light);
        color: var(--dark);
      }

      .classroom-title {
        color: var(--primary);
        font-size: 24px;
        margin-bottom: 15px;
      }

      .classroom-description {
        color: var(--text-light);
        margin-bottom: 25px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .classroom-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(74, 108, 247, 0.4);
      }

      .classroom-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(74, 108, 247, 0.6);
      }

      /* النوافذ المنبثقة */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .modal-content {
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        position: relative;
        animation: modalFadeIn 0.3s ease-out;
      }

      body.dark-mode .modal-content {
        background-color: var(--light);
        color: var(--dark);
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .close-btn {
        position: absolute;
        top: 20px;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
        transition: var(--transition);
      }

      body.rtl .close-btn {
        left: 25px;
      }

      body.ltr .close-btn {
        right: 25px;
      }

      .close-btn:hover {
        color: var(--text);
      }

      .modal-title {
        color: var(--primary);
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        font-size: 24px;
      }

      body.dark-mode .modal-title {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* تصاميم خاصة بالمحتوى التفاعلي */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text);
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: var(--transition);
        background-color: #f8f9fa;
      }

      body.dark-mode .form-group input,
      body.dark-mode .form-group textarea,
      body.dark-mode .form-group select {
        background-color: var(--light);
        color: var(--dark);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: var(--primary);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
      }

      body.dark-mode .form-group input:focus,
      body.dark-mode .form-group textarea:focus,
      body.dark-mode .form-group select:focus {
        background-color: var(--light);
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-btn {
        display: block;
        padding: 20px;
        background: rgba(74, 108, 247, 0.05);
        color: var(--primary);
        border: 3px dashed var(--primary);
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
      }

      .file-input-btn:hover {
        background: rgba(74, 108, 247, 0.1);
        border-color: var(--primary-dark);
      }

      .file-input-btn i {
        font-size: 40px;
        margin-bottom: 10px;
        display: block;
      }

      .file-input-btn span {
        font-size: 16px;
        font-weight: 600;
      }

      .submit-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .submit-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .submit-btn.secondary {
        background: transparent;
        color: var(--text);
        border: 2px solid #e0e0e0;
      }

      .submit-btn.secondary:hover {
        background: #f8f9fa;
        border-color: var(--primary);
      }

      .content-list {
        list-style: none;
        margin-top: 15px;
      }

      .content-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
        border-radius: 8px;
        margin-bottom: 10px;
      }

      body.dark-mode .content-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .content-item:hover {
        background: rgba(74, 108, 247, 0.05);
      }

      .content-item:last-child {
        border-bottom: none;
      }

      .content-name {
        font-weight: 600;
        color: var(--text);
      }

      .content-meta {
        display: flex;
        flex-direction: column;
        gap: 5px;
        color: var(--text-light);
        font-size: 14px;
      }

      .content-actions {
        display: flex;
        gap: 10px;
      }

      .content-btn {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .content-btn:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      .download-btn {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .download-btn:hover {
        background: rgba(46, 204, 113, 0.2);
      }

      .upload-btn {
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .upload-btn:hover {
        background: rgba(52, 152, 219, 0.2);
      }

      .badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
      }

      .badge-new {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .badge-pending {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .badge-submitted {
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
      }

      .badge-graded {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
      }

      .badge-late {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid rgba(74, 108, 247, 0.1);
        margin-bottom: 25px;
      }

      .tab {
        padding: 12px 20px;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-light);
        transition: var(--transition);
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
      }

      .tab:hover {
        color: var(--primary);
      }

      .tab.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .chart-container {
        margin-top: 20px;
        height: 300px;
        position: relative;
      }

      .message-area {
        width: 100%;
        height: 150px;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: var(--transition);
        background-color: #f8f9fa;
        resize: vertical;
      }

      body.dark-mode .message-area {
        background-color: var(--light);
        color: var(--dark);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .message-area:focus {
        border-color: var(--primary);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
      }

      body.dark-mode .message-area:focus {
        background-color: var(--light);
      }

      /* إشعارات */
      .toast-message {
        position: fixed;
        top: 30px;
        z-index: 3000;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 400px;
        font-weight: 500;
      }

      body.rtl .toast-message {
        right: 30px;
      }

      body.ltr .toast-message {
        left: 30px;
      }

      .toast-success {
        background: #00b894;
        color: white;
        border-left: 5px solid #00a085;
      }

      .toast-error {
        background: #e74c3c;
        color: white;
        border-left: 5px solid #c0392b;
      }

      .toast-info {
        background: #3498db;
        color: white;
        border-left: 5px solid #2980b9;
      }

      .toast-warning {
        background: #fdcb6e;
        color: #333;
        border-left: 5px solid #f39c12;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }

      /* معاينة الملفات */
      .file-preview {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #e0e0e0;
      }

      body.dark-mode .file-preview {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
      }

      /* رسومات */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-light);
      }

      .empty-state i {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ddd;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: var(--text);
      }

      /* تصفية */
      .filter-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      /* التصميم المتجاوب */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
      }

      @media (max-width: 992px) {
        .sidebar {
          width: 80px;
        }

        .sidebar-header .logo-text,
        .user-info,
        .menu-item span {
          display: none;
        }

        body.rtl .main-content {
          margin-right: 80px;
        }

        body.ltr .main-content {
          margin-left: 80px;
        }

        .menu-item a {
          justify-content: center;
          padding: 15px;
        }

        .menu-item i {
          margin: 0;
          font-size: 20px;
        }

        .sidebar-footer .menu-item span {
          display: none;
        }

        .notification-badge {
          position: absolute;
          top: 10px;
        }

        body.rtl .notification-badge {
          left: 10px;
        }

        body.ltr .notification-badge {
          right: 10px;
        }
      }

      @media (max-width: 768px) {
        .stats-cards {
          grid-template-columns: 1fr;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .header-actions {
          justify-content: center;
        }

        .content-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .content-actions {
          align-self: stretch;
          justify-content: flex-end;
        }

        .modal-content {
          padding: 20px;
          width: 95%;
        }
      }

      @media (max-width: 576px) {
        .main-content {
          padding: 15px;
        }

        .modal-content {
          padding: 20px;
          width: 100%;
        }

        .sidebar {
          width: 70px;
        }

        body.rtl .main-content {
          margin-right: 70px;
        }

        body.ltr .main-content {
          margin-left: 70px;
        }
      }
    </style>
  </head>

  <body class="rtl">
    <div class="dashboard-container">
      <!-- الشريط الجانبي -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="logo-container">
            <div class="logo">
              <img src="logo.png" alt="Logo" />
            </div>
          </div>
          <div class="logo-text">DT Edu</div>
          <div class="user-info">
            <div class="user-name" id="user-name">أحمد الطالب</div>
            <div class="user-type" id="user-type">طالب</div>
          </div>
        </div>

        <ul class="sidebar-menu">
          <li class="menu-item active">
            <a href="student-dashboard.html">
              <i class="fas fa-home"></i>
              <span id="menu-dashboard">لوحة التحكم</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="student-schedule.html">
              <i class="fas fa-calendar-alt"></i>
              <span id="menu-schedule">الجدول الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="student-courses.html">
              <i class="fas fa-book"></i>
              <span id="menu-courses">المقررات الدراسية</span>
              <span
                class="notification-badge"
                id="courses-badge"
                style="display: none"
                >3</span
              >
            </a>
          </li>
          <li class="menu-item">
            <a href="student-progress.html">
              <i class="fas fa-chart-bar"></i>
              <span id="menu-progress">التقدم الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="student-messages.html">
              <i class="fas fa-comments"></i>
              <span id="menu-messages">الرسائل</span>
              <span
                class="notification-badge"
                id="messages-badge"
                style="display: none"
                >5</span
              >
            </a>
          </li>
          <li class="menu-item">
            <a href="student-settings.html">
              <i class="fas fa-cog"></i>
              <span id="menu-settings">الإعدادات</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <ul class="sidebar-menu">
            <li class="menu-item">
              <a
                href="javascript:void(0)"
                id="sidebar-dark-mode-toggle"
                style="display: none"
              >
                <i class="fas fa-moon"></i>
                <span id="dark-mode-text">الوضع الداكن</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="login.html" id="logout-link">
                <i class="fas fa-sign-out-alt"></i>
                <span id="logout-text">تسجيل الخروج</span>
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- المحتوى الرئيسي -->
      <div class="main-content">
        <div class="header">
          <h1 id="header-title">لوحة تحكم الطالب - نظام DT Edu</h1>
          <div class="header-actions">
            <button
              class="dark-mode-toggle"
              id="header-dark-mode-toggle"
              style="display: none"
            >
              <i class="fas fa-moon"></i>
              <span id="dark-mode-btn-text">الوضع الداكن</span>
            </button>
            <button class="logout-btn" id="header-logout-btn">
              <i class="fas fa-sign-out-alt"></i>
              <span id="header-logout-text">تسجيل الخروج</span>
            </button>
          </div>
        </div>

        <!-- محتوى خاص بالطالب -->
        <div id="student-content" class="user-specific-content active">
          <!-- بطاقات الإحصائيات للطالب -->
          <div class="stats-cards">
            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
              >
                <i class="fas fa-book-open"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value">85%</div>
                <div class="stat-label" id="student-progress-stat">
                  التقدم الدراسي
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #00b894, #00a085)"
              >
                <i class="fas fa-tasks"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="homework-count">12/15</div>
                <div class="stat-label" id="student-homework-stat">
                  الواجبات المكتملة
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #fd79a8, #e84393)"
              >
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value">95%</div>
                <div class="stat-label" id="student-attendance-stat">
                  نسبة الحضور
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #fdcb6e, #e17055)"
              >
                <i class="fas fa-trophy"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="new-assignments-count">3</div>
                <div class="stat-label" id="student-new-assignments">
                  واجبات جديدة
                </div>
              </div>
            </div>
          </div>

          <!-- الشبكة الرئيسية للطالب -->
          <div class="dashboard-grid">
            <!-- بطاقة 1: الواجبات المطلوبة -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
                >
                  <i class="fas fa-tasks"></i>
                </div>
                <div class="card-title" id="student-homework-card">
                  الواجبات المطلوبة
                </div>
              </div>
              <div class="card-content" id="student-homework-desc">
                عرض الواجبات المطلوبة وتواريخ التسليم.
                <div
                  class="card-badge badge-new"
                  id="new-homework-badge"
                  style="display: none"
                >
                  واجبات جديدة
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="student-homework-btn"
                  onclick="openHomeworkModal()"
                >
                  <i class="fas fa-eye"></i>
                  <span id="view-homework-btn">عرض</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 2: تسليم الواجبات -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #00b894, #00a085)"
                >
                  <i class="fas fa-file-upload"></i>
                </div>
                <div class="card-title" id="student-submit-card">
                  تسليم الواجبات
                </div>
              </div>
              <div class="card-content" id="student-submit-desc">
                رفع وتسليم الواجبات للأساتذة.
                <div
                  class="card-badge badge-pending"
                  id="pending-upload-badge"
                  style="display: none"
                >
                  واجبات قيد التسليم
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="student-submit-btn"
                  onclick="openSubmitModal()"
                >
                  <i class="fas fa-upload"></i>
                  <span id="submit-work-btn">تسليم واجب</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 3: استلام التقييمات -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #3498db, #2980b9)"
                >
                  <i class="fas fa-file-download"></i>
                </div>
                <div class="card-title" id="student-receive-card">
                  استلام التقييمات
                </div>
              </div>
              <div class="card-content" id="student-receive-desc">
                تحميل وتنزيل الواجبات والملفات من الأساتذة.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="student-receive-btn"
                  onclick="openReceivedModal()"
                >
                  <i class="fas fa-download"></i>
                  <span id="receive-files-btn">الملفات المرفوعة</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 4: المواد الدراسية -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fd79a8, #e84393)"
                >
                  <i class="fas fa-book"></i>
                </div>
                <div class="card-title" id="student-courses-card">
                  المواد الدراسية
                </div>
              </div>
              <div class="card-content" id="student-courses-desc">
                الوصول إلى المواد الدراسية والموارد التعليمية.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="student-courses-btn"
                  onclick="openCoursesModal()"
                >
                  <i class="fas fa-folder-open"></i>
                  <span id="open-courses-btn">فتح</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 5: التقدم الدراسي -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fdcb6e, #e17055)"
                >
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-title" id="student-progress-card">
                  التقدم الدراسي
                </div>
              </div>
              <div class="card-content" id="student-progress-desc">
                متابعة التقدم الدراسي في جميع المواد.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="student-progress-btn"
                  onclick="openProgressModal()"
                >
                  <i class="fas fa-chart-bar"></i>
                  <span id="view-progress-btn">عرض</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 6: التواصل -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #81ecec, #00cec9)"
                >
                  <i class="fas fa-comments"></i>
                </div>
                <div class="card-title" id="student-messaging-card">
                  التواصل
                </div>
              </div>
              <div class="card-content" id="student-messaging-desc">
                التواصل مع المعلمين والزملاء.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="student-messaging-btn"
                  onclick="openMessagingModal()"
                >
                  <i class="fas fa-comment"></i>
                  <span id="message-btn">مراسلة</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- قسم الفصل الدراسي -->
        <div class="classroom-section">
          <h2 class="classroom-title" id="classroom-title">
            الفصل الدراسي التفاعلي
          </h2>
          <p class="classroom-description" id="classroom-desc">
            انضم إلى الفصل الدراسي التفاعلي للاستفادة من الدروس الحية والتفاعل
            المباشر مع المعلمين والزملاء.
          </p>
          <button
            class="classroom-btn"
            id="classroom-btn"
            onclick="openClassroom()"
          >
            <i class="fas fa-door-open"></i>
            <span id="enter-classroom-btn">الدخول إلى الفصل الدراسي</span>
          </button>
        </div>
      </div>
    </div>

    <!-- النوافذ المنبثقة -->

    <!-- نافذة الواجبات المطلوبة -->
    <div id="homework-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('homework-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="homework-title">الواجبات المطلوبة</h2>

        <div class="tabs">
          <div
            class="tab active"
            onclick="switchTab('homework-tab', 'pending')"
          >
            قيد الانتظار
          </div>
          <div class="tab" onclick="switchTab('homework-tab', 'submitted')">
            تم التسليم
          </div>
          <div class="tab" onclick="switchTab('homework-tab', 'graded')">
            تم التقييم
          </div>
        </div>

        <div id="homework-content">
          <div class="filter-container">
            <div class="filter-group">
              <label for="homework-filter">المادة:</label>
              <select id="homework-filter" onchange="loadHomeworkList()">
                <option value="all">جميع المواد</option>
                <option value="math">الرياضيات</option>
                <option value="arabic">اللغة العربية</option>
                <option value="science">العلوم</option>
                <option value="english">الإنجليزية</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="homework-sort">ترتيب حسب:</label>
              <select id="homework-sort" onchange="loadHomeworkList()">
                <option value="dueDate">موعد التسليم</option>
                <option value="newest">الأحدث</option>
                <option value="subject">المادة</option>
              </select>
            </div>
          </div>

          <div id="pending-tab" class="tab-content active">
            <ul class="content-list" id="homework-list-pending">
              <!-- سيتم تعبئته بالجافاسكريبت -->
            </ul>
            <div
              class="empty-state"
              id="homework-empty-pending"
              style="display: none"
            >
              <i class="fas fa-check-circle"></i>
              <h3 id="no-pending-homework">لا توجد واجبات قيد الانتظار</h3>
              <p id="all-done">لقد أنجزت جميع واجباتك!</p>
            </div>
          </div>

          <div id="submitted-tab" class="tab-content">
            <ul class="content-list" id="homework-list-submitted">
              <!-- سيتم تعبئته بالجافاسكريبت -->
            </ul>
            <div
              class="empty-state"
              id="homework-empty-submitted"
              style="display: none"
            >
              <i class="fas fa-inbox"></i>
              <h3 id="no-submitted-homework">لا توجد واجبات مسلمة</h3>
              <p id="submit-first">قم بتسليم واجبك الأول!</p>
            </div>
          </div>

          <div id="graded-tab" class="tab-content">
            <ul class="content-list" id="homework-list-graded">
              <!-- سيتم تعبئته بالجافاسكريبت -->
            </ul>
            <div
              class="empty-state"
              id="homework-empty-graded"
              style="display: none"
            >
              <i class="fas fa-graduation-cap"></i>
              <h3 id="no-graded-homework">لا توجد واجبات مصححة</h3>
              <p id="wait-for-grading">انتظر تقييم واجباتك من المعلم</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة تسليم الواجب -->
    <div id="submit-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('submit-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="submit-title">تسليم واجب</h2>

        <div id="submit-content">
          <div class="form-group">
            <label for="submit-assignment">اختر الواجب *</label>
            <select id="submit-assignment" required>
              <option value="">اختر واجباً للتسليم</option>
            </select>
          </div>

          <div id="assignment-details" style="display: none">
            <div
              class="file-info"
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
              "
            >
              <h4
                style="color: var(--primary); margin-bottom: 10px"
                id="selected-assignment-title"
              ></h4>
              <div class="content-meta">
                <div>
                  <strong id="assignment-subject-label">المادة:</strong>
                  <span id="selected-assignment-subject"></span>
                </div>
                <div>
                  <strong id="assignment-duedate-label">موعد التسليم:</strong>
                  <span id="selected-assignment-duedate"></span>
                </div>
                <div>
                  <strong id="assignment-description-label">الوصف:</strong>
                  <span id="selected-assignment-description"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="submit-file">رفع ملف الواجب *</label>
            <div class="file-input-wrapper">
              <div class="file-input-btn">
                <i class="fas fa-cloud-upload-alt"></i>
                <span id="submit-file-text"
                  >انقر لرفع ملف الواجب (PDF, DOCX, صور, ZIP)</span
                >
                <small
                  style="display: block; margin-top: 5px; font-size: 14px"
                  id="file-size-limit"
                  >الحجم الأقصى: 10MB</small
                >
              </div>
              <input
                type="file"
                id="submit-file"
                accept=".pdf,.docx,.jpg,.jpeg,.png,.zip"
                required
              />
            </div>
            <small
              id="file-name"
              style="display: block; margin-top: 8px; color: var(--text-light)"
            ></small>
            <div
              id="file-preview"
              class="file-preview"
              style="display: none"
            ></div>
          </div>

          <div class="form-group">
            <label for="submit-notes">ملاحظات (اختياري)</label>
            <textarea
              id="submit-notes"
              rows="3"
              placeholder="أدخل أي ملاحظات حول الواجب..."
            ></textarea>
          </div>

          <div style="display: flex; gap: 15px; margin-top: 30px">
            <button
              class="submit-btn"
              onclick="submitAssignment()"
              id="submit-assignment-btn"
            >
              <i class="fas fa-paper-plane"></i>
              <span>تسليم الواجب</span>
            </button>
            <button
              class="submit-btn secondary"
              onclick="closeModal('submit-modal')"
              id="cancel-submit-btn"
            >
              إلغاء
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة استلام الملفات -->
    <div id="received-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('received-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="received-title">
          الملفات المرفوعة من المعلمين
        </h2>

        <div class="tabs">
          <div
            class="tab active"
            onclick="switchTab('received-tab', 'assignments')"
          >
            الواجبات
          </div>
          <div class="tab" onclick="switchTab('received-tab', 'resources')">
            الموارد التعليمية
          </div>
          <div class="tab" onclick="switchTab('received-tab', 'grades')">
            التقييمات
          </div>
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label for="received-filter">المادة:</label>
            <select id="received-filter" onchange="loadReceivedFiles()">
              <option value="all">جميع المواد</option>
              <option value="math">الرياضيات</option>
              <option value="arabic">اللغة العربية</option>
              <option value="science">العلوم</option>
              <option value="english">الإنجليزية</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="received-sort">ترتيب حسب:</label>
            <select id="received-sort" onchange="loadReceivedFiles()">
              <option value="newest">الأحدث</option>
              <option value="oldest">الأقدم</option>
              <option value="name">الاسم</option>
            </select>
          </div>
        </div>

        <div id="assignments-tab" class="tab-content active">
          <ul class="content-list" id="assignments-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>
          <div class="empty-state" id="assignments-empty" style="display: none">
            <i class="fas fa-file-alt"></i>
            <h3 id="no-assignments-available">لا توجد واجبات مرفوعة</h3>
            <p id="wait-for-assignments">انتظر رفع المعلمين للواجبات</p>
          </div>
        </div>

        <div id="resources-tab" class="tab-content">
          <ul class="content-list" id="resources-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>
          <div class="empty-state" id="resources-empty" style="display: none">
            <i class="fas fa-book"></i>
            <h3 id="no-resources-available">لا توجد موارد تعليمية</h3>
            <p id="wait-for-resources">سيقوم المعلمون برفع الموارد قريباً</p>
          </div>
        </div>

        <div id="grades-tab" class="tab-content">
          <ul class="content-list" id="grades-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>
          <div class="empty-state" id="grades-empty" style="display: none">
            <i class="fas fa-graduation-cap"></i>
            <h3 id="no-grades-available">لا توجد تقييمات</h3>
            <p id="wait-for-grades">انتظر تقييم واجباتك من المعلمين</p>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة المواد الدراسية -->
    <div id="courses-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('courses-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="courses-title">المواد الدراسية</h2>
        <div id="courses-content">
          <div class="dashboard-grid">
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
                >
                  <i class="fas fa-calculator"></i>
                </div>
                <div class="card-title">الرياضيات</div>
              </div>
              <div class="card-content">
                مواد الرياضيات والموارد التعليمية المتاحة.
              </div>
              <div class="card-actions">
                <button class="card-btn" onclick="viewCourse('math')">
                  <i class="fas fa-folder-open"></i>
                  <span>فتح</span>
                </button>
              </div>
            </div>

            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #00b894, #00a085)"
                >
                  <i class="fas fa-book"></i>
                </div>
                <div class="card-title">اللغة العربية</div>
              </div>
              <div class="card-content">
                مواد اللغة العربية والموارد التعليمية المتاحة.
              </div>
              <div class="card-actions">
                <button class="card-btn" onclick="viewCourse('arabic')">
                  <i class="fas fa-folder-open"></i>
                  <span>فتح</span>
                </button>
              </div>
            </div>

            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fd79a8, #e84393)"
                >
                  <i class="fas fa-flask"></i>
                </div>
                <div class="card-title">العلوم</div>
              </div>
              <div class="card-content">
                مواد العلوم والموارد التعليمية المتاحة.
              </div>
              <div class="card-actions">
                <button class="card-btn" onclick="viewCourse('science')">
                  <i class="fas fa-folder-open"></i>
                  <span>فتح</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة التقدم الدراسي -->
    <div id="progress-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('progress-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="progress-title">التقدم الدراسي</h2>
        <div id="progress-content">
          <div class="chart-container">
            <canvas id="progress-chart"></canvas>
          </div>
          <div class="form-group" style="margin-top: 20px">
            <label for="progress-period" id="progress-period-label"
              >الفترة الزمنية:</label
            >
            <select id="progress-period">
              <option value="week">آخر أسبوع</option>
              <option value="month">آخر شهر</option>
              <option value="semester">الفصل الدراسي</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة التواصل -->
    <div id="messaging-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('messaging-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="messaging-title">التواصل</h2>
        <div id="messaging-content">
          <div class="form-group">
            <label for="message-recipient" id="message-recipient-label"
              >المستلم</label
            >
            <select id="message-recipient">
              <option value="">اختر المستلم</option>
              <option value="teacher">المعلم</option>
              <option value="classmates">زملاء الفصل</option>
              <option value="admin">الإدارة</option>
            </select>
          </div>
          <div class="form-group">
            <label for="message-subject" id="message-subject-label"
              >عنوان الرسالة</label
            >
            <input
              type="text"
              id="message-subject"
              placeholder="أدخل عنوان الرسالة"
            />
          </div>
          <div class="form-group">
            <label for="message-content" id="message-content-label"
              >نص الرسالة</label
            >
            <textarea
              class="message-area"
              id="message-content"
              placeholder="اكتب رسالتك هنا..."
            ></textarea>
          </div>
          <div class="form-group">
            <button
              class="submit-btn"
              onclick="sendMessage()"
              id="send-message-btn"
            >
              <i class="fas fa-paper-plane"></i>
              <span>إرسال الرسالة</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة معاينة الملف -->
    <div id="preview-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('preview-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="preview-title">معاينة الملف</h2>
        <div id="preview-content">
          <!-- سيتم تعبئته بالجافاسكريبت -->
        </div>
      </div>
    </div>

    <!-- إشعارات -->
    <div id="toast-container"></div>

    <script>
      // ============================================
      // البيانات والمتغيرات العامة
      // ============================================

      // استعادة اللغة المحفوظة
      let currentLanguage = localStorage.getItem("currentLanguage") || "ar";

      // استعادة وضع التصميم المحفوظ
      let darkMode = localStorage.getItem("darkMode") === "true";

      // استعادة معلومات المستخدم
      let currentUser = JSON.parse(
        localStorage.getItem("currentUser") ||
          '{"id":"student1","name":"أحمد الطالب","type":"student","class":"10a","email":"student@dtedu.com"}'
      );
      const currentStudentId = currentUser.id || "student1";
      const currentStudentClass = currentUser.class || "10a";

      // بيانات المثال
      const subjects = {
        math: { ar: "الرياضيات", en: "Mathematics" },
        arabic: { ar: "اللغة العربية", en: "Arabic" },
        science: { ar: "العلوم", en: "Science" },
        english: { ar: "الإنجليزية", en: "English" },
      };

      const classes = {
        "10a": { ar: "الصف العاشر - أ", en: "10th Grade - A" },
        "10b": { ar: "الصف العاشر - ب", en: "10th Grade - B" },
        "11a": { ar: "الصف الحادي عشر - أ", en: "11th Grade - A" },
        "11b": { ar: "الصف الحادي عشر - ب", en: "11th Grade - B" },
        "12a": { ar: "الصف الثاني عشر - أ", en: "12th Grade - A" },
      };

      // ============================================
      // تهيئة الصفحة
      // ============================================

      document.addEventListener("DOMContentLoaded", function () {
        // تحديث اتجاه الصفحة واللغة والوضع الداكن
        document.body.className = currentLanguage === "ar" ? "rtl" : "ltr";
        if (darkMode) {
          document.body.classList.add("dark-mode");
        }

        // تحديث معلومات المستخدم في الصفحة
        updateUserInfo();

        // تحديث النصوص حسب اللغة
        updateLanguage();

        // تحديث نص الوضع الداكن
        updateDarkModeText();

        // تهيئة الأحداث
        initEvents();

        // تهيئة البيانات التجريبية
        initSampleData();

        // تحميل البيانات
        loadStudentStats();
        loadPendingAssignments();

        // التحقق من FileSaver.js
        checkFileSaver();
      });

      // ============================================
      // وظائف التهيئة
      // ============================================

      function updateUserInfo() {
        if (currentUser.name) {
          document.getElementById("user-name").textContent = currentUser.name;
        }
      }

      function initEvents() {
        // إعداد زر الوضع الداكن
        document
          .querySelectorAll(
            "#header-dark-mode-toggle, #sidebar-dark-mode-toggle"
          )
          .forEach((btn) => {
            btn.addEventListener("click", toggleDarkMode);
          });

        // إعداد زر تسجيل الخروج
        document
          .getElementById("logout-link")
          .addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });

        document
          .getElementById("header-logout-btn")
          .addEventListener("click", logout);

        // إعداد زر الفصل الدراسي
        document
          .getElementById("classroom-btn")
          .addEventListener("click", function () {
            showToast(
              "info",
              currentLanguage === "ar"
                ? "جاري فتح الفصل الدراسي التفاعلي..."
                : "Opening interactive classroom..."
            );
          });

        // إعداد معالجات الملفات
        document
          .getElementById("submit-file")
          .addEventListener("change", function (e) {
            handleFileSelection(e, "file-name", "file-preview");
          });

        // تحديث تفاصيل الواجب عند التغيير
        document
          .getElementById("submit-assignment")
          .addEventListener("change", updateAssignmentDetails);

        // تحديث قائمة الواجبات عند تغيير التبويبات
        document.querySelectorAll("#homework-modal .tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            setTimeout(loadHomeworkList, 100);
          });
        });

        // تحديث قائمة الملفات عند تغيير التبويبات
        document.querySelectorAll("#received-modal .tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            setTimeout(loadReceivedFiles, 100);
          });
        });
      }

      function initSampleData() {
        // التحقق من وجود بيانات تجريبية
        const hasData = localStorage.getItem("studentDataInitialized");

        if (!hasData) {
          // إعداد بيانات تجريبية
          const sampleData = {
            // واجبات مرفوعة من المعلمين
            teacherAssignments: [
              {
                id: 1,
                teacherId: "teacher1",
                teacherName: "أحمد المعلم",
                type: "homework",
                title: "واجب المعادلات الخطية",
                subject: "math",
                subjectName: "الرياضيات",
                class: "10a",
                className: "الصف العاشر - أ",
                description:
                  "حل المعادلات الخطية من التمرين 1 إلى 10 في الصفحة 45",
                dueDate: new Date(
                  Date.now() + 7 * 24 * 60 * 60 * 1000
                ).toISOString(), // بعد أسبوع
                maxGrade: 100,
                fileName: "واجب_المعادلات_الخطية.pdf",
                fileType: "application/pdf",
                fileSize: 1234567,
                fileContent:
                  "data:application/pdf;base64,SGVsbG8gdGhpcyBpcyBhIHNhbXBsZSBQREYgZmlsZQ==",
                uploadDate: new Date().toISOString(),
                status: "active",
              },
              {
                id: 2,
                teacherId: "teacher1",
                teacherName: "أحمد المعلم",
                type: "quiz",
                title: "اختبار قصير في العلوم",
                subject: "science",
                subjectName: "العلوم",
                class: "10a",
                className: "الصف العاشر - أ",
                description: "اختبار في درس الخلية النباتية والحيوانية",
                dueDate: new Date(
                  Date.now() + 5 * 24 * 60 * 60 * 1000
                ).toISOString(), // بعد 5 أيام
                maxGrade: 50,
                fileName: "اختبار_العلوم.docx",
                fileType:
                  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                fileSize: 987654,
                fileContent:
                  "data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,SGVsbG8gdGhpcyBpcyBhIHNhbXBsZSBET0NYIGZpbGU=",
                uploadDate: new Date().toISOString(),
                status: "active",
              },
            ],

            // تسجيلات الطالب
            studentSubmissions: [
              {
                id: 1,
                assignmentId: 1,
                studentId: currentStudentId,
                studentName: currentUser.name,
                fileName: "واجب_المعادلات_الخطية_محمد.pdf",
                fileType: "application/pdf",
                fileSize: 234567,
                notes: "تم حل جميع التمارين",
                submissionDate: new Date(
                  Date.now() - 2 * 24 * 60 * 60 * 1000
                ).toISOString(), // قبل يومين
                status: "submitted",
                grade: 95,
                feedback: "عمل ممتاز، جميع الإجابات صحيحة",
                gradeDate: new Date(
                  Date.now() - 1 * 24 * 60 * 60 * 1000
                ).toISOString(), // قبل يوم
                gradedBy: "teacher1",
              },
            ],

            // موارد تعليمية مرفوعة من المعلمين
            teacherResources: [
              {
                id: 1,
                teacherId: "teacher1",
                teacherName: "أحمد المعلم",
                title: "عرض تقديمي عن الدوال الرياضية",
                type: "presentation",
                description: "عرض تقديمي يشرح أنواع الدوال الرياضية",
                subject: "math",
                fileName: "عرض_الدوال_الرياضية.pptx",
                fileType:
                  "application/vnd.openxmlformats-officedocument.presentationml.presentation",
                fileSize: 4567890,
                fileContent:
                  "data:application/vnd.openxmlformats-officedocument.presentationml.presentation;base64,SGVsbG8gdGhpcyBpcyBhIHNhbXBsZSBQUFRYIGZpbGU=",
                uploadDate: new Date().toISOString(),
                downloads: 0,
              },
              {
                id: 2,
                teacherId: "teacher2",
                teacherName: "فاطمة المعلمة",
                title: "ملخص قواعد اللغة العربية",
                type: "document",
                description: "ملخص شامل لقواعد اللغة العربية",
                subject: "arabic",
                fileName: "ملخص_قواعد_العربية.pdf",
                fileType: "application/pdf",
                fileSize: 1234567,
                fileContent:
                  "data:application/pdf;base64,SGVsbG8gdGhpcyBpcyBhIHNhbXBsZSBQREYgZmlsZQ==",
                uploadDate: new Date(
                  Date.now() - 3 * 24 * 60 * 60 * 1000
                ).toISOString(), // قبل 3 أيام
                downloads: 0,
              },
            ],
          };

          // حفظ البيانات في localStorage
          localStorage.setItem(
            "teacherAssignments",
            JSON.stringify(sampleData.teacherAssignments)
          );
          localStorage.setItem(
            "studentSubmissions",
            JSON.stringify(sampleData.studentSubmissions)
          );
          localStorage.setItem(
            "teacherResources",
            JSON.stringify(sampleData.teacherResources)
          );

          // علامة أن البيانات تم تهيئتها
          localStorage.setItem("studentDataInitialized", "true");

          console.log("تم تهيئة البيانات التجريبية للطالب");
        }
      }

      function checkFileSaver() {
        if (typeof saveAs === "undefined") {
          console.warn("FileSaver.js غير محمل، سيتم استخدام الطريقة البديلة");
          showToast(
            "info",
            currentLanguage === "ar"
              ? "يستخدم النظام طريقة بديلة لتحميل الملفات"
              : "Using fallback method for file downloads"
          );
        }
      }

      // ============================================
      // وظائف اللغة والتصميم
      // ============================================

      function toggleDarkMode() {
        darkMode = !darkMode;
        localStorage.setItem("darkMode", darkMode);

        if (darkMode) {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        updateDarkModeText();
      }

      function updateDarkModeText() {
        const darkModeText =
          currentLanguage === "ar"
            ? darkMode
              ? "الوضع الفاتح"
              : "الوضع الداكن"
            : darkMode
            ? "Light Mode"
            : "Dark Mode";

        document.getElementById("dark-mode-text").textContent = darkModeText;
        document.getElementById("dark-mode-btn-text").textContent =
          darkModeText;

        // تحديث الأيقونة
        const icons = document.querySelectorAll(
          "#header-dark-mode-toggle i, #sidebar-dark-mode-toggle i"
        );
        icons.forEach((icon) => {
          icon.className = darkMode ? "fas fa-sun" : "fas fa-moon";
        });
      }

      function updateLanguage() {
        const translations = {
          ar: {
            "header-title": "لوحة تحكم الطالب - نظام DT Edu",
            "menu-dashboard": "لوحة التحكم",
            "menu-schedule": "الجدول الدراسي",
            "menu-courses": "المقررات الدراسية",
            "menu-progress": "التقدم الدراسي",
            "menu-messages": "الرسائل",
            "menu-settings": "الإعدادات",
            "student-progress-stat": "التقدم الدراسي",
            "student-homework-stat": "الواجبات المكتملة",
            "student-attendance-stat": "نسبة الحضور",
            "student-new-assignments": "واجبات جديدة",
            "student-homework-card": "الواجبات المطلوبة",
            "student-homework-desc": "عرض الواجبات المطلوبة وتواريخ التسليم.",
            "view-homework-btn": "عرض",
            "student-submit-card": "تسليم الواجبات",
            "student-submit-desc": "رفع وتسليم الواجبات للأساتذة.",
            "submit-work-btn": "تسليم واجب",
            "student-receive-card": "استلام التقييمات",
            "student-receive-desc":
              "تحميل وتنزيل الواجبات والملفات من الأساتذة.",
            "receive-files-btn": "الملفات المرفوعة",
            "student-courses-card": "المواد الدراسية",
            "student-courses-desc":
              "الوصول إلى المواد الدراسية والموارد التعليمية.",
            "open-courses-btn": "فتح",
            "student-progress-card": "التقدم الدراسي",
            "student-progress-desc": "متابعة التقدم الدراسي في جميع المواد.",
            "view-progress-btn": "عرض",
            "student-messaging-card": "التواصل",
            "student-messaging-desc": "التواصل مع المعلمين والزملاء.",
            "message-btn": "مراسلة",
            "classroom-title": "الفصل الدراسي التفاعلي",
            "classroom-desc":
              "انضم إلى الفصل الدراسي التفاعلي للاستفادة من الدروس الحية والتفاعل المباشر مع المعلمين والزملاء.",
            "enter-classroom-btn": "الدخول إلى الفصل الدراسي",
            "logout-text": "تسجيل الخروج",
            "header-logout-text": "تسجيل الخروج",
            "dark-mode-text": "الوضع الداكن",
            "dark-mode-btn-text": "الوضع الداكن",
            "homework-title": "الواجبات المطلوبة",
            "submit-title": "تسليم واجب",
            "received-title": "الملفات المرفوعة من المعلمين",
            "courses-title": "المواد الدراسية",
            "progress-title": "التقدم الدراسي",
            "messaging-title": "التواصل",
            "preview-title": "معاينة الملف",
            "submit-file-text": "انقر لرفع ملف الواجب (PDF, DOCX, صور, ZIP)",
            "file-size-limit": "الحجم الأقصى: 10MB",
            "assignment-subject-label": "المادة:",
            "assignment-duedate-label": "موعد التسليم:",
            "assignment-description-label": "الوصف:",
            "submit-assignment-btn": "تسليم الواجب",
            "cancel-submit-btn": "إلغاء",
            "no-pending-homework": "لا توجد واجبات قيد الانتظار",
            "all-done": "لقد أنجزت جميع واجباتك!",
            "no-submitted-homework": "لا توجد واجبات مسلمة",
            "submit-first": "قم بتسليم واجبك الأول!",
            "no-graded-homework": "لا توجد واجبات مصححة",
            "wait-for-grading": "انتظر تقييم واجباتك من المعلم",
            "no-assignments-available": "لا توجد واجبات مرفوعة",
            "wait-for-assignments": "انتظر رفع المعلمين للواجبات",
            "no-resources-available": "لا توجد موارد تعليمية",
            "wait-for-resources": "سيقوم المعلمون برفع الموارد قريباً",
            "no-grades-available": "لا توجد تقييمات",
            "wait-for-grades": "انتظر تقييم واجباتك من المعلمين",
            "progress-period-label": "الفترة الزمنية:",
            "message-recipient-label": "المستلم",
            "message-subject-label": "عنوان الرسالة",
            "message-content-label": "نص الرسالة",
            "send-message-btn": "إرسال الرسالة",
          },
          en: {
            "header-title": "Student Dashboard - DT Edu System",
            "menu-dashboard": "Dashboard",
            "menu-schedule": "Schedule",
            "menu-courses": "Courses",
            "menu-progress": "Progress",
            "menu-messages": "Messages",
            "menu-settings": "Settings",
            "student-progress-stat": "Academic Progress",
            "student-homework-stat": "Completed Assignments",
            "student-attendance-stat": "Attendance Rate",
            "student-new-assignments": "New Assignments",
            "student-homework-card": "Required Assignments",
            "student-homework-desc":
              "View required assignments and submission deadlines.",
            "view-homework-btn": "View",
            "student-submit-card": "Submit Assignments",
            "student-submit-desc": "Upload and submit assignments to teachers.",
            "submit-work-btn": "Submit Assignment",
            "student-receive-card": "Receive Evaluations",
            "student-receive-desc":
              "Download assignments and files from teachers.",
            "receive-files-btn": "Uploaded Files",
            "student-courses-card": "Courses",
            "student-courses-desc":
              "Access to courses and educational resources.",
            "open-courses-btn": "Open",
            "student-progress-card": "Academic Progress",
            "student-progress-desc": "Track academic progress in all subjects.",
            "view-progress-btn": "View",
            "student-messaging-card": "Communication",
            "student-messaging-desc":
              "Communicate with teachers and classmates.",
            "message-btn": "Message",
            "classroom-title": "Interactive Classroom",
            "classroom-desc":
              "Join the interactive classroom to benefit from live lessons and direct interaction with teachers and classmates.",
            "enter-classroom-btn": "Enter Classroom",
            "logout-text": "Logout",
            "header-logout-text": "Logout",
            "dark-mode-text": "Dark Mode",
            "dark-mode-btn-text": "Dark Mode",
            "homework-title": "Required Assignments",
            "submit-title": "Submit Assignment",
            "received-title": "Files Uploaded by Teachers",
            "courses-title": "Courses",
            "progress-title": "Academic Progress",
            "messaging-title": "Communication",
            "preview-title": "File Preview",
            "submit-file-text":
              "Click to upload assignment file (PDF, DOCX, images, ZIP)",
            "file-size-limit": "Maximum size: 10MB",
            "assignment-subject-label": "Subject:",
            "assignment-duedate-label": "Due Date:",
            "assignment-description-label": "Description:",
            "submit-assignment-btn": "Submit Assignment",
            "cancel-submit-btn": "Cancel",
            "no-pending-homework": "No pending assignments",
            "all-done": "You have completed all your assignments!",
            "no-submitted-homework": "No submitted assignments",
            "submit-first": "Submit your first assignment!",
            "no-graded-homework": "No graded assignments",
            "wait-for-grading": "Wait for your assignments to be graded",
            "no-assignments-available": "No assignments uploaded",
            "wait-for-assignments": "Wait for teachers to upload assignments",
            "no-resources-available": "No educational resources",
            "wait-for-resources": "Teachers will upload resources soon",
            "no-grades-available": "No evaluations",
            "wait-for-grades": "Wait for your assignments to be evaluated",
            "progress-period-label": "Time Period:",
            "message-recipient-label": "Recipient",
            "message-subject-label": "Message Subject",
            "message-content-label": "Message Content",
            "send-message-btn": "Send Message",
          },
        };

        // تطبيق الترجمات
        Object.keys(translations[currentLanguage]).forEach((key) => {
          const element = document.getElementById(key);
          if (element) {
            element.textContent = translations[currentLanguage][key];
          }
        });
      }

      function getSubjectName(subjectCode) {
        const subject = subjects[subjectCode];
        return subject
          ? subject[currentLanguage === "ar" ? "ar" : "en"]
          : subjectCode;
      }

      function getClassName(classCode) {
        const cls = classes[classCode];
        return cls ? cls[currentLanguage === "ar" ? "ar" : "en"] : classCode;
      }

      function formatDate(dateString, includeTime = false) {
        const date = new Date(dateString);
        if (currentLanguage === "ar") {
          const options = includeTime
            ? {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              }
            : { year: "numeric", month: "long", day: "numeric" };
          return date.toLocaleDateString("ar-SA", options);
        } else {
          const options = includeTime
            ? {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              }
            : { year: "numeric", month: "long", day: "numeric" };
          return date.toLocaleDateString("en-US", options);
        }
      }

      function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return "0 Bytes";

        const k = 1024;
        const sizes =
          currentLanguage === "ar"
            ? ["بايت", "كيلوبايت", "ميجابايت", "جيجابايت"]
            : ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // ============================================
      // وظائف الإشعارات والرسائل
      // ============================================

      function showToast(type, message, duration = 3000) {
        if (!message) return;

        // إزالة أي رسائل سابقة
        const existingToasts = document.querySelectorAll(".toast-message");
        existingToasts.forEach((toast) => {
          toast.remove();
        });

        // إنشاء عنصر الرسالة
        const toast = document.createElement("div");
        toast.className = `toast-message toast-${type}`;

        const icon =
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : type === "warning"
            ? "fa-exclamation-triangle"
            : "fa-info-circle";

        toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;

        document.getElementById("toast-container").appendChild(toast);

        // إزالة الرسالة بعد المدة المحددة
        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }, duration);
      }

      // ============================================
      // وظائف النوافذ المنبثقة
      // ============================================

      function openHomeworkModal() {
        document.getElementById("homework-modal").style.display = "flex";
        switchTab("homework-tab", "pending");
        loadHomeworkList();
      }

      function openSubmitModal() {
        document.getElementById("submit-modal").style.display = "flex";
        loadAssignmentsForSubmission();
      }

      function openReceivedModal() {
        document.getElementById("received-modal").style.display = "flex";
        switchTab("received-tab", "assignments");
        loadReceivedFiles();
      }

      function openCoursesModal() {
        document.getElementById("courses-modal").style.display = "flex";
      }

      function openProgressModal() {
        document.getElementById("progress-modal").style.display = "flex";
        loadProgressChart();
      }

      function openMessagingModal() {
        document.getElementById("messaging-modal").style.display = "flex";
      }

      function openClassroom() {
        showToast(
          "info",
          currentLanguage === "ar"
            ? "جاري فتح الفصل الدراسي..."
            : "Opening classroom..."
        );
        // في التطبيق الحقيقي: window.location.href = 'classroom.html';
      }

      function openPreviewModal(fileName, fileContent, fileType) {
        document.getElementById("preview-modal").style.display = "flex";
        const previewContent = document.getElementById("preview-content");
        previewContent.innerHTML = "";

        if (fileContent.startsWith("data:image/")) {
          // عرض الصور
          previewContent.innerHTML = `
                    <img src="${fileContent}" alt="${fileName}" class="image-preview">
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="submit-btn" onclick="downloadFile('${fileContent}', '${fileName}')">
                            <i class="fas fa-download"></i>
                            ${
                              currentLanguage === "ar"
                                ? "تحميل الصورة"
                                : "Download Image"
                            }
                        </button>
                    </div>
                `;
        } else if (fileContent.startsWith("data:application/pdf")) {
          // عرض ملفات PDF
          previewContent.innerHTML = `
                    <embed src="${fileContent}" type="application/pdf" width="100%" height="500px">
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="submit-btn" onclick="downloadFile('${fileContent}', '${fileName}')">
                            <i class="fas fa-download"></i>
                            ${
                              currentLanguage === "ar"
                                ? "تحميل الملف"
                                : "Download File"
                            }
                        </button>
                    </div>
                `;
        } else if (fileContent.startsWith("data:text/")) {
          // عرض الملفات النصية
          const textContent = decodeBase64Text(fileContent);
          previewContent.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto; font-family: monospace;">
                        <pre style="white-space: pre-wrap; word-wrap: break-word;">${textContent}</pre>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="submit-btn" onclick="downloadFile('${fileContent}', '${fileName}')">
                            <i class="fas fa-download"></i>
                            ${
                              currentLanguage === "ar"
                                ? "تحميل الملف"
                                : "Download File"
                            }
                        </button>
                    </div>
                `;
        } else {
          // للملفات الأخرى، عرض معلومات الملف
          previewContent.innerHTML = `
                    <div class="file-info" style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-file" style="font-size: 80px; color: #4a6cf7; margin-bottom: 20px;"></i>
                        <h3>${fileName}</h3>
                        <p>${
                          currentLanguage === "ar"
                            ? "هذا النوع من الملفات لا يدعم المعاينة المباشرة"
                            : "This file type does not support direct preview"
                        }</p>
                        <div style="margin-top: 30px;">
                            <button class="submit-btn" onclick="downloadFile('${fileContent}', '${fileName}')">
                                <i class="fas fa-download"></i>
                                ${
                                  currentLanguage === "ar"
                                    ? "تحميل الملف"
                                    : "Download File"
                                }
                            </button>
                        </div>
                    </div>
                `;
        }
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // إغلاق النوافذ المنبثقة عند النقر خارجها
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", function (e) {
          if (e.target === this) {
            this.style.display = "none";
          }
        });
      });

      function switchTab(tabGroup, tabName) {
        // إخفاء جميع المحتويات وإلغاء تنشيط جميع التبويبات في المجموعة
        const tabContents = document.querySelectorAll(
          `#${tabGroup.replace("-tab", "")}-modal .tab-content`
        );
        const tabs = document.querySelectorAll(
          `#${tabGroup.replace("-tab", "")}-modal .tab`
        );

        tabContents.forEach((content) => {
          content.classList.remove("active");
        });

        tabs.forEach((tab) => {
          tab.classList.remove("active");
        });

        // إظهار المحتوى المحدد وتنشيط التبويب
        const activeContent = document.getElementById(`${tabName}-tab`);
        const activeTab = document.querySelector(
          `#${tabGroup.replace("-tab", "")}-modal .tab[onclick*="${tabName}"]`
        );

        if (activeContent) activeContent.classList.add("active");
        if (activeTab) activeTab.classList.add("active");
      }

      // ============================================
      // وظائف الملفات والرفع
      // ============================================

      function handleFileSelection(
        event,
        fileNameElementId,
        previewElementId = null
      ) {
        const file = event.target.files[0];
        if (!file) return;

        // عرض اسم الملف
        const fileNameElement = document.getElementById(fileNameElementId);
        if (fileNameElement) {
          fileNameElement.textContent = `${file.name} (${formatFileSize(
            file.size
          )})`;
        }

        // التحقق من حجم الملف (10MB كحد أقصى)
        if (file.size > 10 * 1024 * 1024) {
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت"
              : "File is too large. Maximum size is 10MB"
          );
          event.target.value = "";
          if (fileNameElement) fileNameElement.textContent = "";
          return;
        }

        // معاينة الصور إذا كانت
        if (previewElementId && file.type.startsWith("image/")) {
          const previewElement = document.getElementById(previewElementId);
          if (previewElement) {
            const reader = new FileReader();
            reader.onload = function (e) {
              previewElement.innerHTML = `<img src="${e.target.result}" alt="معاينة" class="image-preview">`;
              previewElement.style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        }
      }

      function updateAssignmentDetails() {
        const assignmentId = document.getElementById("submit-assignment").value;
        const assignmentDetails = document.getElementById("assignment-details");

        if (!assignmentId) {
          assignmentDetails.style.display = "none";
          return;
        }

        // البحث عن الواجب
        const teacherAssignments = JSON.parse(
          localStorage.getItem("teacherAssignments") || "[]"
        );
        const assignment = teacherAssignments.find((a) => a.id == assignmentId);

        if (!assignment) {
          assignmentDetails.style.display = "none";
          return;
        }

        // عرض تفاصيل الواجب
        document.getElementById("selected-assignment-title").textContent =
          assignment.title;
        document.getElementById("selected-assignment-subject").textContent =
          assignment.subjectName;
        document.getElementById("selected-assignment-duedate").textContent =
          formatDate(assignment.dueDate, true);
        document.getElementById("selected-assignment-description").textContent =
          assignment.description;

        assignmentDetails.style.display = "block";
      }

      function loadAssignmentsForSubmission() {
        const selectElement = document.getElementById("submit-assignment");
        selectElement.innerHTML =
          '<option value="">اختر واجباً للتسليم</option>';

        // الحصول على الواجبات المرفوعة من المعلمين
        const teacherAssignments = JSON.parse(
          localStorage.getItem("teacherAssignments") || "[]"
        );

        // الحصول على تسجيلات الطالب الحالية
        const studentSubmissions = JSON.parse(
          localStorage.getItem("studentSubmissions") || "[]"
        );
        const submittedAssignmentIds = studentSubmissions
          .filter((sub) => sub.studentId === currentStudentId)
          .map((sub) => sub.assignmentId);

        // تصفية الواجبات الخاصة بفصل الطالب والتي لم يسلمها بعد
        const availableAssignments = teacherAssignments.filter((assignment) => {
          return (
            assignment.class === currentStudentClass &&
            !submittedAssignmentIds.includes(assignment.id) &&
            new Date(assignment.dueDate) > new Date()
          );
        });

        if (availableAssignments.length === 0) {
          selectElement.innerHTML += `<option value="" disabled>لا توجد واجبات متاحة للتسليم</option>`;
          return;
        }

        // إضافة الواجبات المتاحة
        availableAssignments.forEach((assignment) => {
          const dueDate = formatDate(assignment.dueDate, true);
          const option = document.createElement("option");
          option.value = assignment.id;
          option.textContent = `${assignment.title} (${assignment.subjectName}) - ${dueDate}`;
          selectElement.appendChild(option);
        });
      }

      function submitAssignment() {
        const assignmentId = document.getElementById("submit-assignment").value;
        const file = document.getElementById("submit-file").files[0];
        const notes = document.getElementById("submit-notes").value;

        if (!assignmentId) {
          showToast(
            "error",
            currentLanguage === "ar"
              ? "يرجى اختيار واجب للتسليم"
              : "Please select an assignment to submit"
          );
          return;
        }

        if (!file) {
          showToast(
            "error",
            currentLanguage === "ar"
              ? "يرجى رفع ملف الواجب"
              : "Please upload assignment file"
          );
          return;
        }

        // قراءة الملف كـ Base64
        const reader = new FileReader();
        reader.onload = function (e) {
          saveSubmission(assignmentId, e.target.result, file, notes);
        };

        reader.onerror = function (error) {
          console.error("Error reading file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في قراءة الملف"
              : "Error reading file"
          );
        };

        reader.readAsDataURL(file);
      }

      function saveSubmission(assignmentId, fileContent, file, notes) {
        try {
          // البحث عن الواجب
          const teacherAssignments = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignment = teacherAssignments.find(
            (a) => a.id == assignmentId
          );

          if (!assignment) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "الواجب غير موجود"
                : "Assignment not found"
            );
            return;
          }

          // الحصول على التسجيلات الحالية
          const studentSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );

          // إنشاء كائن التسليم
          const submission = {
            id: Date.now(),
            assignmentId: parseInt(assignmentId),
            assignmentTitle: assignment.title,
            studentId: currentStudentId,
            studentName: currentUser.name,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            fileContent: fileContent,
            notes: notes || "",
            submissionDate: new Date().toISOString(),
            status: "submitted",
            grade: null,
            feedback: null,
            gradeDate: null,
            gradedBy: null,
          };

          // إضافة التسليم الجديد
          studentSubmissions.push(submission);

          // حفظ في localStorage
          localStorage.setItem(
            "studentSubmissions",
            JSON.stringify(studentSubmissions)
          );

          // تحديث إحصائيات الطالب
          loadStudentStats();
          loadPendingAssignments();

          showToast(
            "success",
            currentLanguage === "ar"
              ? `تم تسليم الواجب "${assignment.title}" بنجاح!`
              : `Assignment "${assignment.title}" submitted successfully!`
          );

          closeModal("submit-modal");

          // إعادة تعيين النموذج
          document.getElementById("submit-file").value = "";
          document.getElementById("submit-notes").value = "";
          document.getElementById("file-name").textContent = "";
          document.getElementById("assignment-details").style.display = "none";
          const previewElement = document.getElementById("file-preview");
          if (previewElement) {
            previewElement.innerHTML = "";
            previewElement.style.display = "none";
          }

          // إنشاء إشعار للمعلم
          const teacherNotifications = JSON.parse(
            localStorage.getItem(
              `notifications_teacher_${assignment.teacherId}`
            ) || "[]"
          );
          teacherNotifications.push({
            id: Date.now(),
            type: "assignment_submitted",
            title:
              currentLanguage === "ar"
                ? "واجب مسلم جديد"
                : "New Assignment Submitted",
            message:
              currentLanguage === "ar"
                ? `قام ${currentUser.name} بتسليم واجب "${assignment.title}"`
                : `${currentUser.name} has submitted assignment "${assignment.title}"`,
            data: submission,
            read: false,
            date: new Date().toISOString(),
          });

          localStorage.setItem(
            `notifications_teacher_${assignment.teacherId}`,
            JSON.stringify(teacherNotifications)
          );
        } catch (error) {
          console.error("Error saving submission:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في تسليم الواجب"
              : "Error submitting assignment"
          );
        }
      }

      // ============================================
      // وظائف تحميل وعرض البيانات
      // ============================================

      function loadStudentStats() {
        try {
          // الحصول على جميع التسجيلات
          const studentSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const studentSubmissionsList = studentSubmissions.filter(
            (sub) => sub.studentId === currentStudentId
          );

          // الحصول على الواجبات المرفوعة من المعلمين
          const teacherAssignments = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const classAssignments = teacherAssignments.filter(
            (a) => a.class === currentStudentClass
          );

          // حساب الإحصائيات
          const totalAssignments = classAssignments.length;
          const submittedCount = studentSubmissionsList.length;
          const gradedCount = studentSubmissionsList.filter(
            (sub) => sub.grade !== null
          ).length;

          // حساب الواجبات الجديدة (التي لم تسلم بعد)
          const submittedAssignmentIds = studentSubmissionsList.map(
            (sub) => sub.assignmentId
          );
          const newAssignments = classAssignments.filter(
            (assignment) =>
              !submittedAssignmentIds.includes(assignment.id) &&
              new Date(assignment.dueDate) > new Date()
          );

          // تحديث الإحصائيات في الصفحة
          document.getElementById(
            "homework-count"
          ).textContent = `${submittedCount}/${totalAssignments}`;
          document.getElementById("new-assignments-count").textContent =
            newAssignments.length;

          // تحديث الشارات
          const newHomeworkBadge =
            document.getElementById("new-homework-badge");
          if (newAssignments.length > 0) {
            newHomeworkBadge.textContent = `${newAssignments.length} واجبات جديدة`;
            newHomeworkBadge.style.display = "inline-block";
          } else {
            newHomeworkBadge.style.display = "none";
          }

          const pendingUploadBadge = document.getElementById(
            "pending-upload-badge"
          );
          if (newAssignments.length > 0) {
            pendingUploadBadge.style.display = "inline-block";
          } else {
            pendingUploadBadge.style.display = "none";
          }

          // تحديث شارة المواد الدراسية
          const coursesBadge = document.getElementById("courses-badge");
          if (newAssignments.length > 0) {
            coursesBadge.textContent = newAssignments.length;
            coursesBadge.style.display = "flex";
          } else {
            coursesBadge.style.display = "none";
          }
        } catch (error) {
          console.error("Error loading student stats:", error);
        }
      }

      function loadPendingAssignments() {
        loadStudentStats();
      }

      function loadHomeworkList() {
        const activeTab = document.querySelector("#homework-modal .tab.active");
        const tabName = activeTab
          ? activeTab.getAttribute("onclick").split("'")[1]
          : "pending";
        const filterValue = document.getElementById("homework-filter").value;
        const sortValue = document.getElementById("homework-sort").value;

        // الحصول على البيانات
        const teacherAssignments = JSON.parse(
          localStorage.getItem("teacherAssignments") || "[]"
        );
        const studentSubmissions = JSON.parse(
          localStorage.getItem("studentSubmissions") || "[]"
        );

        // تصفية الواجبات الخاصة بفصل الطالب
        let assignments = teacherAssignments.filter(
          (a) => a.class === currentStudentClass
        );

        // تطبيق فلتر المادة
        if (filterValue !== "all") {
          assignments = assignments.filter((a) => a.subject === filterValue);
        }

        // ترتيب الواجبات
        assignments.sort((a, b) => {
          if (sortValue === "dueDate") {
            return new Date(a.dueDate) - new Date(b.dueDate);
          } else if (sortValue === "newest") {
            return new Date(b.uploadDate) - new Date(a.uploadDate);
          } else if (sortValue === "subject") {
            return a.subjectName.localeCompare(b.subjectName);
          }
          return 0;
        });

        // عرض حسب التبويب
        if (tabName === "pending") {
          loadPendingHomeworkList(assignments, studentSubmissions);
        } else if (tabName === "submitted") {
          loadSubmittedHomeworkList(assignments, studentSubmissions);
        } else if (tabName === "graded") {
          loadGradedHomeworkList(assignments, studentSubmissions);
        }
      }

      function loadPendingHomeworkList(assignments, studentSubmissions) {
        const homeworkList = document.getElementById("homework-list-pending");
        const emptyState = document.getElementById("homework-empty-pending");

        if (!homeworkList) return;

        homeworkList.innerHTML = "";

        // الحصول على الواجبات التي سلمها الطالب
        const submittedAssignmentIds = studentSubmissions
          .filter((sub) => sub.studentId === currentStudentId)
          .map((sub) => sub.assignmentId);

        // تصفية الواجبات التي لم تسلم بعد
        const pendingAssignments = assignments.filter(
          (assignment) => !submittedAssignmentIds.includes(assignment.id)
        );

        if (pendingAssignments.length === 0) {
          homeworkList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          homeworkList.style.display = "block";
          emptyState.style.display = "none";
        }

        pendingAssignments.forEach((assignment) => {
          const item = document.createElement("li");
          item.className = "content-item";

          // التحقق من التأخير
          const dueDate = new Date(assignment.dueDate);
          const isLate = dueDate < new Date();
          const timeLeft = dueDate - new Date();
          const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));

          let timeLeftText = "";
          if (isLate) {
            timeLeftText = currentLanguage === "ar" ? "متأخر" : "Late";
          } else if (daysLeft === 0) {
            timeLeftText =
              currentLanguage === "ar" ? "ينتهي اليوم" : "Due today";
          } else if (daysLeft === 1) {
            timeLeftText =
              currentLanguage === "ar" ? "ينتهي غداً" : "Due tomorrow";
          } else {
            timeLeftText =
              currentLanguage === "ar"
                ? `${daysLeft} أيام متبقية`
                : `${daysLeft} days left`;
          }

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${assignment.title}</div>
                        <div class="content-meta">
                            <span><strong>${
                              currentLanguage === "ar" ? "المادة:" : "Subject:"
                            }</strong> ${assignment.subjectName}</span>
                            <span><strong>${
                              currentLanguage === "ar" ? "المعلم:" : "Teacher:"
                            }</strong> ${assignment.teacherName}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "موعد التسليم:"
                                : "Due Date:"
                            }</strong> ${formatDate(
            assignment.dueDate,
            true
          )}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "الوقت المتبقي:"
                                : "Time Left:"
                            }</strong> <span class="${
            isLate ? "badge badge-late" : "badge badge-new"
          }">${timeLeftText}</span></span>
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="download-btn" onclick="downloadAssignmentFile(${
                          assignment.id
                        })">
                            <i class="fas fa-download"></i>
                            ${currentLanguage === "ar" ? "تحميل" : "Download"}
                        </button>
                        <button class="upload-btn" onclick="openSubmitAssignment(${
                          assignment.id
                        })">
                            <i class="fas fa-upload"></i>
                            ${currentLanguage === "ar" ? "تسليم" : "Submit"}
                        </button>
                    </div>
                `;
          homeworkList.appendChild(item);
        });
      }

      function loadSubmittedHomeworkList(assignments, studentSubmissions) {
        const homeworkList = document.getElementById("homework-list-submitted");
        const emptyState = document.getElementById("homework-empty-submitted");

        if (!homeworkList) return;

        homeworkList.innerHTML = "";

        // الحصول على الواجبات التي سلمها الطالب
        const submittedSubmissions = studentSubmissions.filter(
          (sub) => sub.studentId === currentStudentId && sub.grade === null
        );

        if (submittedSubmissions.length === 0) {
          homeworkList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          homeworkList.style.display = "block";
          emptyState.style.display = "none";
        }

        submittedSubmissions.forEach((submission) => {
          const assignment = assignments.find(
            (a) => a.id === submission.assignmentId
          );
          if (!assignment) return;

          const item = document.createElement("li");
          item.className = "content-item";

          const submissionDate = formatDate(submission.submissionDate, true);

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${assignment.title}</div>
                        <div class="content-meta">
                            <span><strong>${
                              currentLanguage === "ar" ? "المادة:" : "Subject:"
                            }</strong> ${assignment.subjectName}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "تاريخ التسليم:"
                                : "Submission Date:"
                            }</strong> ${submissionDate}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "حالة التقييم:"
                                : "Grading Status:"
                            }</strong> <span class="badge badge-submitted">${
            currentLanguage === "ar" ? "قيد التقييم" : "Under Review"
          }</span></span>
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="download-btn" onclick="downloadSubmissionFile(${
                          submission.id
                        })">
                            <i class="fas fa-download"></i>
                            ${currentLanguage === "ar" ? "تحميل" : "Download"}
                        </button>
                        <button class="content-btn" onclick="viewSubmission(${
                          submission.id
                        })">
                            <i class="fas fa-eye"></i>
                            ${currentLanguage === "ar" ? "عرض" : "View"}
                        </button>
                    </div>
                `;
          homeworkList.appendChild(item);
        });
      }

      function loadGradedHomeworkList(assignments, studentSubmissions) {
        const homeworkList = document.getElementById("homework-list-graded");
        const emptyState = document.getElementById("homework-empty-graded");

        if (!homeworkList) return;

        homeworkList.innerHTML = "";

        // الحصول على الواجبات التي سلمها الطالب وتم تقييمها
        const gradedSubmissions = studentSubmissions.filter(
          (sub) => sub.studentId === currentStudentId && sub.grade !== null
        );

        if (gradedSubmissions.length === 0) {
          homeworkList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          homeworkList.style.display = "block";
          emptyState.style.display = "none";
        }

        gradedSubmissions.forEach((submission) => {
          const assignment = assignments.find(
            (a) => a.id === submission.assignmentId
          );
          if (!assignment) return;

          const item = document.createElement("li");
          item.className = "content-item";

          const submissionDate = formatDate(submission.submissionDate, true);
          const gradeDate = formatDate(submission.gradeDate, true);
          const gradePercentage = Math.round(
            (submission.grade / assignment.maxGrade) * 100
          );

          let gradeClass = "badge-graded";
          if (gradePercentage >= 90) {
            gradeClass = "badge-new"; // ممتاز
          } else if (gradePercentage >= 70) {
            gradeClass = "badge-submitted"; // جيد
          } else if (gradePercentage >= 50) {
            gradeClass = "badge-pending"; // مقبول
          } else {
            gradeClass = "badge-late"; // ضعيف
          }

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${assignment.title}</div>
                        <div class="content-meta">
                            <span><strong>${
                              currentLanguage === "ar" ? "المادة:" : "Subject:"
                            }</strong> ${assignment.subjectName}</span>
                            <span><strong>${
                              currentLanguage === "ar" ? "الدرجة:" : "Grade:"
                            }</strong> <span class="badge ${gradeClass}">${
            submission.grade
          }/${assignment.maxGrade} (${gradePercentage}%)</span></span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "تاريخ التقييم:"
                                : "Grading Date:"
                            }</strong> ${gradeDate}</span>
                            ${
                              submission.feedback
                                ? `<span><strong>${
                                    currentLanguage === "ar"
                                      ? "ملاحظات المعلم:"
                                      : "Teacher Feedback:"
                                  }</strong> ${submission.feedback}</span>`
                                : ""
                            }
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="download-btn" onclick="downloadSubmissionFile(${
                          submission.id
                        })">
                            <i class="fas fa-download"></i>
                            ${currentLanguage === "ar" ? "تحميل" : "Download"}
                        </button>
                        <button class="content-btn" onclick="viewGradedSubmission(${
                          submission.id
                        })">
                            <i class="fas fa-eye"></i>
                            ${currentLanguage === "ar" ? "عرض" : "View"}
                        </button>
                    </div>
                `;
          homeworkList.appendChild(item);
        });
      }

      function openSubmitAssignment(assignmentId) {
        closeModal("homework-modal");
        openSubmitModal();

        // اختيار الواجب المحدد
        setTimeout(() => {
          document.getElementById("submit-assignment").value = assignmentId;
          updateAssignmentDetails();
        }, 300);
      }

      function viewSubmission(submissionId) {
        try {
          const studentSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submission = studentSubmissions.find(
            (sub) => sub.id == submissionId
          );

          if (!submission) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "التسليم غير موجود"
                : "Submission not found"
            );
            return;
          }

          openPreviewModal(
            submission.fileName,
            submission.fileContent,
            submission.fileType
          );
        } catch (error) {
          console.error("Error viewing submission:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في عرض التسليم"
              : "Error viewing submission"
          );
        }
      }

      function viewGradedSubmission(submissionId) {
        try {
          const studentSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submission = studentSubmissions.find(
            (sub) => sub.id == submissionId
          );

          const teacherAssignments = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignment = teacherAssignments.find(
            (a) => a.id === submission.assignmentId
          );

          if (!submission || !assignment) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "التسليم غير موجود"
                : "Submission not found"
            );
            return;
          }

          // إنشاء نافذة عرض مفصلة
          const detailModal = document.createElement("div");
          detailModal.className = "modal";
          detailModal.style.display = "flex";

          const submissionDate = formatDate(submission.submissionDate, true);
          const gradeDate = formatDate(submission.gradeDate, true);
          const gradePercentage = Math.round(
            (submission.grade / assignment.maxGrade) * 100
          );

          detailModal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
                        <h2 class="modal-title">${
                          currentLanguage === "ar"
                            ? "تفاصيل التقييم"
                            : "Evaluation Details"
                        }</h2>
                        
                        <div style="margin-top: 20px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                <h3 style="color: var(--primary); margin-bottom: 15px;">${
                                  assignment.title
                                }</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                                    <div>
                                        <strong>${
                                          currentLanguage === "ar"
                                            ? "المادة:"
                                            : "Subject:"
                                        }</strong>
                                        <p>${assignment.subjectName}</p>
                                    </div>
                                    <div>
                                        <strong>${
                                          currentLanguage === "ar"
                                            ? "تاريخ التسليم:"
                                            : "Submission Date:"
                                        }</strong>
                                        <p>${submissionDate}</p>
                                    </div>
                                    <div>
                                        <strong>${
                                          currentLanguage === "ar"
                                            ? "تاريخ التقييم:"
                                            : "Grading Date:"
                                        }</strong>
                                        <p>${gradeDate}</p>
                                    </div>
                                    <div>
                                        <strong>${
                                          currentLanguage === "ar"
                                            ? "الدرجة:"
                                            : "Grade:"
                                        }</strong>
                                        <p style="font-size: 24px; font-weight: bold; color: ${
                                          gradePercentage >= 50
                                            ? "#00b894"
                                            : "#e74c3c"
                                        };">${submission.grade}/${
            assignment.maxGrade
          } (${gradePercentage}%)</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${
                              submission.feedback
                                ? `
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                    <h3 style="color: var(--primary); margin-bottom: 15px;">${
                                      currentLanguage === "ar"
                                        ? "ملاحظات المعلم"
                                        : "Teacher Feedback"
                                    }</h3>
                                    <p style="background: white; padding: 15px; border-radius: 8px; line-height: 1.6;">${
                                      submission.feedback
                                    }</p>
                                </div>
                            `
                                : ""
                            }
                            
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="submit-btn" onclick="downloadSubmissionFile(${submissionId})" style="margin-right: 10px;">
                                    <i class="fas fa-download"></i>
                                    ${
                                      currentLanguage === "ar"
                                        ? "تحميل ملف التسليم"
                                        : "Download Submission File"
                                    }
                                </button>
                                <button class="submit-btn secondary" onclick="this.parentElement.parentElement.parentElement.parentElement.style.display='none'">
                                    ${
                                      currentLanguage === "ar"
                                        ? "إغلاق"
                                        : "Close"
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                `;

          document.body.appendChild(detailModal);

          // إغلاق النافذة عند النقر خارجها
          detailModal.addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
        } catch (error) {
          console.error("Error viewing graded submission:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في عرض التقييم"
              : "Error viewing evaluation"
          );
        }
      }

      function loadReceivedFiles() {
        const activeTab = document.querySelector("#received-modal .tab.active");
        const tabName = activeTab
          ? activeTab.getAttribute("onclick").split("'")[1]
          : "assignments";
        const filterValue = document.getElementById("received-filter").value;
        const sortValue = document.getElementById("received-sort").value;

        if (tabName === "assignments") {
          loadReceivedAssignments(filterValue, sortValue);
        } else if (tabName === "resources") {
          loadReceivedResources(filterValue, sortValue);
        } else if (tabName === "grades") {
          loadReceivedGrades(filterValue, sortValue);
        }
      }

      function loadReceivedAssignments(filterValue, sortValue) {
        const assignmentsList = document.getElementById("assignments-list");
        const emptyState = document.getElementById("assignments-empty");

        if (!assignmentsList) return;

        assignmentsList.innerHTML = "";

        // الحصول على الواجبات المرفوعة من المعلمين
        const teacherAssignments = JSON.parse(
          localStorage.getItem("teacherAssignments") || "[]"
        );

        // تصفية الواجبات الخاصة بفصل الطالب
        let assignments = teacherAssignments.filter(
          (a) => a.class === currentStudentClass
        );

        // تطبيق فلتر المادة
        if (filterValue !== "all") {
          assignments = assignments.filter((a) => a.subject === filterValue);
        }

        // ترتيب الواجبات
        assignments.sort((a, b) => {
          if (sortValue === "newest") {
            return new Date(b.uploadDate) - new Date(a.uploadDate);
          } else if (sortValue === "oldest") {
            return new Date(a.uploadDate) - new Date(b.uploadDate);
          } else if (sortValue === "name") {
            return a.title.localeCompare(b.title);
          }
          return 0;
        });

        if (assignments.length === 0) {
          assignmentsList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          assignmentsList.style.display = "block";
          emptyState.style.display = "none";
        }

        assignments.forEach((assignment) => {
          const item = document.createElement("li");
          item.className = "content-item";

          const uploadDate = formatDate(assignment.uploadDate, true);
          const dueDate = formatDate(assignment.dueDate, true);

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${assignment.title}</div>
                        <div class="content-meta">
                            <span><strong>${
                              currentLanguage === "ar" ? "المادة:" : "Subject:"
                            }</strong> ${assignment.subjectName}</span>
                            <span><strong>${
                              currentLanguage === "ar" ? "المعلم:" : "Teacher:"
                            }</strong> ${assignment.teacherName}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "تاريخ الرفع:"
                                : "Upload Date:"
                            }</strong> ${uploadDate}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "موعد التسليم:"
                                : "Due Date:"
                            }</strong> ${dueDate}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "حجم الملف:"
                                : "File Size:"
                            }</strong> ${formatFileSize(
            assignment.fileSize
          )}</span>
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="download-btn" onclick="downloadAssignmentFile(${
                          assignment.id
                        })">
                            <i class="fas fa-download"></i>
                            ${currentLanguage === "ar" ? "تحميل" : "Download"}
                        </button>
                        <button class="content-btn" onclick="previewAssignmentFile(${
                          assignment.id
                        })">
                            <i class="fas fa-eye"></i>
                            ${currentLanguage === "ar" ? "معاينة" : "Preview"}
                        </button>
                    </div>
                `;
          assignmentsList.appendChild(item);
        });
      }

      function loadReceivedResources(filterValue, sortValue) {
        const resourcesList = document.getElementById("resources-list");
        const emptyState = document.getElementById("resources-empty");

        if (!resourcesList) return;

        resourcesList.innerHTML = "";

        // الحصول على الموارد التعليمية
        const teacherResources = JSON.parse(
          localStorage.getItem("teacherResources") || "[]"
        );

        // تصفية الموارد حسب المادة
        let resources = teacherResources;
        if (filterValue !== "all") {
          resources = resources.filter((r) => r.subject === filterValue);
        }

        // ترتيب الموارد
        resources.sort((a, b) => {
          if (sortValue === "newest") {
            return new Date(b.uploadDate) - new Date(a.uploadDate);
          } else if (sortValue === "oldest") {
            return new Date(a.uploadDate) - new Date(b.uploadDate);
          } else if (sortValue === "name") {
            return a.title.localeCompare(b.title);
          }
          return 0;
        });

        if (resources.length === 0) {
          resourcesList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          resourcesList.style.display = "block";
          emptyState.style.display = "none";
        }

        resources.forEach((resource) => {
          const item = document.createElement("li");
          item.className = "content-item";

          const uploadDate = formatDate(resource.uploadDate, true);

          const typeText = {
            presentation:
              currentLanguage === "ar" ? "عرض تقديمي" : "Presentation",
            document: currentLanguage === "ar" ? "مستند" : "Document",
            video: currentLanguage === "ar" ? "فيديو" : "Video",
            worksheet: currentLanguage === "ar" ? "ورقة عمل" : "Worksheet",
            link: currentLanguage === "ar" ? "رابط" : "Link",
            other: currentLanguage === "ar" ? "أخرى" : "Other",
          };

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${resource.title}</div>
                        <div class="content-meta">
                            <span><strong>${
                              currentLanguage === "ar" ? "النوع:" : "Type:"
                            }</strong> ${
            typeText[resource.type] || resource.type
          }</span>
                            <span><strong>${
                              currentLanguage === "ar" ? "المعلم:" : "Teacher:"
                            }</strong> ${resource.teacherName}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "الوصف:"
                                : "Description:"
                            }</strong> ${resource.description}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "تاريخ الرفع:"
                                : "Upload Date:"
                            }</strong> ${uploadDate}</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "حجم الملف:"
                                : "File Size:"
                            }</strong> ${formatFileSize(
            resource.fileSize
          )}</span>
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="download-btn" onclick="downloadResourceFile(${
                          resource.id
                        })">
                            <i class="fas fa-download"></i>
                            ${currentLanguage === "ar" ? "تحميل" : "Download"}
                        </button>
                        <button class="content-btn" onclick="previewResourceFile(${
                          resource.id
                        })">
                            <i class="fas fa-eye"></i>
                            ${currentLanguage === "ar" ? "معاينة" : "Preview"}
                        </button>
                    </div>
                `;
          resourcesList.appendChild(item);
        });
      }

      function loadReceivedGrades(filterValue, sortValue) {
        // هذا التبويب يعرض التقييمات التي تم تحميلها بالفعل في قائمة الواجبات المصححة
        // يمكن تخصيصه لعرض المزيد من التفاصيل إذا لزم الأمر
        const gradesList = document.getElementById("grades-list");
        const emptyState = document.getElementById("grades-empty");

        if (!gradesList) return;

        gradesList.innerHTML = "";

        // الحصول على التقييمات (الواجبات المصححة)
        const studentSubmissions = JSON.parse(
          localStorage.getItem("studentSubmissions") || "[]"
        );
        const gradedSubmissions = studentSubmissions.filter(
          (sub) => sub.studentId === currentStudentId && sub.grade !== null
        );

        const teacherAssignments = JSON.parse(
          localStorage.getItem("teacherAssignments") || "[]"
        );

        // تطبيق فلتر المادة
        let filteredSubmissions = gradedSubmissions;
        if (filterValue !== "all") {
          filteredSubmissions = gradedSubmissions.filter((sub) => {
            const assignment = teacherAssignments.find(
              (a) => a.id === sub.assignmentId
            );
            return assignment && assignment.subject === filterValue;
          });
        }

        // ترتيب التقييمات
        filteredSubmissions.sort((a, b) => {
          if (sortValue === "newest") {
            return new Date(b.gradeDate) - new Date(a.gradeDate);
          } else if (sortValue === "oldest") {
            return new Date(a.gradeDate) - new Date(b.gradeDate);
          } else if (sortValue === "name") {
            return a.assignmentTitle.localeCompare(b.assignmentTitle);
          }
          return 0;
        });

        if (filteredSubmissions.length === 0) {
          gradesList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          gradesList.style.display = "block";
          emptyState.style.display = "none";
        }

        filteredSubmissions.forEach((submission) => {
          const assignment = teacherAssignments.find(
            (a) => a.id === submission.assignmentId
          );
          if (!assignment) return;

          const item = document.createElement("li");
          item.className = "content-item";

          const gradeDate = formatDate(submission.gradeDate, true);
          const gradePercentage = Math.round(
            (submission.grade / assignment.maxGrade) * 100
          );

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${assignment.title}</div>
                        <div class="content-meta">
                            <span><strong>${
                              currentLanguage === "ar" ? "المادة:" : "Subject:"
                            }</strong> ${assignment.subjectName}</span>
                            <span><strong>${
                              currentLanguage === "ar" ? "الدرجة:" : "Grade:"
                            }</strong> ${submission.grade}/${
            assignment.maxGrade
          } (${gradePercentage}%)</span>
                            <span><strong>${
                              currentLanguage === "ar"
                                ? "تاريخ التقييم:"
                                : "Grading Date:"
                            }</strong> ${gradeDate}</span>
                            ${
                              submission.feedback
                                ? `<span><strong>${
                                    currentLanguage === "ar"
                                      ? "ملاحظات:"
                                      : "Feedback:"
                                  }</strong> ${submission.feedback.substring(
                                    0,
                                    50
                                  )}${
                                    submission.feedback.length > 50 ? "..." : ""
                                  }</span>`
                                : ""
                            }
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="content-btn" onclick="viewGradedSubmission(${
                          submission.id
                        })">
                            <i class="fas fa-eye"></i>
                            ${currentLanguage === "ar" ? "عرض" : "View"}
                        </button>
                    </div>
                `;
          gradesList.appendChild(item);
        });
      }

      function previewAssignmentFile(assignmentId) {
        try {
          const teacherAssignments = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignment = teacherAssignments.find(
            (a) => a.id == assignmentId
          );

          if (!assignment || !assignment.fileContent) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف الواجب غير موجود"
                : "Assignment file not found"
            );
            return;
          }

          openPreviewModal(
            assignment.fileName,
            assignment.fileContent,
            assignment.fileType
          );
        } catch (error) {
          console.error("Error previewing assignment file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في معاينة الملف"
              : "Error previewing file"
          );
        }
      }

      function previewResourceFile(resourceId) {
        try {
          const teacherResources = JSON.parse(
            localStorage.getItem("teacherResources") || "[]"
          );
          const resource = teacherResources.find((r) => r.id == resourceId);

          if (!resource || !resource.fileContent) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف المورد غير موجود"
                : "Resource file not found"
            );
            return;
          }

          openPreviewModal(
            resource.fileName,
            resource.fileContent,
            resource.fileType
          );
        } catch (error) {
          console.error("Error previewing resource file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في معاينة الملف"
              : "Error previewing file"
          );
        }
      }

      // ============================================
      // وظائف التنزيل
      // ============================================

      function downloadAssignmentFile(assignmentId) {
        try {
          const teacherAssignments = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignment = teacherAssignments.find(
            (a) => a.id == assignmentId
          );

          if (!assignment || !assignment.fileContent) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف الواجب غير موجود"
                : "Assignment file not found"
            );
            return;
          }

          downloadBase64File(
            assignment.fileContent,
            assignment.fileName,
            assignment.fileType
          );
        } catch (error) {
          console.error("Error downloading assignment file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في تحميل الملف"
              : "Error downloading file"
          );
        }
      }

      function downloadSubmissionFile(submissionId) {
        try {
          const studentSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submission = studentSubmissions.find(
            (sub) => sub.id == submissionId
          );

          if (!submission || !submission.fileContent) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف التسليم غير موجود"
                : "Submission file not found"
            );
            return;
          }

          downloadBase64File(
            submission.fileContent,
            submission.fileName,
            submission.fileType
          );
        } catch (error) {
          console.error("Error downloading submission file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في تحميل الملف"
              : "Error downloading file"
          );
        }
      }

      function downloadResourceFile(resourceId) {
        try {
          const teacherResources = JSON.parse(
            localStorage.getItem("teacherResources") || "[]"
          );
          const resource = teacherResources.find((r) => r.id == resourceId);

          if (!resource || !resource.fileContent) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف المورد غير موجود"
                : "Resource file not found"
            );
            return;
          }

          // زيادة عدد التنزيلات
          const resources = JSON.parse(
            localStorage.getItem("teacherResources") || "[]"
          );
          const resourceIndex = resources.findIndex((r) => r.id == resourceId);

          if (resourceIndex !== -1) {
            resources[resourceIndex].downloads =
              (resources[resourceIndex].downloads || 0) + 1;
            localStorage.setItem("teacherResources", JSON.stringify(resources));
          }

          downloadBase64File(
            resource.fileContent,
            resource.fileName,
            resource.fileType
          );
        } catch (error) {
          console.error("Error downloading resource file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في تحميل الملف"
              : "Error downloading file"
          );
        }
      }

      function downloadFile(fileContent, fileName) {
        downloadBase64File(fileContent, fileName);
      }

      function downloadBase64File(base64Data, fileName, fileType = null) {
        try {
          // استخراج جزء Base64 فقط إذا كان يحتوي على بادئة data URL
          let data = base64Data;
          if (base64Data.includes("base64,")) {
            data = base64Data.split("base64,")[1];
          }

          // تحويل base64 إلى Blob
          const byteCharacters = atob(data);
          const byteNumbers = new Array(byteCharacters.length);

          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }

          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], {
            type: fileType || "application/octet-stream",
          });

          // استخدام FileSaver.js أو طريقة احتياطية
          if (typeof saveAs !== "undefined") {
            saveAs(blob, fileName);
          } else {
            // طريقة احتياطية
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            }, 100);
          }

          showToast(
            "success",
            currentLanguage === "ar"
              ? `جاري تحميل الملف: ${fileName}`
              : `Downloading file: ${fileName}`
          );
        } catch (error) {
          console.error("Error processing file for download:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "خطأ في معالجة الملف للتحميل"
              : "Error processing file for download"
          );

          // محاولة طريقة بديلة
          try {
            const link = document.createElement("a");
            link.href = base64Data;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (fallbackError) {
            console.error("Fallback download also failed:", fallbackError);
          }
        }
      }

      function decodeBase64Text(dataUrl) {
        try {
          // استخراج جزء base64 من data URL
          const base64Data = dataUrl.split(",")[1];
          // فك التشفير
          return decodeURIComponent(escape(atob(base64Data)));
        } catch (error) {
          console.error("Error decoding base64 text:", error);
          return currentLanguage === "ar"
            ? "تعذر قراءة محتوى الملف"
            : "Unable to read file content";
        }
      }

      // ============================================
      // وظائف إضافية
      // ============================================

      function viewCourse(courseCode) {
        const courseName = getSubjectName(courseCode);
        showToast(
          "info",
          currentLanguage === "ar"
            ? `جاري فتح مواد ${courseName}`
            : `Opening ${courseName} materials`
        );
      }

      function loadProgressChart() {
        const ctx = document.getElementById("progress-chart").getContext("2d");

        // تدمير الرسم البياني القديم إذا كان موجوداً
        if (window.progressChart) {
          window.progressChart.destroy();
        }

        // بيانات المثال
        const labels =
          currentLanguage === "ar"
            ? ["الرياضيات", "اللغة العربية", "العلوم", "الإنجليزية", "التاريخ"]
            : ["Math", "Arabic", "Science", "English", "History"];

        const data = {
          labels: labels,
          datasets: [
            {
              label:
                currentLanguage === "ar"
                  ? "التقدم الدراسي %"
                  : "Academic Progress %",
              data: [85, 92, 78, 88, 90],
              backgroundColor: "rgba(74, 108, 247, 0.5)",
              borderColor: "rgba(74, 108, 247, 1)",
              borderWidth: 1,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function (value) {
                  return value + "%";
                },
              },
            },
          },
        };

        window.progressChart = new Chart(ctx, {
          type: "bar",
          data: data,
          options: options,
        });
      }

      function sendMessage() {
        const recipient = document.getElementById("message-recipient").value;
        const subject = document.getElementById("message-subject").value;
        const content = document.getElementById("message-content").value;

        if (!recipient || !content) {
          showToast(
            "error",
            currentLanguage === "ar"
              ? "يرجى ملء جميع الحقول المطلوبة"
              : "Please fill all required fields"
          );
          return;
        }

        // حفظ الرسالة محلياً
        const messages = JSON.parse(
          localStorage.getItem("studentMessages") || "[]"
        );

        const message = {
          id: Date.now(),
          senderId: currentStudentId,
          senderName: currentUser.name,
          recipient: recipient,
          subject: subject || "",
          content: content,
          date: new Date().toISOString(),
          read: false,
        };

        messages.push(message);
        localStorage.setItem("studentMessages", JSON.stringify(messages));

        showToast(
          "success",
          currentLanguage === "ar"
            ? "تم إرسال الرسالة بنجاح!"
            : "Message sent successfully!"
        );
        closeModal("messaging-modal");

        // إعادة تعيين النموذج
        document.getElementById("message-subject").value = "";
        document.getElementById("message-content").value = "";
      }

      function logout() {
        // في التطبيق الحقيقي: إرسال طلب تسجيل الخروج إلى الخادم
        localStorage.removeItem("currentUser");
        showToast(
          "success",
          currentLanguage === "ar"
            ? "تم تسجيل الخروج بنجاح"
            : "Logged out successfully"
        );

        setTimeout(() => {
          window.location.href = "login.html";
        }, 1000);
      }

      // ============================================
      // تهيئة إضافية عند تحميل الصفحة
      // ============================================

      window.addEventListener("load", function () {
        // تحديث الإشعارات
        updateNotificationBadges();

        // تحديث الإحصائيات كل دقيقة
        setInterval(loadStudentStats, 60000);
      });

      function updateNotificationBadges() {
        // حساب عدد الواجبات الجديدة
        const teacherAssignments = JSON.parse(
          localStorage.getItem("teacherAssignments") || "[]"
        );
        const studentSubmissions = JSON.parse(
          localStorage.getItem("studentSubmissions") || "[]"
        );

        const classAssignments = teacherAssignments.filter(
          (a) => a.class === currentStudentClass
        );
        const submittedAssignmentIds = studentSubmissions
          .filter((sub) => sub.studentId === currentStudentId)
          .map((sub) => sub.assignmentId);

        const newAssignments = classAssignments.filter(
          (assignment) =>
            !submittedAssignmentIds.includes(assignment.id) &&
            new Date(assignment.dueDate) > new Date()
        );

        // حساب عدد الرسائل غير المقروءة
        const messages = JSON.parse(
          localStorage.getItem("studentMessages") || "[]"
        );
        const unreadMessages = messages.filter((msg) => !msg.read);

        // تحديث الشارات
        const messageBadge = document.getElementById("messages-badge");
        if (messageBadge && unreadMessages.length > 0) {
          messageBadge.textContent = unreadMessages.length;
          messageBadge.style.display = "flex";
        } else if (messageBadge) {
          messageBadge.style.display = "none";
        }
      }

      // ============================================
      // دعم لوحة المفاتيح والإمكانية
      // ============================================

      document.addEventListener("keydown", function (e) {
        // إغلاق النوافذ المنبثقة باستخدام زر Escape
        if (e.key === "Escape") {
          const modals = document.querySelectorAll(".modal");
          modals.forEach((modal) => {
            if (modal.style.display === "flex") {
              modal.style.display = "none";
            }
          });
        }
      });

      // تحسين إمكانية الوصول للازرار
      document.querySelectorAll("button").forEach((button) => {
        button.setAttribute("tabindex", "0");

        button.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            this.click();
          }
        });
      });
    </script>
  </body>
</html>
