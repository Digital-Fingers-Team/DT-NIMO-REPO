<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم المدير - DT Edu</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- إضافة مكتبة dexie.js -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <!-- إضافة مكتبة FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      :root {
        --primary: #4a6cf7;
        --primary-dark: #3a56d4;
        --secondary: #6c5ce7;
        --accent: #00b894;
        --light: #f8f9fa;
        --dark: #2d3436;
        --text: #333;
        --text-light: #666;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        --sidebar-width: 260px;
      }

      .dark-mode {
        --light: #1a1a2e;
        --dark: #f8f9fa;
        --text: #e6e6e6;
        --text-light: #b0b0b0;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Tajawal", "Segoe UI", sans-serif;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f8ff 0%, #e1f0fa 100%);
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
      }

      body.dark-mode {
        background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
      }

      body.rtl {
        direction: rtl;
      }

      body.ltr {
        direction: ltr;
      }

      /* التصميم الرئيسي */
      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      /* الشريط الجانبي */
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          180deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 20px 0;
        box-shadow: var(--shadow);
        z-index: 100;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: var(--transition);
      }

      /* عندما تكون اللغة عربية */
      body.rtl .sidebar {
        right: 0;
      }

      body.rtl .main-content {
        margin-right: var(--sidebar-width);
      }

      /* عندما تكون اللغة إنجليزية */
      body.ltr .sidebar {
        left: 0;
      }

      body.ltr .main-content {
        margin-left: var(--sidebar-width);
        margin-right: 0;
      }

      .sidebar-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
      }

      .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .logo {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .logo img {
        width: 140px;
        object-fit: contain;
        display: block;
      }

      .logo-text {
        font-size: 24px;
        font-weight: 800;
        background: linear-gradient(135deg, white, #e1f0fa);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .user-info {
        text-align: center;
        margin-top: 10px;
      }

      .user-name {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
      }

      .user-type {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-block;
      }

      .sidebar-menu {
        list-style: none;
        padding: 0 15px;
        margin-bottom: 20px;
      }

      .menu-item {
        margin-bottom: 8px;
        border-radius: 10px;
        overflow: hidden;
      }

      .menu-item a {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: white;
        text-decoration: none;
        transition: var(--transition);
      }

      .menu-item a:hover,
      .menu-item.active a {
        background: rgba(255, 255, 255, 0.15);
      }

      body.rtl .menu-item a:hover,
      body.rtl .menu-item.active a {
        transform: translateX(-5px);
      }

      body.ltr .menu-item a:hover,
      body.ltr .menu-item.active a {
        transform: translateX(5px);
      }

      .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      body.rtl .menu-item i {
        margin-left: 10px;
      }

      body.ltr .menu-item i {
        margin-right: 10px;
      }

      .menu-item span {
        flex: 1;
      }

      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: auto;
      }

      .sidebar-footer .menu-item a {
        padding: 10px 15px;
      }

      /* المحتوى الرئيسي */
      .main-content {
        flex: 1;
        padding: 20px;
        transition: var(--transition);
      }

      .header {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .header {
        background: var(--light);
        color: var(--dark);
      }

      .header h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 700;
      }

      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .dark-mode-toggle,
      .logout-btn {
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dark-mode-toggle {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
      }

      .dark-mode-toggle:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      .logout-btn {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .logout-btn:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      /* بطاقات الإحصائيات */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        display: flex;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .stat-card {
        background: var(--light);
        color: var(--dark);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      body.rtl .stat-icon {
        margin-left: 15px;
      }

      body.ltr .stat-icon {
        margin-right: 15px;
      }

      .stat-info {
        flex: 1;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 5px;
      }

      .stat-label {
        color: var(--text-light);
        font-size: 14px;
      }

      /* الشبكة الرئيسية */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .dashboard-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      body.dark-mode .dashboard-card {
        background: var(--light);
        color: var(--dark);
      }

      .dashboard-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
      }

      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        background: var(--primary);
      }

      body.rtl .card-icon {
        margin-left: 15px;
      }

      body.ltr .card-icon {
        margin-right: 15px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text);
      }

      .card-content {
        color: var(--text-light);
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .card-actions {
        display: flex;
        justify-content: flex-end;
      }

      .card-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      /* قسم التقارير */
      .reports-section {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
      }

      body.dark-mode .reports-section {
        background: var(--light);
        color: var(--dark);
      }

      .reports-title {
        color: var(--primary);
        font-size: 24px;
        margin-bottom: 15px;
      }

      .reports-description {
        color: var(--text-light);
        margin-bottom: 25px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .reports-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(74, 108, 247, 0.4);
      }

      .reports-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(74, 108, 247, 0.6);
      }

      /* النوافذ المنبثقة */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .modal-content {
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        position: relative;
        animation: modalFadeIn 0.3s ease-out;
      }

      body.dark-mode .modal-content {
        background-color: var(--light);
        color: var(--dark);
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .close-btn {
        position: absolute;
        top: 20px;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
        transition: var(--transition);
      }

      body.rtl .close-btn {
        left: 25px;
      }

      body.ltr .close-btn {
        right: 25px;
      }

      .close-btn:hover {
        color: var(--text);
      }

      .modal-title {
        color: var(--primary);
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        font-size: 24px;
      }

      body.dark-mode .modal-title {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* تصاميم خاصة بالمحتوى التفاعلي */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text);
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: var(--transition);
        background-color: #f8f9fa;
      }

      body.dark-mode .form-group input,
      body.dark-mode .form-group textarea,
      body.dark-mode .form-group select {
        background-color: var(--light);
        color: var(--dark);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: var(--primary);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
      }

      body.dark-mode .form-group input:focus,
      body.dark-mode .form-group textarea:focus,
      body.dark-mode .form-group select:focus {
        background-color: var(--light);
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-btn {
        display: block;
        padding: 12px 15px;
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
        border: 2px dashed var(--primary);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
      }

      .file-input-btn:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      .submit-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .submit-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .content-list {
        list-style: none;
        margin-top: 15px;
      }

      .content-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .content-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .content-item:hover {
        background: rgba(74, 108, 247, 0.05);
      }

      .content-item:last-child {
        border-bottom: none;
      }

      .content-name {
        font-weight: 600;
        color: var(--text);
      }

      .content-meta {
        display: flex;
        gap: 15px;
        color: var(--text-light);
        font-size: 14px;
      }

      .content-actions {
        display: flex;
        gap: 10px;
      }

      .content-btn {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
      }

      .content-btn:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-pending {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .status-approved {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .status-rejected {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .attendance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .attendance-table th,
      .attendance-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
      }

      body.rtl .attendance-table th,
      body.rtl .attendance-table td {
        text-align: right;
      }

      body.ltr .attendance-table th,
      body.ltr .attendance-table td {
        text-align: left;
      }

      body.dark-mode .attendance-table th,
      body.dark-mode .attendance-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .attendance-table th {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
        font-weight: 600;
      }

      .status-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
      }

      .status-present {
        background: rgba(0, 184, 148, 0.1);
        color: #00b894;
      }

      .status-absent {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .status-late {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .status-btn:hover {
        opacity: 0.8;
      }

      .chart-container {
        margin-top: 20px;
        height: 300px;
        position: relative;
      }

      .message-area {
        width: 100%;
        height: 150px;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: var(--transition);
        background-color: #f8f9fa;
        resize: vertical;
      }

      body.dark-mode .message-area {
        background-color: var(--light);
        color: var(--dark);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .message-area:focus {
        border-color: var(--primary);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
      }

      body.dark-mode .message-area:focus {
        background-color: var(--light);
      }

      /* نافذة عرض تفاصيل ملف التحضير */
      .prep-detail-container {
        margin-top: 20px;
      }

      .prep-detail-item {
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      body.dark-mode .prep-detail-item {
        background: rgba(255, 255, 255, 0.05);
      }

      .prep-detail-label {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 5px;
      }

      .prep-detail-value {
        color: var(--text);
      }

      .preview-container {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: center;
      }

      body.dark-mode .preview-container {
        background: rgba(255, 255, 255, 0.05);
      }

      .preview-container img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* تصميم زر التحميل */
      .download-btn {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .download-btn:hover {
        background: rgba(46, 204, 113, 0.2);
      }

      /* الأزرار في نافذة مراجعة التحضير */
      .review-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .approve-btn {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
      }

      .approve-btn:hover {
        background: rgba(46, 204, 113, 0.2);
      }

      .reject-btn {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
      }

      .reject-btn:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      /* التصميم المتجاوب */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
      }

      @media (max-width: 992px) {
        .sidebar {
          width: 80px;
        }

        .sidebar-header .logo-text,
        .user-info,
        .menu-item span {
          display: none;
        }

        body.rtl .main-content {
          margin-right: 80px;
        }

        body.ltr .main-content {
          margin-left: 80px;
        }

        .menu-item a {
          justify-content: center;
          padding: 15px;
        }

        .menu-item i {
          margin: 0;
          font-size: 20px;
        }

        .sidebar-footer .menu-item span {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .stats-cards {
          grid-template-columns: 1fr;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .header-actions {
          justify-content: center;
        }

        .content-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .content-meta {
          flex-direction: column;
          gap: 5px;
        }

        .content-actions {
          align-self: flex-end;
        }

        .review-buttons {
          flex-direction: column;
        }
      }

      @media (max-width: 576px) {
        .main-content {
          padding: 15px;
        }

        .modal-content {
          padding: 20px;
          width: 95%;
        }

        .sidebar {
          width: 70px;
        }

        body.rtl .main-content {
          margin-right: 70px;
        }

        body.ltr .main-content {
          margin-left: 70px;
        }
      }
    </style>
  </head>

  <body class="rtl">
    <div class="dashboard-container">
      <!-- الشريط الجانبي -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="logo.png" alt="Logo" />
          </div>
          <div class="logo-text">DT Edu</div>
          <div class="user-info">
            <div class="user-name" id="user-name">عبير حسن</div>
            <div class="user-type" id="user-type">مدير المدرسة</div>
          </div>
        </div>

        <ul class="sidebar-menu">
          <li class="menu-item active">
            <a href="admin-dashboard.html">
              <i class="fas fa-home"></i>
              <span id="menu-dashboard">لوحة التحكم</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-users.html">
              <i class="fas fa-users-cog"></i>
              <span id="menu-users">إدارة المستخدمين</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-payments.html">
              <i class="fas fa-money-bill-wave"></i>
              <span>المدفوعات والرسوم</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-reports.html">
              <i class="fas fa-chart-bar"></i>
              <span id="menu-reports">التقارير والإحصائيات</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-schedule.html">
              <i class="fas fa-calendar-alt"></i>
              <span id="menu-schedule">الجدول المدرسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="classroom.html">
              <i class="fas fa-chalkboard"></i>
              <span>الفصل الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-messages.html">
              <i class="fas fa-comments"></i>
              <span id="menu-messages">الرسائل</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-settings.html">
              <i class="fas fa-cogs"></i>
              <span id="menu-settings">إعدادات النظام</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <ul class="sidebar-menu">
            <li class="menu-item">
              <a href="#" id="sidebar-dark-mode-toggle" style="display: none">
                <i class="fas fa-moon"></i>
                <span id="dark-mode-text">الوضع الداكن</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="#" id="sidebar-language-toggle">
                <i class="fas fa-language"></i>
                <span>English</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="#" id="logout-link">
                <i class="fas fa-sign-out-alt"></i>
                <span id="logout-text">تسجيل الخروج</span>
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- المحتوى الرئيسي -->
      <div class="main-content">
        <div class="header">
          <h1 id="header-title">لوحة تحكم المدير - نظام DT Edu</h1>
          <div class="header-actions">
            <button
              class="dark-mode-toggle"
              id="header-dark-mode-toggle"
              style="display: none"
            >
              <i class="fas fa-moon"></i>
              <span id="dark-mode-btn-text">الوضع الداكن</span>
            </button>
            <button class="logout-btn" id="header-logout-btn">
              <i class="fas fa-sign-out-alt"></i>
              <span id="header-logout-text">تسجيل الخروج</span>
            </button>
          </div>
        </div>

        <!-- محتوى خاص بالمدير -->
        <div id="admin-content" class="user-specific-content active">
          <!-- بطاقات الإحصائيات للمدير -->
          <div class="stats-cards">
            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
              >
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="students-count">0</div>
                <div class="stat-label" id="admin-students-stat">
                  عدد الطلاب
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #00b894, #00a085)"
              >
                <i class="fas fa-chalkboard-teacher"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="teachers-count">0</div>
                <div class="stat-label" id="admin-teachers-stat">
                  عدد المعلمين
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #fd79a8, #e84393)"
              >
                <i class="fas fa-school"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="classes-count">0</div>
                <div class="stat-label" id="admin-classes-stat">عدد الفصول</div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #fdcb6e, #e17055)"
              >
                <i class="fas fa-file-check"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="pending-prep-count">0</div>
                <div class="stat-label" id="admin-prep-stat">
                  ملفات تحضير بانتظار المراجعة
                </div>
              </div>
            </div>
          </div>

          <!-- الشبكة الرئيسية للمدير -->
          <div class="dashboard-grid">
            <!-- بطاقة 1: إدارة المستخدمين -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
                >
                  <i class="fas fa-user-cog"></i>
                </div>
                <div class="card-title" id="admin-users-card">
                  إدارة المستخدمين
                </div>
              </div>
              <div class="card-content" id="admin-users-desc">
                إدارة حسابات الطلاب والمعلمين وأولياء الأمور.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="admin-users-btn"
                  onclick="window.location.href='admin-users.html'"
                >
                  <i class="fas fa-cog"></i>
                  <span>إدارة</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 2: التقارير والإحصائيات -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #00b894, #00a085)"
                >
                  <i class="fas fa-chart-bar"></i>
                </div>
                <div class="card-title" id="admin-reports-card">
                  التقارير والإحصائيات
                </div>
              </div>
              <div class="card-content" id="admin-reports-desc">
                عرض التقارير والإحصائيات الشاملة للمدرسة.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="admin-reports-btn"
                  onclick="window.location.href='admin-reports.html'"
                >
                  <i class="fas fa-file-alt"></i>
                  <span>عرض</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 3: مراجعة التحضير -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fd79a8, #e84393)"
                >
                  <i class="fas fa-file-check"></i>
                </div>
                <div class="card-title" id="admin-prep-card">
                  مراجعة التحضير
                </div>
              </div>
              <div class="card-content" id="admin-prep-desc">
                مراجعة وتحضير الدروس المرفوعة من المعلمين.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="admin-prep-btn"
                  onclick="openPrepReviewModal()"
                >
                  <i class="fas fa-check-circle"></i>
                  <span id="admin-prep-btn-text"
                    >مراجعة
                    <span
                      id="badge-count"
                      class="badge"
                      style="
                        background: #e74c3c;
                        color: white;
                        border-radius: 50%;
                        padding: 2px 6px;
                        font-size: 12px;
                        margin-right: 5px;
                        display: none;
                      "
                      >0</span
                    ></span
                  >
                </button>
              </div>
            </div>

            <!-- بطاقة 4: إعدادات النظام -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fdcb6e, #e17055)"
                >
                  <i class="fas fa-cogs"></i>
                </div>
                <div class="card-title" id="admin-settings-card">
                  إعدادات النظام
                </div>
              </div>
              <div class="card-content" id="admin-settings-desc">
                إعدادات النظام العامة وإدارة الصلاحيات.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="admin-settings-btn"
                  onclick="window.location.href='admin-settings.html'"
                >
                  <i class="fas fa-sliders-h"></i>
                  <span>إعدادات</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 5: الجدول المدرسي -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #a29bfe, #6c5ce7)"
                >
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="card-title" id="admin-schedule-card">
                  الجدول المدرسي
                </div>
              </div>
              <div class="card-content" id="admin-schedule-desc">
                إدارة الجداول الدراسية وتوزيع الحصص.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="admin-schedule-btn"
                  onclick="window.location.href='admin-schedule.html'"
                >
                  <i class="fas fa-edit"></i>
                  <span>إدارة</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 6: التواصل -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #81ecec, #00cec9)"
                >
                  <i class="fas fa-comments"></i>
                </div>
                <div class="card-title" id="admin-messaging-card">التواصل</div>
              </div>
              <div class="card-content" id="admin-messaging-desc">
                التواصل مع المعلمين والطلاب وأولياء الأمور.
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="admin-messaging-btn"
                  onclick="window.location.href='admin-messages.html'"
                >
                  <i class="fas fa-comment"></i>
                  <span>مراسلة</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- قسم التقارير -->
        <div class="reports-section">
          <h2 class="reports-title" id="reports-title">التقارير الشاملة</h2>
          <p class="reports-description" id="reports-desc">
            قم بمراجعة التقارير الشاملة للمدرسة وإحصائيات الأداء للطلاب
            والمعلمين.
          </p>
          <button
            class="reports-btn"
            id="reports-btn"
            onclick="window.location.href='admin-reports.html'"
          >
            <i class="fas fa-chart-bar"></i>
            <span>عرض التقارير الشاملة</span>
          </button>
        </div>
      </div>
    </div>

    <!-- النوافذ المنبثقة -->

    <!-- نافذة مراجعة التحضير -->
    <div id="prep-review-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('prep-review-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="prep-review-title">مراجعة التحضير</h2>
        <div id="prep-review-content">
          <div class="form-group">
            <label for="prep-filter">تصفية حسب:</label>
            <select id="prep-filter">
              <option value="pending">في انتظار المراجعة</option>
              <option value="approved">تمت الموافقة</option>
              <option value="rejected">مرفوض</option>
              <option value="all">جميع التحضيرات</option>
            </select>
          </div>
          <div class="form-group">
            <label for="teacher-filter">تصفية حسب المعلم:</label>
            <select id="teacher-filter">
              <option value="all">جميع المعلمين</option>
              <!-- سيتم تعبئته بالجافاسكريبت -->
            </select>
          </div>
          <ul class="content-list" id="prep-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>
        </div>
      </div>
    </div>

    <!-- نافذة تفاصيل ملف التحضير -->
    <div id="prep-detail-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('prep-detail-modal')"
          >&times;</span
        >
        <h2 class="modal-title" id="prep-detail-title">تفاصيل ملف التحضير</h2>
        <div id="prep-detail-content">
          <div class="prep-detail-container" id="prep-details">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </div>
          <div
            class="review-buttons"
            id="review-buttons"
            style="margin-top: 20px"
          >
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </div>
          <div
            class="form-group"
            id="review-notes-section"
            style="margin-top: 20px; display: none"
          >
            <label for="review-notes">ملاحظات المراجعة:</label>
            <textarea
              id="review-notes"
              rows="4"
              placeholder="أدخل ملاحظاتك حول ملف التحضير"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      // تعريف قاعدة البيانات باستخدام Dexie (نفس التعريف)
      const db = new Dexie("DTEduDB");

      // تعريف الجداول والمفاتيح (نسخة محدثة)
      db.version(3)
        .stores({
          users:
            "++id, name, email, type, class, status, registrationDate, avatar, password",
          logs: "++id, userId, action, details, timestamp",
          statistics: "id, value",
        })
        .upgrade(async (tx) => {
          // ترقية قاعدة البيانات: إضافة جدول الإحصائيات إذا لزم الأمر
          try {
            const stats = await tx.table("statistics").toArray();
            if (stats.length === 0) {
              await tx.table("statistics").bulkAdd([
                { id: "students", value: 0 },
                { id: "teachers", value: 0 },
                { id: "parents", value: 0 },
                { id: "admins", value: 0 },
                { id: "totalUsers", value: 0 },
                { id: "pendingPreps", value: 0 },
              ]);
              console.log("تم تهيئة جدول الإحصائيات");
            }
          } catch (error) {
            console.error("خطأ في ترقية قاعدة البيانات:", error);
          }
        });

      // استعادة اللغة المحفوظة
      let currentLanguage = localStorage.getItem("currentLanguage") || "ar";

      // استعادة وضع التصميم المحفوظ
      let darkMode = localStorage.getItem("darkMode") === "true";

      // استعادة معلومات المستخدم
      const currentUser = JSON.parse(
        localStorage.getItem("currentUser") || "{}"
      );

      // متغيرات النظام
      let currentPrepDetail = null;

      // تحديث اتجاه الصفحة واللغة والوضع الداكن
      document.body.className = currentLanguage === "ar" ? "rtl" : "ltr";
      if (darkMode) {
        document.body.classList.add("dark-mode");
      }

      document.getElementById("user-name").textContent = "عبير حسن";

      // إعداد زر الوضع الداكن
      document
        .querySelectorAll("#header-dark-mode-toggle, #sidebar-dark-mode-toggle")
        .forEach((btn) => {
          btn.addEventListener("click", function () {
            // تبديل الوضع الداكن
            darkMode = !darkMode;

            // تحديث الوضع الداكن في التخزين المحلي
            localStorage.setItem("darkMode", darkMode);

            // تحديث الوضع الداكن في الصفحة
            if (darkMode) {
              document.body.classList.add("dark-mode");
            } else {
              document.body.classList.remove("dark-mode");
            }

            // تحديث نص الزر
            updateDarkModeText();
          });
        });

      // إعداد زر تسجيل الخروج
      document
        .getElementById("logout-link")
        .addEventListener("click", function (e) {
          e.preventDefault();
          localStorage.removeItem("currentUser");
          window.location.href = "login.html";
        });

      document
        .getElementById("header-logout-btn")
        .addEventListener("click", function () {
          localStorage.removeItem("currentUser");
          window.location.href = "login.html";
        });

      // تحديث النصوص حسب اللغة الحالية
      function updateLanguage() {
        const translations = {
          ar: {
            "header-title": "لوحة تحكم المدير - نظام DT Edu",
            "menu-dashboard": "لوحة التحكم",
            "menu-users": "إدارة المستخدمين",
            "menu-reports": "التقارير والإحصائيات",
            "menu-schedule": "الجدول المدرسي",
            "menu-settings": "إعدادات النظام",
            "menu-messages": "الرسائل",

            // إحصائيات المدير
            "admin-students-stat": "عدد الطلاب",
            "admin-teachers-stat": "عدد المعلمين",
            "admin-classes-stat": "عدد الفصول",
            "admin-prep-stat": "ملفات تحضير بانتظار المراجعة",

            // بطاقات المدير
            "admin-users-card": "إدارة المستخدمين",
            "admin-users-desc": "إدارة حسابات الطلاب والمعلمين وأولياء الأمور.",
            "admin-users-btn": "إدارة",
            "admin-reports-card": "التقارير والإحصائيات",
            "admin-reports-desc": "عرض التقارير والإحصائيات الشاملة للمدرسة.",
            "admin-reports-btn": "عرض",
            "admin-prep-card": "مراجعة التحضير",
            "admin-prep-desc": "مراجعة وتحضير الدروس المرفوعة من المعلمين.",
            "admin-prep-btn-text": "مراجعة",
            "admin-settings-card": "إعدادات النظام",
            "admin-settings-desc": "إعدادات النظام العامة وإدارة الصلاحيات.",
            "admin-settings-btn": "إعدادات",
            "admin-schedule-card": "الجدول المدرسي",
            "admin-schedule-desc": "إدارة الجداول الدراسية وتوزيع الحصص.",
            "admin-schedule-btn": "إدارة",
            "admin-messaging-card": "التواصل",
            "admin-messaging-desc":
              "التواصل مع المعلمين والطلاب وأولياء الأمور.",
            "admin-messaging-btn": "مراسلة",

            // عناصر مشتركة
            "reports-title": "التقارير الشاملة",
            "reports-desc":
              "قم بمراجعة التقارير الشاملة للمدرسة وإحصائيات الأداء للطلاب والمعلمين.",
            "reports-btn": "عرض التقارير الشاملة",
            "logout-text": "تسجيل الخروج",
            "header-logout-text": "تسجيل الخروج",
            "dark-mode-text": "الوضع الداكن",
            "dark-mode-btn-text": "الوضع الداكن",

            // عناوين النوافذ المنبثقة
            "prep-review-title": "مراجعة التحضير",
            "prep-detail-title": "تفاصيل ملف التحضير",
          },
          en: {
            "header-title": "Admin Dashboard - DT Edu System",
            "menu-dashboard": "Dashboard",
            "menu-users": "Users Management",
            "menu-reports": "Reports & Statistics",
            "menu-schedule": "School Schedule",
            "menu-settings": "System Settings",
            "menu-messages": "Messages",

            // إحصائيات المدير
            "admin-students-stat": "Students Count",
            "admin-teachers-stat": "Teachers Count",
            "admin-classes-stat": "Classes Count",
            "admin-prep-stat": "Preparation Files Pending Review",

            // بطاقات المدير
            "admin-users-card": "Users Management",
            "admin-users-desc": "Manage student, teacher, and parent accounts.",
            "admin-users-btn": "Manage",
            "admin-reports-card": "Reports & Statistics",
            "admin-reports-desc":
              "View comprehensive school reports and statistics.",
            "admin-reports-btn": "View",
            "admin-prep-card": "Preparation Review",
            "admin-prep-desc":
              "Review and approve lesson plans uploaded by teachers.",
            "admin-prep-btn-text": "Review",
            "admin-settings-card": "System Settings",
            "admin-settings-desc":
              "General system settings and permissions management.",
            "admin-settings-btn": "Settings",
            "admin-schedule-card": "School Schedule",
            "admin-schedule-desc":
              "Manage academic schedules and class distribution.",
            "admin-schedule-btn": "Manage",
            "admin-messaging-card": "Communication",
            "admin-messaging-desc":
              "Communicate with teachers, students, and parents.",
            "admin-messaging-btn": "Message",

            // عناصر مشتركة
            "reports-title": "Comprehensive Reports",
            "reports-desc":
              "Review comprehensive school reports and performance statistics for students and teachers.",
            "reports-btn": "View Comprehensive Reports",
            "logout-text": "Logout",
            "header-logout-text": "Logout",
            "dark-mode-text": "Dark Mode",
            "dark-mode-btn-text": "Dark Mode",

            // عناوين النوافذ المنبثقة
            "prep-review-title": "Preparation Review",
            "prep-detail-title": "Preparation File Details",
          },
        };

        // تطبيق الترجمات
        Object.keys(translations[currentLanguage]).forEach((key) => {
          const element = document.getElementById(key);
          if (element) {
            element.textContent = translations[currentLanguage][key];
          }
        });
      }

      // تحديث نص زر الوضع الداكن
      function updateDarkModeText() {
        const darkModeText =
          currentLanguage === "ar"
            ? darkMode
              ? "الوضع الفاتح"
              : "الوضع الداكن"
            : darkMode
            ? "Light Mode"
            : "Dark Mode";

        document.getElementById("dark-mode-text").textContent = darkModeText;
        document.getElementById("dark-mode-btn-text").textContent =
          darkModeText;

        // تحديث الأيقونة
        const icons = document.querySelectorAll(
          "#header-dark-mode-toggle i, #sidebar-dark-mode-toggle i"
        );
        icons.forEach((icon) => {
          icon.className = darkMode ? "fas fa-sun" : "fas fa-moon";
        });
      }

      // دالة لجلب الإحصائيات من قاعدة البيانات
      async function getStatistics() {
        try {
          const stats = await db.statistics.toArray();
          const statsObj = {};
          stats.forEach((stat) => {
            statsObj[stat.id] = stat.value;
          });

          // إذا لم تكن الإحصائيات موجودة، نقوم بحسابها
          if (Object.keys(statsObj).length === 0) {
            await recalculateStatistics();
            return await getStatistics();
          }

          return statsObj;
        } catch (error) {
          console.error("خطأ في جلب الإحصائيات:", error);
          return {
            students: 0,
            teachers: 0,
            parents: 0,
            admins: 0,
            totalUsers: 0,
            pendingPreps: 0,
          };
        }
      }

      // دالة لإعادة حساب الإحصائيات
      async function recalculateStatistics() {
        try {
          // حساب عدد كل نوع من المستخدمين
          const students = await db.users
            .where("type")
            .equals("student")
            .count();
          const teachers = await db.users
            .where("type")
            .equals("teacher")
            .count();
          const parents = await db.users.where("type").equals("parent").count();
          const admins = await db.users.where("type").equals("admin").count();
          const totalUsers = await db.users.count();

          // تحديث أو إضافة الإحصائيات
          await db.statistics.put({ id: "students", value: students });
          await db.statistics.put({ id: "teachers", value: teachers });
          await db.statistics.put({ id: "parents", value: parents });
          await db.statistics.put({ id: "admins", value: admins });
          await db.statistics.put({ id: "totalUsers", value: totalUsers });
          await db.statistics.put({ id: "pendingPreps", value: 0 });

          console.log("تم إعادة حساب الإحصائيات");

          // إرسال إشعار بالتحديث
          notifyStatsUpdate();
        } catch (error) {
          console.error("خطأ في إعادة حساب الإحصائيات:", error);
        }
      }

      // إرسال إشعار بتحديث الإحصائيات
      function notifyStatsUpdate() {
        if ("BroadcastChannel" in window) {
          try {
            const channel = new BroadcastChannel("stats-update");
            channel.postMessage({
              action: "statsUpdated",
              timestamp: Date.now(),
            });
          } catch (error) {
            console.error("خطأ في إرسال إشعار تحديث الإحصائيات:", error);
          }
        }
      }

      // تهيئة قاعدة البيانات
      async function initializeDatabase() {
        try {
          // التأكد من وجود جدول الإحصائيات
          const statsCount = await db.statistics.count();
          if (statsCount === 0) {
            await recalculateStatistics();
          }
        } catch (error) {
          console.error("خطأ في تهيئة قاعدة البيانات:", error);
        }
      }

      // دالة لتحديث إحصائيات لوحة التحكم
      async function updateDashboardStats() {
        try {
          // جلب الإحصائيات من قاعدة البيانات
          const stats = await getStatistics();

          // تحديث الأرقام في الواجهة
          document.getElementById("students-count").textContent =
            stats.students || 0;
          document.getElementById("teachers-count").textContent =
            stats.teachers || 0;
          document.getElementById("classes-count").textContent = Math.ceil(
            (stats.students || 0) / 30
          ); // تقدير عدد الفصول

          // تحديث عدد ملفات التحضير المنتظرة (من localStorage كما هو)
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          const pendingPreps = savedPreps.filter(
            (prep) => prep.status === "pending"
          );
          document.getElementById("pending-prep-count").textContent =
            pendingPreps.length;

          // تحديث البادج على زر المراجعة
          const badgeCount = document.getElementById("badge-count");
          if (badgeCount) {
            if (pendingPreps.length > 0) {
              badgeCount.textContent = pendingPreps.length;
              badgeCount.style.display = "inline-block";
            } else {
              badgeCount.style.display = "none";
            }
          }
        } catch (error) {
          console.error("Error updating dashboard stats:", error);
        }
      }

      // الاستماع لتحديثات الإحصائيات من الصفحات الأخرى
      function setupStatsListener() {
        if ("BroadcastChannel" in window) {
          try {
            const channel = new BroadcastChannel("stats-update");
            channel.onmessage = async (event) => {
              if (event.data.action === "statsUpdated") {
                console.log("تم استقبال تحديث للإحصائيات");
                await updateDashboardStats();
              }
            };
          } catch (error) {
            console.error("خطأ في إعداد مستمع الإحصائيات:", error);
          }
        }
      }

      // وظائف فتح النوافذ المنبثقة
      async function openPrepReviewModal() {
        document.getElementById("prep-review-modal").style.display = "flex";
        await loadPrepList();
        await loadTeacherFilter();
      }

      // وظيفة إغلاق النوافذ المنبثقة
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // إغلاق النوافذ المنبثقة عند النقر خارجها
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", function (e) {
          if (e.target === this) {
            this.style.display = "none";
          }
        });
      });

      // دالة لعرض رسائل التنبيه
      function showToast(type, message) {
        // إنصراف إذا كانت الرسالة فارغة
        if (!message) return;

        // إزالة أي رسائل سابقة
        const existingToast = document.querySelector(".toast-message");
        if (existingToast) {
          existingToast.remove();
        }

        // إنشاء عنصر الرسالة
        const toast = document.createElement("div");
        toast.className = `toast-message toast-${type}`;
        toast.textContent = message;

        // إضافة الأنماط
        toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: ${currentLanguage === "ar" ? "20px" : "auto"};
                left: ${currentLanguage === "ar" ? "auto" : "20px"};
                background: ${
                  type === "success"
                    ? "#00b894"
                    : type === "error"
                    ? "#e74c3c"
                    : type === "info"
                    ? "#3498db"
                    : "#fdcb6e"
                };
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;

        document.body.appendChild(toast);

        // إضافة animation
        const style = document.createElement("style");
        style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateY(-100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateY(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateY(-100%);
                        opacity: 0;
                    }
                }
            `;
        document.head.appendChild(style);

        // إزالة الرسالة بعد 3 ثوانٍ
        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }, 3000);
      }

      // دالة للحصول على عدد ملفات التحضير المنتظرة
      function getPendingPreparationCount() {
        try {
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          const pendingPreps = savedPreps.filter(
            (prep) => prep.status === "pending"
          );
          return pendingPreps.length;
        } catch (error) {
          console.error("Error getting pending preps:", error);
          return 0;
        }
      }

      // دالة للحصول على جميع ملفات التحضير
      function getAllPreparations() {
        try {
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          return savedPreps;
        } catch (error) {
          console.error("Error getting preparations:", error);
          return [];
        }
      }

      // دالة لتحميل قائمة المعلمين في الفلتر
      async function loadTeacherFilter() {
        try {
          const teacherFilter = document.getElementById("teacher-filter");
          if (!teacherFilter) return;

          // إزالة الخيارات الحالية (باستثناء "جميع المعلمين")
          while (teacherFilter.options.length > 1) {
            teacherFilter.remove(1);
          }

          // الحصول على جميع المعلمين من قاعدة البيانات
          const teachers = await db.users
            .where("type")
            .equals("teacher")
            .toArray();

          // إضافة المعلمين إلى الفلتر
          teachers.forEach((teacher) => {
            const option = document.createElement("option");
            option.value = teacher.id;
            option.textContent =
              currentLanguage === "ar" ? teacher.name : teacher.name;
            teacherFilter.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading teacher filter:", error);
        }
      }

      // دالة لتحميل قائمة التحضير
      async function loadPrepList() {
        try {
          const filterValue = document.getElementById("prep-filter").value;
          const teacherFilterValue =
            document.getElementById("teacher-filter").value;
          const prepList = document.getElementById("prep-list");

          if (!prepList) return;

          prepList.innerHTML = "";

          // الحصول على جميع ملفات التحضير
          let filteredPreps = getAllPreparations();

          // تطبيق الفلاتر
          if (filterValue !== "all") {
            filteredPreps = filteredPreps.filter(
              (prep) => prep.status === filterValue
            );
          }

          if (teacherFilterValue !== "all") {
            filteredPreps = filteredPreps.filter(
              (prep) => prep.teacherId === teacherFilterValue
            );
          }

          // ترتيب الملفات حسب تاريخ الرفع (الأحدث أولاً)
          filteredPreps.sort(
            (a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)
          );

          if (filteredPreps.length === 0) {
            const emptyItem = document.createElement("li");
            emptyItem.className = "content-item";
            emptyItem.style.justifyContent = "center";
            emptyItem.innerHTML = `<div style="color: var(--text-light);">${
              currentLanguage === "ar"
                ? "لا توجد ملفات تحضير"
                : "No preparation files found"
            }</div>`;
            prepList.appendChild(emptyItem);
            return;
          }

          filteredPreps.forEach((prep) => {
            const item = document.createElement("li");
            item.className = "content-item";

            // تحديد حالة الملف
            const statusText = {
              pending:
                currentLanguage === "ar"
                  ? "في انتظار المراجعة"
                  : "Pending Review",
              approved: currentLanguage === "ar" ? "تمت الموافقة" : "Approved",
              rejected: currentLanguage === "ar" ? "مرفوض" : "Rejected",
            };

            const statusClass = {
              pending: "status-pending",
              approved: "status-approved",
              rejected: "status-rejected",
            };

            // تنسيق حجم الملف
            const fileSize = prep.fileSize || 0;
            let fileSizeText = "";
            if (fileSize < 1024) {
              fileSizeText = `${fileSize} بايت`;
            } else if (fileSize < 1024 * 1024) {
              fileSizeText = `${(fileSize / 1024).toFixed(1)} كيلوبايت`;
            } else {
              fileSizeText = `${(fileSize / (1024 * 1024)).toFixed(
                1
              )} ميجابايت`;
            }

            item.innerHTML = `
                        <div style="flex: 1;">
                            <div class="content-name">${prep.fileName}</div>
                            <div class="content-meta">
                                <span><strong>${
                                  currentLanguage === "ar"
                                    ? "المعلم:"
                                    : "Teacher:"
                                }</strong> ${prep.teacherName}</span>
                                <span><strong>${
                                  currentLanguage === "ar"
                                    ? "المادة:"
                                    : "Subject:"
                                }</strong> ${prep.subjectName}</span>
                                <span><strong>${
                                  currentLanguage === "ar"
                                    ? "تاريخ التحضير:"
                                    : "Preparation Date:"
                                }</strong> ${prep.date}</span>
                                <span><strong>${
                                  currentLanguage === "ar"
                                    ? "حجم الملف:"
                                    : "File Size:"
                                }</strong> ${fileSizeText}</span>
                                <span class="status-badge ${
                                  statusClass[prep.status]
                                }">${statusText[prep.status]}</span>
                            </div>
                        </div>
                        <div class="content-actions">
                            <button class="content-btn" onclick="viewPrepDetail(${
                              prep.id
                            })">
                                <i class="fas fa-eye"></i>
                                ${currentLanguage === "ar" ? "عرض" : "View"}
                            </button>
                            <button class="download-btn" onclick="downloadPrepFile(${
                              prep.id
                            })">
                                <i class="fas fa-download"></i>
                                ${
                                  currentLanguage === "ar"
                                    ? "تحميل"
                                    : "Download"
                                }
                            </button>
                        </div>
                    `;
            prepList.appendChild(item);
          });
        } catch (error) {
          console.error("Error loading prep list:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في تحميل قائمة التحضير"
              : "Error loading preparation list"
          );
        }
      }

      // دالة لعرض تفاصيل ملف التحضير
      function viewPrepDetail(prepId) {
        try {
          const savedPreps = getAllPreparations();
          const prep = savedPreps.find((p) => p.id === prepId);

          if (!prep) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف التحضير غير موجود"
                : "Preparation file not found"
            );
            return;
          }

          currentPrepDetail = prep;

          const prepDetails = document.getElementById("prep-details");
          const reviewButtons = document.getElementById("review-buttons");
          const reviewNotesSection = document.getElementById(
            "review-notes-section"
          );

          if (!prepDetails || !reviewButtons) return;

          // تعبئة تفاصيل الملف
          prepDetails.innerHTML = `
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar" ? "اسم الملف:" : "File Name:"
                        }</div>
                        <div class="prep-detail-value">${prep.fileName}</div>
                    </div>
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar" ? "المعلم:" : "Teacher:"
                        }</div>
                        <div class="prep-detail-value">${prep.teacherName}</div>
                    </div>
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar" ? "المادة:" : "Subject:"
                        }</div>
                        <div class="prep-detail-value">${prep.subjectName}</div>
                    </div>
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar"
                            ? "تاريخ التحضير:"
                            : "Preparation Date:"
                        }</div>
                        <div class="prep-detail-value">${prep.date}</div>
                    </div>
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar"
                            ? "تاريخ الرفع:"
                            : "Upload Date:"
                        }</div>
                        <div class="prep-detail-value">${new Date(
                          prep.uploadDate
                        ).toLocaleString(
                          currentLanguage === "ar" ? "ar-SA" : "en-US"
                        )}</div>
                    </div>
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar"
                            ? "حالة المراجعة:"
                            : "Review Status:"
                        }</div>
                        <div class="prep-detail-value">
                            <span class="status-badge ${
                              prep.status === "pending"
                                ? "status-pending"
                                : prep.status === "approved"
                                ? "status-approved"
                                : "status-rejected"
                            }">
                                ${
                                  prep.status === "pending"
                                    ? currentLanguage === "ar"
                                      ? "في انتظار المراجعة"
                                      : "Pending Review"
                                    : prep.status === "approved"
                                    ? currentLanguage === "ar"
                                      ? "تمت الموافقة"
                                      : "Approved"
                                    : currentLanguage === "ar"
                                    ? "مرفوض"
                                    : "Rejected"
                                }
                            </span>
                        </div>
                    </div>
                    ${
                      prep.reviewedBy
                        ? `
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar"
                            ? "تمت المراجعة بواسطة:"
                            : "Reviewed By:"
                        }</div>
                        <div class="prep-detail-value">${prep.reviewedBy}</div>
                    </div>
                    `
                        : ""
                    }
                    ${
                      prep.reviewDate
                        ? `
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar"
                            ? "تاريخ المراجعة:"
                            : "Review Date:"
                        }</div>
                        <div class="prep-detail-value">${new Date(
                          prep.reviewDate
                        ).toLocaleString(
                          currentLanguage === "ar" ? "ar-SA" : "en-US"
                        )}</div>
                    </div>
                    `
                        : ""
                    }
                    ${
                      prep.reviewNotes
                        ? `
                    <div class="prep-detail-item">
                        <div class="prep-detail-label">${
                          currentLanguage === "ar"
                            ? "ملاحظات المراجعة:"
                            : "Review Notes:"
                        }</div>
                        <div class="prep-detail-value">${prep.reviewNotes}</div>
                    </div>
                    `
                        : ""
                    }
                `;

          // إضافة معاينة الملف إذا كان صورة
          if (prep.fileContent && prep.fileContent.includes("data:image/")) {
            prepDetails.innerHTML += `
                        <div class="preview-container">
                            <div style="margin-bottom: 10px; font-weight: 600; color: var(--primary);">
                                ${
                                  currentLanguage === "ar"
                                    ? "معاينة الملف:"
                                    : "File Preview:"
                                }
                            </div>
                            <img src="${prep.fileContent}" alt="${
              prep.fileName
            }">
                        </div>
                    `;
          }

          // إعداد أزرار المراجعة
          if (prep.status === "pending") {
            reviewButtons.innerHTML = `
                        <button class="approve-btn" onclick="approvePrepFile(${
                          prep.id
                        })">
                            <i class="fas fa-check-circle"></i>
                            ${currentLanguage === "ar" ? "موافقة" : "Approve"}
                        </button>
                        <button class="reject-btn" onclick="rejectPrepFile(${
                          prep.id
                        })">
                            <i class="fas fa-times-circle"></i>
                            ${currentLanguage === "ar" ? "رفض" : "Reject"}
                        </button>
                        <button class="download-btn" onclick="downloadPrepFile(${
                          prep.id
                        })" style="margin-right: auto;">
                            <i class="fas fa-download"></i>
                            ${
                              currentLanguage === "ar"
                                ? "تحميل الملف"
                                : "Download File"
                            }
                        </button>
                    `;
            reviewNotesSection.style.display = "block";
          } else {
            reviewButtons.innerHTML = `
                        <button class="download-btn" onclick="downloadPrepFile(${
                          prep.id
                        })">
                            <i class="fas fa-download"></i>
                            ${
                              currentLanguage === "ar"
                                ? "تحميل الملف"
                                : "Download File"
                            }
                        </button>
                    `;
            reviewNotesSection.style.display = "none";
          }

          // فتح نافذة التفاصيل
          document.getElementById("prep-detail-modal").style.display = "flex";
        } catch (error) {
          console.error("Error viewing prep detail:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في عرض تفاصيل الملف"
              : "Error viewing file details"
          );
        }
      }

      // دالة لتحميل ملف التحضير
      function downloadPrepFile(prepId) {
        try {
          const savedPreps = getAllPreparations();
          const prep = savedPreps.find((p) => p.id === prepId);

          if (!prep || !prep.fileContent) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف التحضير غير موجود"
                : "Preparation file not found"
            );
            return;
          }

          // استخراج معلومات الملف من base64
          const base64Data = prep.fileContent;
          const fileName = prep.fileName;

          // تحويل base64 إلى Blob
          const byteString = atob(base64Data.split(",")[1]);
          const mimeString = base64Data
            .split(",")[0]
            .split(":")[1]
            .split(";")[0];
          const ab = new ArrayBuffer(byteString.length);
          const ia = new Uint8Array(ab);

          for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
          }

          const blob = new Blob([ab], { type: mimeString });

          // استخدام FileSaver.js لتنزيل الملف
          saveAs(blob, fileName);

          showToast(
            "success",
            currentLanguage === "ar"
              ? `جاري تحميل الملف: ${fileName}`
              : `Downloading file: ${fileName}`
          );
        } catch (error) {
          console.error("Error downloading prep file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في تحميل الملف"
              : "Error downloading file"
          );
        }
      }

      // دالة للموافقة على ملف التحضير
      function approvePrepFile(prepId) {
        try {
          const reviewNotes = document.getElementById("review-notes").value;
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          const prepIndex = savedPreps.findIndex((p) => p.id === prepId);

          if (prepIndex === -1) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف التحضير غير موجود"
                : "Preparation file not found"
            );
            return;
          }

          // تحديث حالة الملف
          savedPreps[prepIndex].status = "approved";
          savedPreps[prepIndex].reviewedBy =
            currentUser.name || currentUser.nameEn || "مدير النظام";
          savedPreps[prepIndex].reviewDate = new Date().toISOString();
          savedPreps[prepIndex].reviewNotes = reviewNotes;

          // حفظ التغييرات
          localStorage.setItem(
            "teacherPreparations",
            JSON.stringify(savedPreps)
          );

          // تحديث الإحصائيات في قاعدة البيانات
          db.statistics
            .where("id")
            .equals("pendingPreps")
            .modify((stat) => {
              stat.value = Math.max(0, stat.value - 1);
            });

          showToast(
            "success",
            currentLanguage === "ar"
              ? "تمت الموافقة على ملف التحضير"
              : "Preparation file approved"
          );

          // تحديث القائمة والإحصائيات
          loadPrepList();
          updateDashboardStats();
          closeModal("prep-detail-modal");

          // إعادة تعيين ملاحظات المراجعة
          document.getElementById("review-notes").value = "";
        } catch (error) {
          console.error("Error approving prep file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في الموافقة على الملف"
              : "Error approving file"
          );
        }
      }

      // دالة لرفض ملف التحضير
      function rejectPrepFile(prepId) {
        try {
          const reviewNotes = document.getElementById("review-notes").value;

          if (!reviewNotes.trim()) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "يرجى إدخال ملاحظات المراجعة"
                : "Please enter review notes"
            );
            return;
          }

          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          const prepIndex = savedPreps.findIndex((p) => p.id === prepId);

          if (prepIndex === -1) {
            showToast(
              "error",
              currentLanguage === "ar"
                ? "ملف التحضير غير موجود"
                : "Preparation file not found"
            );
            return;
          }

          // تحديث حالة الملف
          savedPreps[prepIndex].status = "rejected";
          savedPreps[prepIndex].reviewedBy =
            currentUser.name || currentUser.nameEn || "مدير النظام";
          savedPreps[prepIndex].reviewDate = new Date().toISOString();
          savedPreps[prepIndex].reviewNotes = reviewNotes;

          // حفظ التغييرات
          localStorage.setItem(
            "teacherPreparations",
            JSON.stringify(savedPreps)
          );

          // تحديث الإحصائيات في قاعدة البيانات
          db.statistics
            .where("id")
            .equals("pendingPreps")
            .modify((stat) => {
              stat.value = Math.max(0, stat.value - 1);
            });

          showToast(
            "info",
            currentLanguage === "ar"
              ? "تم رفض ملف التحضير"
              : "Preparation file rejected"
          );

          // تحديث القائمة والإحصائيات
          loadPrepList();
          updateDashboardStats();
          closeModal("prep-detail-modal");

          // إعادة تعيين ملاحظات المراجعة
          document.getElementById("review-notes").value = "";
        } catch (error) {
          console.error("Error rejecting prep file:", error);
          showToast(
            "error",
            currentLanguage === "ar"
              ? "حدث خطأ في رفض الملف"
              : "Error rejecting file"
          );
        }
      }

      // إعداد معالجات الأحداث
      document
        .getElementById("prep-filter")
        .addEventListener("change", loadPrepList);
      document
        .getElementById("teacher-filter")
        .addEventListener("change", loadPrepList);

      // عند تحميل الصفحة
      document.addEventListener("DOMContentLoaded", async () => {
        // تحديث اللغة والوضع الداكن
        updateLanguage();
        updateDarkModeText();

        // فتح قاعدة البيانات وتهيئة الإحصائيات
        try {
          await db.open();
          await initializeDatabase();
          await updateDashboardStats();
          setupStatsListener();
        } catch (error) {
          console.error("خطأ في فتح قاعدة البيانات:", error);
        }

        // تحديث الإحصائيات كل 5 ثوانٍ
        setInterval(updateDashboardStats, 5000);
      });

      // جعل الدوال متاحة عالمياً
      window.openPrepReviewModal = openPrepReviewModal;
      window.closeModal = closeModal;
      window.viewPrepDetail = viewPrepDetail;
      window.downloadPrepFile = downloadPrepFile;
      window.approvePrepFile = approvePrepFile;
      window.rejectPrepFile = rejectPrepFile;
    </script>
  </body>
</html>
