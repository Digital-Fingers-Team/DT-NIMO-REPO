<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم المعلم - DT Edu</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
      /* أنماط CSS الشاملة - تم دمج الأنماط من النظامين */
      :root {
        --primary: #4a6cf7;
        --primary-dark: #3a56d4;
        --secondary: #6c5ce7;
        --accent: #00b894;
        --accent-light: #55efc4;
        --warning: #fdcb6e;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --light-gray: #e9ecef;
        --dark: #2d3436;
        --text: #333;
        --text-light: #666;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s ease;
        --sidebar-width: 280px;
        --border-radius: 12px;
      }

      .dark-mode {
        --light: #1a1a2e;
        --light-gray: #2d2d44;
        --dark: #f8f9fa;
        --text: #e6e6e6;
        --text-light: #b0b0b0;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Tajawal", "Segoe UI", sans-serif;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f8ff 0%, #e1f0fa 100%);
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
      }

      body.dark-mode {
        background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
      }

      body.rtl {
        direction: rtl;
      }

      body.ltr {
        direction: ltr;
      }

      /* التصميم الرئيسي */
      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      /* الشريط الجانبي */
      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          180deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 20px 0;
        box-shadow: var(--shadow);
        z-index: 1000;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: var(--transition);
      }

      body.rtl .sidebar {
        right: 0;
      }

      body.rtl .main-content {
        margin-right: var(--sidebar-width);
      }

      body.ltr .sidebar {
        left: 0;
      }

      body.ltr .main-content {
        margin-left: var(--sidebar-width);
        margin-right: 0;
      }

      .sidebar-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
      }

      .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .logo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .logo img {
        width: 140px;
        height: auto;
        object-fit: contain;
      }

      .logo-text {
        font-size: 26px;
        font-weight: 800;
        background: linear-gradient(135deg, white, #e1f0fa);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
      }

      .user-info {
        text-align: center;
        margin-top: 10px;
        width: 100%;
      }

      .user-name {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
      }

      .user-type {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-block;
      }

      .sidebar-menu {
        list-style: none;
        padding: 0 15px;
        margin-bottom: 20px;
      }

      .menu-item {
        margin-bottom: 8px;
        border-radius: var(--border-radius);
        overflow: hidden;
        position: relative;
      }

      .menu-item a {
        display: flex;
        align-items: center;
        padding: 15px;
        color: white;
        text-decoration: none;
        transition: var(--transition);
      }

      .menu-item a:hover,
      .menu-item.active a {
        background: rgba(255, 255, 255, 0.15);
      }

      body.rtl .menu-item a:hover,
      body.rtl .menu-item.active a {
        padding-right: 25px;
      }

      body.ltr .menu-item a:hover,
      body.ltr .menu-item.active a {
        padding-left: 25px;
      }

      .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      body.rtl .menu-item i {
        margin-left: 12px;
      }

      body.ltr .menu-item i {
        margin-right: 12px;
      }

      .menu-item span {
        flex: 1;
        font-size: 16px;
      }

      .notification-badge {
        position: absolute;
        top: 10px;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      body.rtl .notification-badge {
        left: 15px;
      }

      body.ltr .notification-badge {
        right: 15px;
      }

      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: auto;
      }

      .sidebar-footer .menu-item a {
        padding: 12px 15px;
      }

      /* المحتوى الرئيسي */
      .main-content {
        flex: 1;
        padding: 25px;
        transition: var(--transition);
      }

      .header {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 20px 30px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .header {
        background: var(--light);
        color: var(--dark);
      }

      .header h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 700;
      }

      .header-subtitle {
        color: var(--text-light);
        font-size: 16px;
        margin-top: 5px;
      }

      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .dark-mode-toggle,
      .logout-btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dark-mode-toggle {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
      }

      .dark-mode-toggle:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      .logout-btn {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .logout-btn:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      /* بطاقات الإحصائيات */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 25px;
        margin-bottom: 35px;
      }

      .stat-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 25px;
        display: flex;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .stat-card {
        background: var(--light);
        color: var(--dark);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
      }

      body.rtl .stat-icon {
        margin-left: 20px;
      }

      body.ltr .stat-icon {
        margin-right: 20px;
      }

      .stat-info {
        flex: 1;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 5px;
      }

      .stat-label {
        color: var(--text-light);
        font-size: 15px;
      }

      .stat-change {
        display: flex;
        align-items: center;
        font-size: 14px;
        margin-top: 5px;
      }

      .stat-change.positive {
        color: var(--accent);
      }

      .stat-change.negative {
        color: var(--danger);
      }

      /* الشبكة الرئيسية */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 30px;
        margin-bottom: 35px;
      }

      .dashboard-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 30px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      body.dark-mode .dashboard-card {
        background: var(--light);
        color: var(--dark);
      }

      .dashboard-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
      }

      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        background: var(--primary);
      }

      body.rtl .card-icon {
        margin-left: 20px;
      }

      body.ltr .card-icon {
        margin-right: 20px;
      }

      .card-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
      }

      .card-content {
        color: var(--text-light);
        line-height: 1.7;
        margin-bottom: 25px;
        font-size: 15px;
      }

      .card-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .card-actions {
        display: flex;
        justify-content: flex-end;
      }

      .card-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
      }

      .card-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(74, 108, 247, 0.3);
      }

      .card-btn.secondary {
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
      }

      .card-btn.secondary:hover {
        background: rgba(74, 108, 247, 0.1);
      }

      /* قسم الفصل الدراسي */
      .classroom-section {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 40px;
        text-align: center;
        margin-bottom: 40px;
        background: linear-gradient(
          135deg,
          rgba(74, 108, 247, 0.05) 0%,
          rgba(108, 92, 231, 0.05) 100%
        );
      }

      body.dark-mode .classroom-section {
        background: linear-gradient(
          135deg,
          rgba(74, 108, 247, 0.1) 0%,
          rgba(108, 92, 231, 0.1) 100%
        );
      }

      .classroom-title {
        color: var(--primary);
        font-size: 28px;
        margin-bottom: 15px;
      }

      .classroom-description {
        color: var(--text-light);
        margin-bottom: 30px;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        font-size: 17px;
        line-height: 1.8;
      }

      .classroom-btn {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 5px 20px rgba(74, 108, 247, 0.4);
      }

      .classroom-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(74, 108, 247, 0.6);
      }

      /* النوافذ المنبثقة */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .modal-content {
        background-color: white;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 40px;
        position: relative;
        animation: modalFadeIn 0.3s ease-out;
      }

      body.dark-mode .modal-content {
        background-color: var(--light);
        color: var(--dark);
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-30px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .close-btn {
        position: absolute;
        top: 25px;
        font-size: 28px;
        cursor: pointer;
        color: var(--text-light);
        transition: var(--transition);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }

      .close-btn:hover {
        color: var(--text);
        background: rgba(0, 0, 0, 0.05);
      }

      body.dark-mode .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      body.rtl .close-btn {
        left: 30px;
      }

      body.ltr .close-btn {
        right: 30px;
      }

      .modal-title {
        color: var(--primary);
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(74, 108, 247, 0.1);
        font-size: 28px;
      }

      body.dark-mode .modal-title {
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .modal-subtitle {
        color: var(--text-light);
        font-size: 16px;
        margin-bottom: 25px;
      }

      /* تصميم خاص لنموذج رفع التحضير */
      .prep-form-container {
        max-width: 100%;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }

      /* أنواع الملفات */
      .assignment-types {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      .type-option {
        flex: 1;
        text-align: center;
        padding: 15px;
        border: 2px solid var(--light-gray);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      body.dark-mode .type-option {
        background: var(--light);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .type-option:hover {
        border-color: var(--primary);
        background: rgba(74, 108, 247, 0.05);
      }

      .type-option.active {
        border-color: var(--primary);
        background: rgba(74, 108, 247, 0.1);
      }

      .type-option i {
        font-size: 24px;
        color: var(--primary);
        margin-bottom: 10px;
      }

      .type-option span {
        display: block;
        font-weight: 600;
        font-size: 16px;
      }

      /* تصاميم خاصة بالمحتوى التفاعلي */
      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--text);
        font-size: 16px;
      }

      .form-group label .required {
        color: #e74c3c;
        margin-right: 5px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: var(--transition);
        background-color: #f8f9fa;
      }

      body.dark-mode .form-group input,
      body.dark-mode .form-group textarea,
      body.dark-mode .form-group select {
        background-color: var(--light-gray);
        color: var(--dark);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        border-color: var(--primary);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 4px rgba(74, 108, 247, 0.2);
      }

      body.dark-mode .form-group input:focus,
      body.dark-mode .form-group textarea:focus,
      body.dark-mode .form-group select:focus {
        background-color: var(--light-gray);
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-btn {
        display: block;
        padding: 40px 20px;
        background: rgba(74, 108, 247, 0.05);
        color: var(--primary);
        border: 3px dashed var(--primary);
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
      }

      .file-input-btn:hover {
        background: rgba(74, 108, 247, 0.1);
        border-color: var(--primary-dark);
      }

      .file-input-btn i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }

      .file-input-btn h3 {
        font-size: 18px;
        margin-bottom: 10px;
        color: var(--text);
      }

      .file-input-btn p {
        color: var(--text-light);
        font-size: 14px;
        margin-bottom: 5px;
      }

      .submit-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px 30px;
        border-radius: 10px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .submit-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(74, 108, 247, 0.3);
      }

      .submit-btn.secondary {
        background: transparent;
        color: var(--text);
        border: 2px solid #e0e0e0;
      }

      .submit-btn.secondary:hover {
        background: #f8f9fa;
        border-color: var(--primary);
      }

      .content-list {
        list-style: none;
        margin-top: 20px;
      }

      .content-item {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
        border-radius: 10px;
        margin-bottom: 10px;
      }

      body.dark-mode .content-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .content-item:hover {
        background: rgba(74, 108, 247, 0.05);
      }

      .content-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .content-name {
        font-weight: 600;
        color: var(--text);
        font-size: 17px;
        margin-bottom: 5px;
      }

      .content-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        color: var(--text-light);
        font-size: 14px;
      }

      .content-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .content-btn {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .content-btn:hover {
        background: rgba(74, 108, 247, 0.2);
      }

      /* أزرار خاصة */
      .download-btn {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .download-btn:hover {
        background: rgba(46, 204, 113, 0.2);
      }

      .grade-btn {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .grade-btn:hover {
        background: rgba(155, 89, 182, 0.2);
      }

      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
      }

      .badge-pending {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .badge-submitted {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .badge-graded {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
      }

      .badge-late {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .badge-approved {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .badge-rejected {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .attendance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: var(--shadow);
      }

      .attendance-table th,
      .attendance-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        text-align: center;
      }

      body.rtl .attendance-table th,
      body.rtl .attendance-table td {
        text-align: right;
      }

      body.ltr .attendance-table th,
      body.ltr .attendance-table td {
        text-align: left;
      }

      body.dark-mode .attendance-table th,
      body.dark-mode .attendance-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .attendance-table th {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
        font-weight: 600;
      }

      .attendance-table tr:hover {
        background: rgba(74, 108, 247, 0.05);
      }

      .status-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
      }

      .status-present {
        background: rgba(0, 184, 148, 0.1);
        color: #00b894;
      }

      .status-absent {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .status-late {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .status-btn:hover {
        opacity: 0.8;
        transform: translateY(-2px);
      }

      .status-btn.active {
        box-shadow: 0 0 0 2px currentColor;
      }

      .chart-container {
        margin-top: 20px;
        height: 350px;
        position: relative;
      }

      .message-area {
        width: 100%;
        height: 150px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: var(--transition);
        background-color: #f8f9fa;
        resize: vertical;
        font-family: "Tajawal", "Segoe UI", sans-serif;
      }

      body.dark-mode .message-area {
        background-color: var(--light-gray);
        color: var(--dark);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .message-area:focus {
        border-color: var(--primary);
        background-color: white;
        outline: none;
        box-shadow: 0 0 0 4px rgba(74, 108, 247, 0.2);
      }

      body.dark-mode .message-area:focus {
        background-color: var(--light-gray);
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid rgba(74, 108, 247, 0.1);
        margin-bottom: 25px;
      }

      .tab {
        padding: 15px 25px;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-light);
        transition: var(--transition);
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
      }

      .tab:hover {
        color: var(--primary);
      }

      .tab.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .file-preview {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px dashed #e0e0e0;
      }

      body.dark-mode .file-preview {
        background: var(--light-gray);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .file-preview img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
      }

      .progress-bar {
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        margin-top: 10px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border-radius: 5px;
        transition: width 0.5s ease;
      }

      /* معاينة الملفات */
      .file-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      body.dark-mode .file-info {
        background: rgba(255, 255, 255, 0.05);
      }

      /* تصفية */
      .filter-container {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      /* رسومات */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-light);
      }

      .empty-state i {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ddd;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: var(--text);
      }

      /* تحميل */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(74, 108, 247, 0.2);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* تحسينات الوصول */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* تحسينات لمعاينة الملفات */
      .image-preview {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: block;
        margin: 0 auto;
      }

      /* تحسينات لنافذة رفع التحضير */
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-group label {
        cursor: pointer;
        font-weight: normal;
      }

      .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      /* إشعارات */
      .toast-message {
        position: fixed;
        top: 30px;
        z-index: 3000;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 400px;
        font-weight: 500;
      }

      body.rtl .toast-message {
        right: 30px;
      }

      body.ltr .toast-message {
        left: 30px;
      }

      .toast-success {
        background: #00b894;
        color: white;
        border-left: 5px solid #00a085;
      }

      .toast-error {
        background: #e74c3c;
        color: white;
        border-left: 5px solid #c0392b;
      }

      .toast-info {
        background: #3498db;
        color: white;
        border-left: 5px solid #2980b9;
      }

      .toast-warning {
        background: #fdcb6e;
        color: #333;
        border-left: 5px solid #f39c12;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }

      /* تنسيق نافذة التقييم */
      .grade-input {
        width: 100px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
      }

      .grade-container {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      body.dark-mode .grade-container {
        background: rgba(255, 255, 255, 0.05);
      }

      /* تحسينات رفع الملفات */
      .remove-file {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-file:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      /* التصميم المتجاوب */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
      }

      @media (max-width: 992px) {
        .sidebar {
          width: 90px;
          padding: 15px 0;
        }

        .sidebar-header .logo-text,
        .user-info,
        .menu-item span,
        .sidebar-footer .menu-item span {
          display: none;
        }

        .logo {
          width: 60px;
          height: 60px;
        }

        .user-type {
          display: none;
        }

        body.rtl .main-content {
          margin-right: 90px;
        }

        body.ltr .main-content {
          margin-left: 90px;
        }

        .menu-item a {
          justify-content: center;
          padding: 15px 10px;
        }

        .menu-item i {
          margin: 0;
          font-size: 22px;
        }

        .notification-badge {
          top: 8px;
          width: 18px;
          height: 18px;
          font-size: 10px;
        }

        body.rtl .notification-badge {
          left: 8px;
        }

        body.ltr .notification-badge {
          right: 8px;
        }

        .main-content {
          padding: 20px;
        }
      }

      @media (max-width: 768px) {
        .stats-cards {
          grid-template-columns: 1fr;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .header {
          flex-direction: column;
          gap: 20px;
          text-align: center;
        }

        .header-actions {
          flex-wrap: wrap;
          justify-content: center;
        }

        .content-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .content-actions {
          align-self: stretch;
          justify-content: flex-end;
        }

        .modal-content {
          padding: 25px;
          width: 95%;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .assignment-types {
          flex-direction: column;
        }
      }

      @media (max-width: 576px) {
        .main-content {
          padding: 15px;
        }

        .modal-content {
          padding: 20px;
          width: 100%;
        }

        .sidebar {
          width: 80px;
        }

        body.rtl .main-content {
          margin-right: 80px;
        }

        body.ltr .main-content {
          margin-left: 80px;
        }

        .stats-cards {
          gap: 15px;
        }

        .stat-card {
          padding: 20px;
        }

        .stat-icon {
          width: 60px;
          height: 60px;
          font-size: 24px;
        }

        .stat-value {
          font-size: 28px;
        }

        .form-actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body class="rtl">
    <div class="dashboard-container">
      <!-- الشريط الجانبي -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="logo-container">
            <div class="logo">
              <img src="logo.png" alt="Logo" />
            </div>
          </div>
          <div class="logo-text">DT Edu</div>
          <div class="user-info">
            <div class="user-name" id="user-name">أحمد المعلم</div>
            <div class="user-type" id="user-type">معلم رياضيات</div>
          </div>
        </div>

        <ul class="sidebar-menu">
          <li class="menu-item active">
            <a href="teacher-dashboard.html">
              <i class="fas fa-home"></i>
              <span id="menu-dashboard">لوحة التحكم</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="teacher-schedule.html">
              <i class="fas fa-calendar-alt"></i>
              <span id="menu-schedule">الجدول الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="teacher-courses.html">
              <i class="fas fa-book"></i>
              <span id="menu-courses">المقررات الدراسية</span>
              <span class="notification-badge">3</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="classroom.html">
              <i class="fas fa-chalkboard"></i>
              <span>الفصل الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="teacher-progress.html">
              <i class="fas fa-chart-bar"></i>
              <span id="menu-progress">التقدم الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="teacher-messages.html">
              <i class="fas fa-comments"></i>
              <span id="menu-messages">الرسائل</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="teacher-settings.html">
              <i class="fas fa-cog"></i>
              <span id="menu-settings">الإعدادات</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <ul class="sidebar-menu">
            <li class="menu-item">
              <a href="#" id="sidebar-dark-mode-toggle" style="display: none">
                <i class="fas fa-moon"></i>
                <span id="dark-mode-text">الوضع الداكن</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="#" id="logout-link">
                <i class="fas fa-sign-out-alt"></i>
                <span id="logout-text">تسجيل الخروج</span>
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- المحتوى الرئيسي -->
      <div class="main-content">
        <div class="header">
          <div>
            <h1 id="header-title">لوحة تحكم المعلم</h1>
            <div class="header-subtitle" id="header-subtitle">
              مرحباً بعودتك! إليك نظرة عامة على فصلك الدراسي
            </div>
          </div>
          <div class="header-actions">
            <button
              class="dark-mode-toggle"
              id="header-dark-mode-toggle"
              style="display: none"
            >
              <i class="fas fa-moon"></i>
              <span id="dark-mode-btn-text">الوضع الداكن</span>
            </button>
            <button class="logout-btn" id="header-logout-btn">
              <i class="fas fa-sign-out-alt"></i>
              <span id="header-logout-text">تسجيل الخروج</span>
            </button>
          </div>
        </div>

        <!-- محتوى خاص بالمعلم -->
        <div id="teacher-content" class="user-specific-content active">
          <!-- بطاقات الإحصائيات للمعلم -->
          <div class="stats-cards">
            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
              >
                <i class="fas fa-user-check"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="attendance-value">94%</div>
                <div class="stat-label" id="teacher-attendance-stat">
                  نسبة حضور الفصل
                </div>
                <div class="stat-change positive">
                  <i class="fas fa-arrow-up"></i>
                  <span>2% عن الأسبوع الماضي</span>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #00b894, #00a085)"
              >
                <i class="fas fa-tasks"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="homework-value">
                  <span id="submitted-homeworks">18</span>/<span
                    id="total-homeworks"
                    >24</span
                  >
                </div>
                <div class="stat-label" id="teacher-homework-stat">
                  الواجبات المسلمة
                </div>
                <div class="stat-change positive">
                  <i class="fas fa-arrow-up"></i>
                  <span>3 واجبات جديدة</span>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #fd79a8, #e84393)"
              >
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="progress-value">87%</div>
                <div class="stat-label" id="teacher-progress-stat">
                  متوسط تقدم الطلاب
                </div>
                <div class="stat-change positive">
                  <i class="fas fa-arrow-up"></i>
                  <span>5% هذا الشهر</span>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #fdcb6e, #e17055)"
              >
                <i class="fas fa-file-upload"></i>
              </div>
              <div class="stat-info">
                <div class="stat-value" id="prep-count">7</div>
                <div class="stat-label" id="teacher-prep-stat">
                  ملفات التحضير المرفوعة
                </div>
                <div class="stat-change">
                  <i class="fas fa-clock"></i>
                  <span>3 قيد المراجعة</span>
                </div>
              </div>
            </div>
          </div>

          <!-- الشبكة الرئيسية للمعلم -->
          <div class="dashboard-grid">
            <!-- بطاقة 1: رفع ملفات التحضير للمدير -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #4a6cf7, #6c5ce7)"
                >
                  <i class="fas fa-file-upload"></i>
                </div>
                <div class="card-title" id="teacher-prep-card">
                  رفع ملفات التحضير للمدير
                </div>
              </div>
              <div class="card-content" id="teacher-prep-desc">
                رفع ملفات التحضير اليومية والخطة الدراسية للمراجعة والموافقة من
                قبل المدير.
                <div class="card-badge badge-pending" id="prep-pending-badge">
                  3 ملفات قيد المراجعة
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="teacher-prep-btn"
                  onclick="openUploadPrepModal()"
                >
                  <i class="fas fa-upload"></i>
                  <span>رفع تحضير جديد</span>
                </button>
                <button
                  class="card-btn secondary"
                  onclick="openPrepStatusModal()"
                  style="margin-right: 10px"
                >
                  <i class="fas fa-history"></i>
                  <span>حالة الرفع</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 2: رفع الواجبات والامتحانات للطلاب -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #00b894, #00a085)"
                >
                  <i class="fas fa-tasks"></i>
                </div>
                <div class="card-title" id="teacher-homework-card">
                  رفع الواجبات والامتحانات
                </div>
              </div>
              <div class="card-content" id="teacher-homework-desc">
                رفع الواجبات المنزلية والامتحانات والمشروعات للطلاب وتحديد
                مواعيد التسليم والدرجات.
                <div class="card-badge badge-submitted" id="hw-active-badge">
                  5 واجبات نشطة
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="teacher-homework-btn"
                  onclick="openHomeworkModal()"
                >
                  <i class="fas fa-plus-circle"></i>
                  <span>إنشاء واجب جديد</span>
                </button>
                <button
                  class="card-btn secondary"
                  onclick="openExamsModal()"
                  style="margin-right: 10px"
                >
                  <i class="fas fa-file-alt"></i>
                  <span>رفع امتحان</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 3: استلام وتقييم واجبات الطلاب -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #3498db, #2980b9)"
                >
                  <i class="fas fa-file-download"></i>
                </div>
                <div class="card-title" id="teacher-submitted-card">
                  استلام وتقييم واجبات الطلاب
                </div>
              </div>
              <div class="card-content" id="teacher-submitted-desc">
                عرض وتحميل وتقييم الواجبات التي رفعها الطلاب. يمكنك تنزيل
                الملفات وتقييمها وإرسال الملاحظات.
                <div style="margin-top: 15px">
                  <span
                    class="badge badge-pending"
                    id="pending-assignments-badge"
                    >8 واجبات قيد الانتظار</span
                  >
                  <span class="badge badge-late" style="margin-right: 5px"
                    >3 واجبات متأخرة</span
                  >
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="teacher-submitted-btn"
                  onclick="openSubmittedModal()"
                >
                  <i class="fas fa-eye"></i>
                  <span>عرض الواجبات المرفوعة</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 4: متابعة حضور الطلاب -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fd79a8, #e84393)"
                >
                  <i class="fas fa-user-graduate"></i>
                </div>
                <div class="card-title" id="teacher-students-card">
                  متابعة حضور الطلاب
                </div>
              </div>
              <div class="card-content" id="teacher-students-desc">
                تسجيل ومتابعة حضور الطلاب داخل الفصل، وتدوين الغياب والتأخير،
                وإنشاء تقارير الحضور.
                <div class="progress-bar" style="margin-top: 15px">
                  <div class="progress-fill" style="width: 94%"></div>
                </div>
                <div
                  style="
                    margin-top: 5px;
                    font-size: 14px;
                    color: var(--text-light);
                  "
                >
                  نسبة الحضور هذا الأسبوع: 94%
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="teacher-students-btn"
                  onclick="openAttendanceModal()"
                >
                  <i class="fas fa-clipboard-check"></i>
                  <span>تسجيل الحضور اليوم</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 5: أرشيف الملفات والدروس -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #fdcb6e, #e17055)"
                >
                  <i class="fas fa-archive"></i>
                </div>
                <div class="card-title" id="teacher-archive-card">
                  أرشيف الملفات والدروس
                </div>
              </div>
              <div class="card-content" id="teacher-archive-desc">
                الوصول إلى الأرشيف الكامل للملفات التي رفعتها: التحضير،
                الواجبات، الامتحانات، العروض التقديمية، والموارد التعليمية.
                <div
                  class="card-badge"
                  style="
                    background: rgba(108, 92, 231, 0.1);
                    color: #6c5ce7;
                    margin-top: 10px;
                  "
                >
                  <i class="fas fa-database"></i> 42 ملفاً مخزناً
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="teacher-archive-btn"
                  onclick="openArchiveModal()"
                >
                  <i class="fas fa-folder-open"></i>
                  <span>فتح الأرشيف</span>
                </button>
                <button
                  class="card-btn secondary"
                  onclick="openUploadResourceModal()"
                  style="margin-right: 10px"
                >
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>رفع مورد تعليمي</span>
                </button>
              </div>
            </div>

            <!-- بطاقة 6: إحصائيات وتقارير -->
            <div class="dashboard-card">
              <div class="card-header">
                <div
                  class="card-icon"
                  style="background: linear-gradient(135deg, #a29bfe, #6c5ce7)"
                >
                  <i class="fas fa-chart-bar"></i>
                </div>
                <div class="card-title" id="teacher-stats-card">
                  إحصائيات وتقارير
                </div>
              </div>
              <div class="card-content" id="teacher-stats-desc">
                عرض إحصائيات تفصيلية عن تفاعل الطلاب مع المواد، أداء الطلاب،
                نسبة إنجاز الواجبات، وتقارير الحضور.
                <div class="card-badge badge-graded" style="margin-top: 10px">
                  <i class="fas fa-chart-line"></i> 15 تقريراً جاهزاً
                </div>
              </div>
              <div class="card-actions">
                <button
                  class="card-btn"
                  id="teacher-stats-btn"
                  onclick="openStatisticsModal()"
                >
                  <i class="fas fa-chart-pie"></i>
                  <span>عرض الإحصائيات</span>
                </button>
                <button
                  class="card-btn secondary"
                  onclick="generateReport()"
                  style="margin-right: 10px"
                >
                  <i class="fas fa-file-export"></i>
                  <span>تصدير تقرير</span>
                </button>
              </div>
            </div>
          </div>

          <!-- قسم الفصل الدراسي -->
          <div class="classroom-section">
            <h2 class="classroom-title" id="classroom-title">
              الفصل الدراسي التفاعلي
            </h2>
            <p class="classroom-description" id="classroom-desc">
              انضم إلى الفصل الدراسي التفاعلي للاستفادة من الدروس الحية، التفاعل
              المباشر مع الطلاب، مشاركة الشاشة، والسبورة التفاعلية. يمكنك بدء
              درس مباشر الآن أو جدولة درس مستقبلي.
            </p>
            <div
              style="
                display: flex;
                gap: 15px;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 20px;
              "
            >
              <button class="classroom-btn" id="classroom-btn">
                <i class="fas fa-door-open"></i>
                <span>الدخول إلى الفصل الدراسي</span>
              </button>
              <button
                class="classroom-btn"
                style="background: linear-gradient(135deg, #00b894, #00a085)"
                onclick="scheduleClass()"
              >
                <i class="fas fa-calendar-plus"></i>
                <span>جدولة درس جديد</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================================== -->
    <!-- النوافذ المنبثقة - النظام المتكامل -->
    <!-- =========================================== -->

    <!-- نافذة رفع ملفات التحضير للمدير (النموذج الجديد) -->
    <div id="upload-prep-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('upload-prep-modal')"
          >&times;</span
        >
        <h2 class="modal-title">
          <i class="fas fa-file-upload"></i> رفع ملفات التحضير للمدير
        </h2>
        <div class="modal-subtitle">
          ارفع ملفات التحضير اليومية والخطة الدراسية للمراجعة والموافقة من قبل
          المدير
        </div>

        <div class="prep-form-container">
          <form id="upload-prep-form">
            <!-- نوع الملف -->
            <div class="form-group">
              <label><span class="required">*</span> نوع الملف:</label>
              <div class="assignment-types">
                <div class="type-option active" data-type="preparation">
                  <i class="fas fa-file-alt"></i>
                  <span>تحضير يومي</span>
                </div>
                <div class="type-option" data-type="plan">
                  <i class="fas fa-calendar-alt"></i>
                  <span>خطة دراسية</span>
                </div>
                <div class="type-option" data-type="other">
                  <i class="fas fa-folder"></i>
                  <span>ملفات أخرى</span>
                </div>
              </div>
              <input
                type="hidden"
                id="prepType"
                name="prepType"
                value="preparation"
                required
              />
            </div>

            <!-- المادة الدراسية -->
            <div class="form-group">
              <label for="prepSubject"
                ><span class="required">*</span> المادة الدراسية:</label
              >
              <select id="prepSubject" name="prepSubject" required>
                <option value="">اختر المادة الدراسية</option>
                <option value="math">الرياضيات</option>
                <option value="arabic">اللغة العربية</option>
                <option value="science">العلوم</option>
                <option value="english">الإنجليزية</option>
                <option value="history">التاريخ</option>
                <option value="geography">الجغرافيا</option>
                <option value="islamic">التربية الإسلامية</option>
                <option value="art">الفنون</option>
              </select>
            </div>

            <!-- عنوان التحضير -->
            <div class="form-group">
              <label for="prepTitle"
                ><span class="required">*</span> عنوان التحضير:</label
              >
              <input
                type="text"
                id="prepTitle"
                name="prepTitle"
                placeholder="مثال: تحضير درس المعادلات التربيعية"
                required
              />
            </div>

            <!-- الصف والفصل -->
            <div class="form-row">
              <div class="form-group">
                <label for="prepGrade"
                  ><span class="required">*</span> الصف:</label
                >
                <select id="prepGrade" name="prepGrade" required>
                  <option value="">اختر الصف</option>
                  <option value="10">الصف العاشر</option>
                  <option value="11">الصف الحادي عشر</option>
                  <option value="12">الصف الثاني عشر</option>
                </select>
              </div>

              <div class="form-group">
                <label for="prepClass"
                  ><span class="required">*</span> الفصل:</label
                >
                <select id="prepClass" name="prepClass" required>
                  <option value="">اختر الفصل</option>
                  <option value="a">الفصل أ</option>
                  <option value="b">الفصل ب</option>
                  <option value="c">الفصل ج</option>
                  <option value="d">الفصل د</option>
                </select>
              </div>
            </div>

            <!-- تاريخ الدرس -->
            <div class="form-group">
              <label for="prepDate"
                ><span class="required">*</span> تاريخ الدرس:</label
              >
              <input type="date" id="prepDate" name="prepDate" required />
            </div>

            <!-- وصف التحضير -->
            <div class="form-group">
              <label for="prepDescription">وصف التحضير:</label>
              <textarea
                id="prepDescription"
                name="prepDescription"
                rows="4"
                placeholder="وصف موجز للتحضير..."
              ></textarea>
            </div>

            <!-- رفع الملف -->
            <div class="form-group">
              <label><span class="required">*</span> ملف التحضير:</label>
              <div class="file-input-wrapper">
                <div class="file-input-btn" id="fileUploadArea">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <h3>انقر لرفع ملف التحضير</h3>
                  <p>PDF, DOCX, PPTX, صور</p>
                  <p>الحجم الأقصى: 10MB</p>
                  <input
                    type="file"
                    id="prepFile"
                    name="prepFile"
                    accept=".pdf,.docx,.pptx,.jpg,.jpeg,.png"
                    style="display: none"
                    required
                  />
                </div>
              </div>

              <div id="filePreview" class="file-preview">
                <!-- سيتم تعبئته بالجافاسكريبت -->
              </div>
            </div>

            <!-- إرسال إشعار -->
            <div class="checkbox-group">
              <input
                type="checkbox"
                id="notifyManager"
                name="notifyManager"
                checked
              />
              <label for="notifyManager"
                >إرسال إشعار للمدير بالتحضير الجديد</label
              >
            </div>

            <!-- أزرار الإجراء -->
            <div class="form-actions">
              <button type="submit" class="submit-btn">
                <i class="fas fa-upload"></i>
                رفع التحضير للمدير
              </button>
              <button
                type="button"
                class="submit-btn secondary"
                onclick="closeModal('upload-prep-modal')"
              >
                <i class="fas fa-times"></i>
                إلغاء
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- نافذة حالة رفع التحضير -->
    <div id="prep-status-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('prep-status-modal')"
          >&times;</span
        >
        <h2 class="modal-title">حالة رفع التحضير</h2>
        <div class="modal-subtitle">
          عرض سجل رفع ملفات التحضير وحالة المراجعة
        </div>

        <div class="tabs">
          <div
            class="tab active"
            onclick="switchTab('prep-status-tab', 'pending')"
          >
            قيد المراجعة
          </div>
          <div class="tab" onclick="switchTab('prep-status-tab', 'approved')">
            مقبولة
          </div>
          <div class="tab" onclick="switchTab('prep-status-tab', 'rejected')">
            مرفوضة
          </div>
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label for="prep-status-search">بحث:</label>
            <input
              type="text"
              id="prep-status-search"
              placeholder="ابحث عن تحضير..."
              onkeyup="filterPrepStatus()"
            />
          </div>
          <div class="filter-group">
            <label for="prep-status-subject">المادة:</label>
            <select id="prep-status-subject" onchange="filterPrepStatus()">
              <option value="all">جميع المواد</option>
              <option value="math">الرياضيات</option>
              <option value="arabic">اللغة العربية</option>
              <option value="science">العلوم</option>
              <option value="english">الإنجليزية</option>
            </select>
          </div>
        </div>

        <div id="prep-status-content">
          <ul class="content-list" id="prep-status-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>

          <div class="empty-state" id="prep-status-empty" style="display: none">
            <i class="fas fa-file-alt"></i>
            <h3>لا توجد ملفات تحضير</h3>
            <p>ابدأ برفع ملفات التحضير الأولى</p>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة رفع الواجبات والامتحانات -->
    <div id="homework-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('homework-modal')"
          >&times;</span
        >
        <h2 class="modal-title">رفع واجب/امتحان للطلاب</h2>
        <div class="modal-subtitle">
          أنشئ واجباً أو امتحاناً جديداً وارفعه للطلاب
        </div>

        <div class="tabs">
          <div
            class="tab active"
            onclick="switchTab('homework-tab', 'assignment')"
          >
            واجب
          </div>
          <div class="tab" onclick="switchTab('homework-tab', 'exam')">
            امتحان
          </div>
          <div class="tab" onclick="switchTab('homework-tab', 'project')">
            مشروع
          </div>
        </div>

        <div id="assignment-tab" class="tab-content active">
          <form id="homework-form">
            <div class="form-group">
              <label for="hw-type">نوع الواجب *</label>
              <select id="hw-type" required>
                <option value="homework">واجب منزلي</option>
                <option value="quiz">اختبار قصير</option>
                <option value="exercise">تمرين</option>
              </select>
            </div>

            <div class="form-group">
              <label for="hw-title">عنوان الواجب *</label>
              <input
                type="text"
                id="hw-title"
                placeholder="مثال: واجب المعادلات الخطية"
                required
              />
            </div>

            <div class="form-group">
              <label for="hw-subject">المادة الدراسية *</label>
              <select id="hw-subject" required>
                <option value="">اختر المادة</option>
                <option value="math">الرياضيات</option>
                <option value="arabic">اللغة العربية</option>
                <option value="science">العلوم</option>
                <option value="english">الإنجليزية</option>
                <option value="history">التاريخ</option>
              </select>
            </div>

            <div class="form-group">
              <label for="hw-class">الفصل المستهدف *</label>
              <select id="hw-class" required>
                <option value="">اختر الفصل</option>
                <option value="10a">الصف العاشر - أ</option>
                <option value="10b">الصف العاشر - ب</option>
                <option value="11a">الصف الحادي عشر - أ</option>
                <option value="11b">الصف الحادي عشر - ب</option>
                <option value="12a">الصف الثاني عشر - أ</option>
              </select>
            </div>

            <div class="form-group">
              <label for="hw-description">وصف الواجب *</label>
              <textarea
                id="hw-description"
                rows="4"
                placeholder="أدخل وصفاً مفصلاً للواجب والمطلوب من الطلاب..."
                required
              ></textarea>
            </div>

            <div class="form-group">
              <label for="hw-due-date">موعد التسليم *</label>
              <input type="datetime-local" id="hw-due-date" required />
            </div>

            <div class="form-group">
              <label for="hw-max-grade">الدرجة الكاملة *</label>
              <input
                type="number"
                id="hw-max-grade"
                min="1"
                max="100"
                value="100"
                required
              />
            </div>

            <div class="form-group">
              <label for="hw-file">ملف الواجب (اختياري)</label>
              <div class="file-input-wrapper">
                <div class="file-input-btn">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>انقر لرفع ملف الواجب (PDF, DOCX, صور)</span>
                </div>
                <input
                  type="file"
                  id="hw-file"
                  accept=".pdf,.docx,.jpg,.jpeg,.png,.zip"
                />
              </div>
              <small
                id="hw-file-name"
                style="
                  display: block;
                  margin-top: 8px;
                  color: var(--text-light);
                "
              ></small>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="hw-notify" checked />
                <span style="margin-right: 8px"
                  >إرسال إشعار للطلاب بالواجب الجديد</span
                >
              </label>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px">
              <button type="submit" class="submit-btn">
                <i class="fas fa-plus-circle"></i>
                <span>إنشاء ورفع الواجب</span>
              </button>
              <button
                type="button"
                class="submit-btn secondary"
                onclick="closeModal('homework-modal')"
              >
                إلغاء
              </button>
            </div>
          </form>
        </div>

        <div id="exam-tab" class="tab-content">
          <form id="exam-form">
            <div class="form-group">
              <label for="exam-title">عنوان الامتحان *</label>
              <input
                type="text"
                id="exam-title"
                placeholder="مثال: امتحان منتصف الفصل في الرياضيات"
                required
              />
            </div>

            <div class="form-group">
              <label for="exam-subject">المادة الدراسية *</label>
              <select id="exam-subject" required>
                <option value="">اختر المادة</option>
                <option value="math">الرياضيات</option>
                <option value="arabic">اللغة العربية</option>
                <option value="science">العلوم</option>
                <option value="english">الإنجليزية</option>
              </select>
            </div>

            <div class="form-group">
              <label for="exam-date">موعد الامتحان *</label>
              <input type="datetime-local" id="exam-date" required />
            </div>

            <div class="form-group">
              <label for="exam-duration">مدة الامتحان (دقائق) *</label>
              <input
                type="number"
                id="exam-duration"
                min="10"
                max="180"
                value="90"
                required
              />
            </div>

            <div class="form-group">
              <label for="exam-file">ملف الامتحان *</label>
              <div class="file-input-wrapper">
                <div class="file-input-btn">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>انقر لرفع ملف الامتحان (PDF, DOCX)</span>
                </div>
                <input
                  type="file"
                  id="exam-file"
                  accept=".pdf,.docx"
                  required
                />
              </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px">
              <button type="submit" class="submit-btn">
                <i class="fas fa-upload"></i>
                <span>رفع الامتحان</span>
              </button>
              <button
                type="button"
                class="submit-btn secondary"
                onclick="closeModal('homework-modal')"
              >
                إلغاء
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- نافذة الواجبات المرفوعة من الطلاب -->
    <div id="submitted-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('submitted-modal')"
          >&times;</span
        >
        <h2 class="modal-title">الواجبات المرفوعة من الطلاب</h2>
        <div class="modal-subtitle">
          عرض وتحميل وتقييم الواجبات التي رفعها الطلاب
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label for="submitted-filter">حالة التقييم:</label>
            <select id="submitted-filter" onchange="loadSubmittedAssignments()">
              <option value="all">جميع الحالات</option>
              <option value="pending">قيد الانتظار</option>
              <option value="graded">مصححة</option>
              <option value="late">متأخرة</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="submitted-subject">المادة:</label>
            <select
              id="submitted-subject"
              onchange="loadSubmittedAssignments()"
            >
              <option value="all">جميع المواد</option>
              <option value="math">الرياضيات</option>
              <option value="arabic">اللغة العربية</option>
              <option value="science">العلوم</option>
              <option value="english">الإنجليزية</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="submitted-class">الفصل:</label>
            <select id="submitted-class" onchange="loadSubmittedAssignments()">
              <option value="all">جميع الفصول</option>
              <option value="10a">الصف العاشر - أ</option>
              <option value="10b">الصف العاشر - ب</option>
              <option value="11a">الصف الحادي عشر - أ</option>
            </select>
          </div>
        </div>

        <div id="submitted-content">
          <ul class="content-list" id="submitted-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>
        </div>

        <div class="empty-state" id="submitted-empty" style="display: none">
          <i class="fas fa-inbox"></i>
          <h3>لا توجد واجبات مرفوعة</h3>
          <p>لم يقم الطلاب برفع أي واجبات بعد</p>
        </div>
      </div>
    </div>

    <!-- نافذة تقييم الواجب -->
    <div id="grade-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('grade-modal')"
          >&times;</span
        >
        <h2 class="modal-title">تقييم الواجب</h2>

        <div id="grade-content">
          <div id="submission-details">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </div>

          <div class="grade-container">
            <h3 style="margin-bottom: 20px; color: var(--primary)">
              تقييم الواجب
            </h3>

            <div class="form-group">
              <label for="grade-score"
                >الدرجة (من <span id="max-grade">100</span>):</label
              >
              <input
                type="number"
                id="grade-score"
                min="0"
                max="100"
                class="grade-input"
                placeholder="0-100"
                required
              />
              <div class="progress-bar" style="margin-top: 10px">
                <div
                  class="progress-fill"
                  id="grade-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <div class="form-group">
              <label for="grade-feedback">ملاحظات التقييم:</label>
              <textarea
                id="grade-feedback"
                rows="5"
                placeholder="أدخل ملاحظاتك حول الواجب..."
              ></textarea>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px">
              <button class="submit-btn" onclick="saveGrade()">
                <i class="fas fa-check"></i>
                <span>حفظ التقييم</span>
              </button>
              <button
                class="submit-btn secondary"
                onclick="closeModal('grade-modal')"
              >
                إلغاء
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة تسجيل حضور الطلاب -->
    <div id="attendance-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('attendance-modal')"
          >&times;</span
        >
        <h2 class="modal-title">تسجيل حضور الطلاب</h2>
        <div class="modal-subtitle">سجل حضور الطلاب للدرس اليوم</div>

        <div
          style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap"
        >
          <div class="form-group" style="flex: 1; min-width: 200px">
            <label for="attendance-date">تاريخ الحضور</label>
            <input type="date" id="attendance-date" value="" />
          </div>
          <div class="form-group" style="flex: 1; min-width: 200px">
            <label for="attendance-class">الفصل الدراسي</label>
            <select id="attendance-class">
              <option value="10a">الصف العاشر - أ</option>
              <option value="10b">الصف العاشر - ب</option>
              <option value="11a">الصف الحادي عشر - أ</option>
              <option value="11b">الصف الحادي عشر - ب</option>
              <option value="12a">الصف الثاني عشر - أ</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1; min-width: 200px">
            <label for="attendance-period">الحصة الدراسية</label>
            <select id="attendance-period">
              <option value="1">الحصة الأولى</option>
              <option value="2">الحصة الثانية</option>
              <option value="3">الحصة الثالثة</option>
              <option value="4">الحصة الرابعة</option>
              <option value="5">الحصة الخامسة</option>
              <option value="6">الحصة السادسة</option>
            </select>
          </div>
        </div>

        <table class="attendance-table">
          <thead>
            <tr>
              <th>اسم الطالب</th>
              <th>رقم الجلوس</th>
              <th>الحالة</th>
              <th>الإجراء</th>
            </tr>
          </thead>
          <tbody id="attendance-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </tbody>
        </table>

        <div
          style="
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
          "
        >
          <button class="submit-btn" onclick="saveAttendance()">
            <i class="fas fa-save"></i>
            <span>حفظ الحضور</span>
          </button>
          <button class="submit-btn secondary" onclick="markAllPresent()">
            <i class="fas fa-user-check"></i>
            <span>تسجيل الكل حاضرين</span>
          </button>
        </div>
      </div>
    </div>

    <!-- نافذة أرشيف الملفات -->
    <div id="archive-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('archive-modal')"
          >&times;</span
        >
        <h2 class="modal-title">أرشيف الملفات والدروس</h2>
        <div class="modal-subtitle">جميع الملفات التي رفعتها محفوظة هنا</div>

        <div class="tabs">
          <div class="tab active" onclick="switchTab('archive-tab', 'all')">
            جميع الملفات
          </div>
          <div class="tab" onclick="switchTab('archive-tab', 'preparations')">
            ملفات التحضير
          </div>
          <div class="tab" onclick="switchTab('archive-tab', 'homeworks')">
            الواجبات والامتحانات
          </div>
          <div class="tab" onclick="switchTab('archive-tab', 'resources')">
            الموارد التعليمية
          </div>
        </div>

        <div class="filter-container" style="margin-top: 20px">
          <div class="filter-group">
            <label for="archive-search">بحث:</label>
            <input
              type="text"
              id="archive-search"
              placeholder="ابحث عن ملف..."
              onkeyup="searchArchive()"
            />
          </div>
          <div class="filter-group">
            <label for="archive-sort">ترتيب حسب:</label>
            <select id="archive-sort" onchange="loadArchiveList()">
              <option value="newest">الأحدث أولاً</option>
              <option value="oldest">الأقدم أولاً</option>
              <option value="name">الاسم</option>
              <option value="type">النوع</option>
            </select>
          </div>
        </div>

        <div id="archive-content">
          <ul class="content-list" id="archive-list">
            <!-- سيتم تعبئته بالجافاسكريبت -->
          </ul>

          <div class="empty-state" id="archive-empty" style="display: none">
            <i class="fas fa-folder-open"></i>
            <h3>لا توجد ملفات في الأرشيف</h3>
            <p>ابدأ برفع ملفاتك الأولى</p>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة إحصائيات التفاعل -->
    <div id="statistics-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('statistics-modal')"
          >&times;</span
        >
        <h2 class="modal-title">إحصائيات وتقارير التفاعل</h2>
        <div class="modal-subtitle">
          تحليل تفصيلي لأداء الطلاب وتفاعلهم مع المواد
        </div>

        <div class="tabs">
          <div
            class="tab active"
            onclick="switchTab('stats-tab', 'attendance')"
          >
            الحضور
          </div>
          <div class="tab" onclick="switchTab('stats-tab', 'homework')">
            الواجبات
          </div>
          <div class="tab" onclick="switchTab('stats-tab', 'performance')">
            الأداء
          </div>
          <div class="tab" onclick="switchTab('stats-tab', 'engagement')">
            التفاعل
          </div>
        </div>

        <div class="filter-container">
          <div class="filter-group">
            <label for="stats-period">الفترة الزمنية:</label>
            <select id="stats-period" onchange="loadStatisticsChart()">
              <option value="week">آخر أسبوع</option>
              <option value="month">آخر شهر</option>
              <option value="semester">الفصل الدراسي</option>
              <option value="year">السنة الدراسية</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="stats-class">الفصل:</label>
            <select id="stats-class" onchange="loadStatisticsChart()">
              <option value="all">جميع الفصول</option>
              <option value="10a">الصف العاشر - أ</option>
              <option value="10b">الصف العاشر - ب</option>
              <option value="11a">الصف الحادي عشر - أ</option>
            </select>
          </div>
        </div>

        <div id="attendance-stats" class="tab-content active">
          <div class="chart-container">
            <canvas id="attendance-chart"></canvas>
          </div>
        </div>

        <div id="homework-stats" class="tab-content">
          <div class="chart-container">
            <canvas id="homework-chart"></canvas>
          </div>
        </div>

        <div id="performance-stats" class="tab-content">
          <div class="chart-container">
            <canvas id="performance-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة رفع مورد تعليمي -->
    <div id="resource-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('resource-modal')"
          >&times;</span
        >
        <h2 class="modal-title">رفع مورد تعليمي</h2>
        <div class="modal-subtitle">ارفع ملفات تعليمية إضافية للطلاب</div>

        <form id="resource-form">
          <div class="form-group">
            <label for="resource-title">عنوان المورد التعليمي *</label>
            <input
              type="text"
              id="resource-title"
              placeholder="مثال: عرض تقديمي عن الدوال"
              required
            />
          </div>

          <div class="form-group">
            <label for="resource-type">نوع المورد *</label>
            <select id="resource-type" required>
              <option value="">اختر النوع</option>
              <option value="presentation">عرض تقديمي</option>
              <option value="video">فيديو</option>
              <option value="document">مستند</option>
              <option value="worksheet">ورقة عمل</option>
              <option value="link">رابط</option>
              <option value="other">أخرى</option>
            </select>
          </div>

          <div class="form-group">
            <label for="resource-description">وصف المورد</label>
            <textarea
              id="resource-description"
              rows="3"
              placeholder="وصف للمورد التعليمي..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="resource-file">ملف المورد *</label>
            <div class="file-input-wrapper">
              <div class="file-input-btn">
                <i class="fas fa-cloud-upload-alt"></i>
                <span
                  >انقر لرفع المورد التعليمي (PDF, PPTX, DOCX, MP4, صور)</span
                >
              </div>
              <input
                type="file"
                id="resource-file"
                accept=".pdf,.pptx,.docx,.mp4,.jpg,.jpeg,.png"
                required
              />
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-top: 30px">
            <button type="submit" class="submit-btn">
              <i class="fas fa-upload"></i>
              <span>رفع المورد التعليمي</span>
            </button>
            <button
              type="button"
              class="submit-btn secondary"
              onclick="closeModal('resource-modal')"
            >
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- نافذة الرفع الاحتياطي (للملفات النصية) -->
    <div id="fallback-upload" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('fallback-upload')"
          >&times;</span
        >
        <h2 class="modal-title">رفع الملف النصي</h2>
        <div class="modal-subtitle">لرفع الملف، يرجى نسخ محتواه أدناه:</div>

        <div class="form-group">
          <label for="fallback-content">محتوى الملف:</label>
          <textarea
            id="fallback-content"
            rows="10"
            placeholder="الصق محتوى الملف هنا..."
          ></textarea>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 25px">
          <button class="submit-btn" onclick="saveFallbackFile()">
            <i class="fas fa-save"></i>
            <span>حفظ الملف</span>
          </button>
          <button
            class="submit-btn secondary"
            onclick="closeModal('fallback-upload')"
          >
            <i class="fas fa-times"></i>
            <span>إلغاء</span>
          </button>
        </div>
      </div>
    </div>

    <!-- إشعارات الرسائل -->
    <div id="toast-container"></div>

    <script>
      // ============================================
      // النظام المتكامل - JavaScript
      // ============================================

      // البيانات والمتغيرات العامة
      let currentLanguage = localStorage.getItem("currentLanguage") || "ar";
      let darkMode = localStorage.getItem("darkMode") === "true";
      let currentUser = JSON.parse(
        localStorage.getItem("currentUser") ||
          '{"id":"teacher1","name":"أحمد المعلم","type":"teacher","subject":"math","email":"teacher@dtedu.com"}'
      );
      const currentTeacherId = currentUser.id || "teacher1";

      // متغيرات لتتبع الحالة
      let currentSubmissionToGrade = null;
      let currentAttendanceData = {};
      let archiveFiles = [];
      let currentFallbackData = null;
      let currentFallbackType = null;

      // بيانات المثال
      const students = [
        { id: 1, name: "محمد أحمد", class: "10a", seat: "1" },
        { id: 2, name: "أحمد محمود", class: "10a", seat: "2" },
        { id: 3, name: "سارة خالد", class: "10a", seat: "3" },
        { id: 4, name: "فاطمة علي", class: "10a", seat: "4" },
        { id: 5, name: "يوسف إبراهيم", class: "10b", seat: "1" },
        { id: 6, name: "خالد محمد", class: "10b", seat: "2" },
        { id: 7, name: "نورة سعيد", class: "10b", seat: "3" },
        { id: 8, name: "عمر حسن", class: "11a", seat: "1" },
        { id: 9, name: "حسن عمر", class: "11a", seat: "2" },
        { id: 10, name: "ليلى كمال", class: "11a", seat: "3" },
      ];

      const subjects = {
        math: { ar: "الرياضيات", en: "Mathematics" },
        arabic: { ar: "اللغة العربية", en: "Arabic" },
        science: { ar: "العلوم", en: "Science" },
        english: { ar: "الإنجليزية", en: "English" },
        history: { ar: "التاريخ", en: "History" },
        geography: { ar: "الجغرافيا", en: "Geography" },
        islamic: { ar: "التربية الإسلامية", en: "Islamic Education" },
        art: { ar: "الفنون", en: "Arts" },
      };

      const classes = {
        "10a": { ar: "الصف العاشر - أ", en: "10th Grade - A" },
        "10b": { ar: "الصف العاشر - ب", en: "10th Grade - B" },
        "11a": { ar: "الصف الحادي عشر - أ", en: "11th Grade - A" },
        "11b": { ar: "الصف الحادي عشر - ب", en: "11th Grade - B" },
        "12a": { ar: "الصف الثاني عشر - أ", en: "12th Grade - A" },
      };

      // ============================================
      // تهيئة الصفحة
      // ============================================

      document.addEventListener("DOMContentLoaded", function () {
        // تهيئة اللغة والتصميم
        document.body.className = currentLanguage === "ar" ? "rtl" : "ltr";
        if (darkMode) document.body.classList.add("dark-mode");

        // تحديث معلومات المستخدم
        updateUserInfo();

        // تحديث النصوص حسب اللغة
        updateLanguage();

        // تحديث نص الوضع الداكن
        updateDarkModeText();

        // تهيئة الأحداث
        initEvents();

        // تحميل الإحصائيات
        loadTeacherStats();

        // تهيئة البيانات التجريبية
        initSampleData();

        // التحقق من FileSaver.js
        checkFileSaver();

        // تعيين التواريخ الافتراضية
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("prepDate").value = today;
        document.getElementById("attendance-date").value = today;

        // تعيين مواعيد التسليم الافتراضية
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById("hw-due-date").value = nextWeek
          .toISOString()
          .slice(0, 16);

        const twoWeeks = new Date();
        twoWeeks.setDate(twoWeeks.getDate() + 14);
        document.getElementById("exam-date").value = twoWeeks
          .toISOString()
          .slice(0, 16);
      });

      // ============================================
      // وظائف التهيئة
      // ============================================

      function updateUserInfo() {
        if (currentUser.name) {
          document.getElementById("user-name").textContent = currentUser.name;
          document.getElementById("user-type").textContent = currentUser.subject
            ? `معلم ${getSubjectName(currentUser.subject)}`
            : "معلم";
        }
      }

      function initEvents() {
        // إعداد زر الوضع الداكن
        document
          .querySelectorAll(
            "#header-dark-mode-toggle, #sidebar-dark-mode-toggle"
          )
          .forEach((btn) => {
            btn.addEventListener("click", toggleDarkMode);
          });

        // إعداد زر تسجيل الخروج
        document
          .getElementById("logout-link")
          .addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });

        document
          .getElementById("header-logout-btn")
          .addEventListener("click", logout);

        // إعداد زر الفصل الدراسي
        document
          .getElementById("classroom-btn")
          .addEventListener("click", function () {
            showToast("info", "جاري فتح الفصل الدراسي التفاعلي...");
          });

        // إعداد أنواع الملفات لرفع التحضير
        setupTypeSelection();

        // إعداد رفع الملفات للتحضير
        setupFileUpload();

        // إعداد إرسال النموذج للتحضير
        setupFormSubmission();

        // إعداد معالجات الملفات الأخرى
        document
          .getElementById("hw-file")
          .addEventListener("change", function (e) {
            handleFileSelection(e, "hw-file-name");
          });

        document
          .getElementById("exam-file")
          .addEventListener("change", function (e) {
            handleFileSelection(e, "exam-file-name");
          });

        document
          .getElementById("resource-file")
          .addEventListener("change", function (e) {
            handleFileSelection(e, "resource-file-name");
          });

        // إعداد النماذج
        document
          .getElementById("homework-form")
          .addEventListener("submit", submitHomeworkForm);
        document
          .getElementById("exam-form")
          .addEventListener("submit", submitExamForm);
        document
          .getElementById("resource-form")
          .addEventListener("submit", submitResourceForm);

        // تحديث شريط التقدم عند تغيير الدرجة
        document
          .getElementById("grade-score")
          .addEventListener("input", updateGradeProgress);

        // تحديث قائمة الحضور عند تغيير الفصل
        document
          .getElementById("attendance-class")
          .addEventListener("change", loadAttendanceList);

        // تحديث قائمة الواجبات عند تغيير الفلاتر
        document
          .getElementById("submitted-filter")
          .addEventListener("change", loadSubmittedAssignments);
        document
          .getElementById("submitted-subject")
          .addEventListener("change", loadSubmittedAssignments);
        document
          .getElementById("submitted-class")
          .addEventListener("change", loadSubmittedAssignments);
      }

      function setupTypeSelection() {
        const typeOptions = document.querySelectorAll(".type-option");

        typeOptions.forEach((option) => {
          option.addEventListener("click", function () {
            typeOptions.forEach((opt) => opt.classList.remove("active"));
            this.classList.add("active");

            const selectedType = this.getAttribute("data-type");
            document.getElementById("prepType").value = selectedType;

            const submitButton = document.querySelector(
              "#upload-prep-form .submit-btn"
            );
            const typeText = {
              preparation: "تحضير",
              plan: "خطة",
              other: "ملف",
            };

            if (typeText[selectedType]) {
              submitButton.innerHTML = `<i class="fas fa-upload"></i> رفع ${typeText[selectedType]} للمدير`;
            }
          });
        });
      }

      function setupFileUpload() {
        const fileUploadArea = document.getElementById("fileUploadArea");
        const fileInput = document.getElementById("prepFile");
        const filePreview = document.getElementById("filePreview");

        fileUploadArea.addEventListener("click", function () {
          fileInput.click();
        });

        fileInput.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            handleFileSelectionForPrep(file);
          }
        });

        // سحب وإفلات الملفات
        fileUploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          this.style.backgroundColor = "rgba(74, 108, 247, 0.1)";
          this.style.borderColor = "var(--primary-dark)";
        });

        fileUploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          this.style.backgroundColor = "rgba(74, 108, 247, 0.05)";
          this.style.borderColor = "var(--primary)";
        });

        fileUploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          this.style.backgroundColor = "rgba(74, 108, 247, 0.05)";
          this.style.borderColor = "var(--primary)";

          const file = e.dataTransfer.files[0];
          if (file) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelectionForPrep(file);
          }
        });

        function handleFileSelectionForPrep(file) {
          if (file.size > 10 * 1024 * 1024) {
            showToast("error", "حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت");
            fileInput.value = "";
            return;
          }

          const allowedTypes = [
            "application/pdf",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            "image/jpeg",
            "image/jpg",
            "image/png",
          ];

          if (!allowedTypes.includes(file.type)) {
            showToast(
              "error",
              "نوع الملف غير مدعوم. الرجاء رفع ملف PDF، DOCX، PPTX، أو صورة"
            );
            fileInput.value = "";
            return;
          }

          displayFileInfo(file);
        }

        function displayFileInfo(file) {
          const fileSize = formatFileSize(file.size);
          const fileType = getFileTypeText(file.type);
          const fileName = file.name;

          filePreview.innerHTML = `
                    <div class="file-info">
                        <i class="${getFileIcon(file.type)}"></i>
                        <div class="file-details">
                            <h4>${fileName}</h4>
                            <p>${fileType} • ${fileSize}</p>
                        </div>
                        <button type="button" class="remove-file" onclick="removeSelectedFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

          filePreview.classList.add("active");
        }
      }

      function setupFormSubmission() {
        const form = document.getElementById("upload-prep-form");

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          if (!validateForm()) {
            return;
          }

          const formData = collectFormData();
          submitFormData(formData);
        });
      }

      function validateForm() {
        const requiredFields = [
          "prepSubject",
          "prepTitle",
          "prepGrade",
          "prepClass",
          "prepDate",
          "prepFile",
        ];

        let isValid = true;

        requiredFields.forEach((fieldName) => {
          const field = document.getElementById(fieldName);
          if (!field.value.trim()) {
            isValid = false;
            highlightFieldError(field);
          } else {
            removeFieldError(field);
          }
        });

        const fileInput = document.getElementById("prepFile");
        if (!fileInput.files[0]) {
          isValid = false;
          showToast("error", "يجب رفع ملف التحضير");
        }

        return isValid;
      }

      function highlightFieldError(field) {
        field.style.borderColor = "#e74c3c";
        field.style.boxShadow = "0 0 0 4px rgba(231, 76, 60, 0.2)";
      }

      function removeFieldError(field) {
        field.style.borderColor = "";
        field.style.boxShadow = "";
      }

      function collectFormData() {
        const fileInput = document.getElementById("prepFile");
        const file = fileInput.files[0];

        return {
          type: document.getElementById("prepType").value,
          subject: document.getElementById("prepSubject").value,
          title: document.getElementById("prepTitle").value,
          grade: document.getElementById("prepGrade").value,
          class: document.getElementById("prepClass").value,
          date: document.getElementById("prepDate").value,
          description: document.getElementById("prepDescription").value,
          notifyManager: document.getElementById("notifyManager").checked,
          fileName: file.name,
          fileSize: file.size,
          fileType: file.type,
        };
      }

      function submitFormData(formData) {
        const submitButton = document.querySelector(
          "#upload-prep-form .submit-btn"
        );
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
        submitButton.disabled = true;

        setTimeout(() => {
          savePreparationToLocalStorage(formData);
          resetForm();
          showToast(
            "success",
            `تم رفع ${getTypeText(formData.type)} "${formData.title}" بنجاح!`
          );

          submitButton.innerHTML = originalText;
          submitButton.disabled = false;

          setTimeout(() => {
            closeModal("upload-prep-modal");
          }, 2000);
        }, 1500);
      }

      // ============================================
      // وظائف إدارة البيانات
      // ============================================

      function savePreparationToLocalStorage(formData) {
        const fileInput = document.getElementById("prepFile");
        const file = fileInput.files[0];

        const reader = new FileReader();
        reader.onload = function (e) {
          const preparationData = {
            id: Date.now(),
            type: formData.type,
            subject: formData.subject,
            subjectName: getSubjectName(formData.subject),
            title: formData.title,
            grade: formData.grade,
            class: formData.class,
            date: formData.date,
            description: formData.description,
            notifyManager: formData.notifyManager,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            fileContent: e.target.result,
            uploadDate: new Date().toISOString(),
            status: "pending",
            teacherName: currentUser.name,
            teacherId: currentTeacherId,
          };

          const savedPreparations = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          savedPreparations.push(preparationData);
          localStorage.setItem(
            "teacherPreparations",
            JSON.stringify(savedPreparations)
          );

          if (formData.notifyManager) {
            sendNotificationToManager(preparationData);
          }

          updateTeacherStats();
        };

        reader.readAsDataURL(file);
      }

      function sendNotificationToManager(preparationData) {
        const adminNotifications = JSON.parse(
          localStorage.getItem("adminNotifications") || "[]"
        );

        adminNotifications.push({
          id: Date.now(),
          type: "new_preparation",
          title: `ملف تحضير جديد من ${preparationData.teacherName}`,
          message: `تم رفع ملف تحضير للمادة: ${preparationData.subjectName} بتاريخ ${preparationData.date}`,
          data: preparationData,
          read: false,
          date: new Date().toISOString(),
        });

        localStorage.setItem(
          "adminNotifications",
          JSON.stringify(adminNotifications)
        );
      }

      function initSampleData() {
        const hasData = localStorage.getItem("teacherDataInitialized");

        if (!hasData) {
          const sampleData = {
            teacherPreparations: [
              {
                id: 1,
                teacherId: currentTeacherId,
                teacherName: currentUser.name,
                title: "تحضير درس المعادلات التربيعية",
                subject: "math",
                subjectName: "الرياضيات",
                grade: "10",
                class: "a",
                date: "2025-11-10",
                description:
                  "تحضير شامل لدرس المعادلات التربيعية مع أمثلة وتمارين",
                fileName: "تحضير_المعادلات_التربيعية.pdf",
                fileType: "application/pdf",
                fileSize: 2457600,
                uploadDate: new Date("2025-11-09").toISOString(),
                status: "approved",
                reviewedBy: "مدير المدرسة",
                reviewDate: new Date("2025-11-10").toISOString(),
                reviewNotes: "تحضير ممتاز، شكراً للجهود",
              },
            ],

            teacherAssignments: [
              {
                id: 1,
                teacherId: currentTeacherId,
                type: "homework",
                title: "واجب المعادلات الخطية",
                subject: "math",
                subjectName: "الرياضيات",
                class: "10a",
                className: "الصف العاشر - أ",
                description:
                  "حل المعادلات الخطية من التمرين 1 إلى 10 في الصفحة 45",
                dueDate: "2025-11-20T23:59:00",
                maxGrade: 100,
                fileName: "واجب_المعادلات_الخطية.pdf",
                fileType: "application/pdf",
                fileSize: 1234567,
                uploadDate: new Date("2025-11-10").toISOString(),
                status: "active",
                submissions: 5,
                graded: 3,
              },
            ],

            studentSubmissions: [
              {
                id: 1,
                assignmentId: 1,
                studentId: 1,
                studentName: "محمد أحمد",
                fileName: "واجب_المعادلات_محمد.pdf",
                fileType: "application/pdf",
                fileSize: 123456,
                notes: "تم حل جميع التمارين",
                submissionDate: new Date("2025-11-15").toISOString(),
                status: "submitted",
                grade: 95,
                feedback: "عمل ممتاز، جميع الإجابات صحيحة",
                gradeDate: new Date("2025-11-16").toISOString(),
                gradedBy: currentTeacherId,
              },
            ],

            teacherResources: [
              {
                id: 1,
                teacherId: currentTeacherId,
                title: "عرض تقديمي عن الدوال الرياضية",
                type: "presentation",
                description: "عرض تقديمي يشرح أنواع الدوال الرياضية",
                fileName: "عرض_الدوال_الرياضية.pptx",
                fileType:
                  "application/vnd.openxmlformats-officedocument.presentationml.presentation",
                fileSize: 4567890,
                uploadDate: new Date("2025-10-15").toISOString(),
                downloads: 12,
              },
            ],
          };

          localStorage.setItem(
            "teacherPreparations",
            JSON.stringify(sampleData.teacherPreparations)
          );
          localStorage.setItem(
            "teacherAssignments",
            JSON.stringify(sampleData.teacherAssignments)
          );
          localStorage.setItem(
            "studentSubmissions",
            JSON.stringify(sampleData.studentSubmissions)
          );
          localStorage.setItem(
            "teacherResources",
            JSON.stringify(sampleData.teacherResources)
          );
          localStorage.setItem("teacherDataInitialized", "true");
        }
      }

      // ============================================
      // وظائف النوافذ المنبثقة
      // ============================================

      function openUploadPrepModal() {
        document.getElementById("upload-prep-modal").style.display = "flex";
        resetForm();
      }

      function openPrepStatusModal() {
        document.getElementById("prep-status-modal").style.display = "flex";
        switchTab("prep-status-tab", "pending");
        filterPrepStatus();
      }

      function openHomeworkModal() {
        document.getElementById("homework-modal").style.display = "flex";
        switchTab("homework-tab", "assignment");
      }

      function openExamsModal() {
        document.getElementById("homework-modal").style.display = "flex";
        switchTab("homework-tab", "exam");
      }

      function openSubmittedModal() {
        document.getElementById("submitted-modal").style.display = "flex";
        loadSubmittedAssignments();
      }

      function openGradeModal(submissionId) {
        document.getElementById("grade-modal").style.display = "flex";
        loadSubmissionDetails(submissionId);
      }

      function openAttendanceModal() {
        document.getElementById("attendance-modal").style.display = "flex";
        loadAttendanceList();
      }

      function openArchiveModal() {
        document.getElementById("archive-modal").style.display = "flex";
        switchTab("archive-tab", "all");
        loadArchiveList();
      }

      function openStatisticsModal() {
        document.getElementById("statistics-modal").style.display = "flex";
        switchTab("stats-tab", "attendance");
        loadStatisticsChart();
      }

      function openUploadResourceModal() {
        document.getElementById("resource-modal").style.display = "flex";
      }

      function openFallbackUpload(type, data) {
        currentFallbackData = data;
        currentFallbackType = type;

        const textarea = document.getElementById("fallback-content");
        textarea.value = "";

        switch (type) {
          case "preparation":
            textarea.placeholder =
              "أدخل محتوى التحضير هنا...\nمثال:\n1. أهداف الدرس\n2. الوسائل التعليمية\n3. خطوات الشرح\n4. التمارين والأنشطة";
            break;
          case "homework":
            textarea.placeholder =
              "أدخل محتوى الواجب هنا...\nمثال:\nحل التمارين من 1 إلى 10 في الصفحة 45\nتسليم الواجب في موعد أقصاه...";
            break;
          case "exam":
            textarea.placeholder =
              "أدخل محتوى الامتحان هنا...\nمثال:\nالسؤال الأول: ...\nالسؤال الثاني: ...";
            break;
          default:
            textarea.placeholder = "أدخل محتوى الملف هنا...";
        }

        document.getElementById("fallback-upload").style.display = "flex";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // إغلاق النوافذ المنبثقة عند النقر خارجها
      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", function (e) {
          if (e.target === this) {
            this.style.display = "none";
          }
        });
      });

      function switchTab(tabGroup, tabName) {
        const tabContents = document.querySelectorAll(
          `#${tabGroup.replace("-tab", "")}-modal .tab-content`
        );
        const tabs = document.querySelectorAll(
          `#${tabGroup.replace("-tab", "")}-modal .tab`
        );

        tabContents.forEach((content) => content.classList.remove("active"));
        tabs.forEach((tab) => tab.classList.remove("active"));

        const activeContent = document.getElementById(`${tabName}-tab`);
        const activeTab = document.querySelector(
          `#${tabGroup.replace("-tab", "")}-modal .tab[onclick*="${tabName}"]`
        );

        if (activeContent) activeContent.classList.add("active");
        if (activeTab) activeTab.classList.add("active");
      }

      // ============================================
      // وظائف تحميل وعرض البيانات
      // ============================================

      function loadTeacherStats() {
        try {
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          const teacherPreps = savedPreps.filter(
            (prep) => prep.teacherId === currentTeacherId
          );
          const pendingPreps = teacherPreps.filter(
            (prep) => prep.status === "pending"
          );

          document.getElementById("prep-count").textContent =
            teacherPreps.length;

          const prepBadge = document.getElementById("prep-pending-badge");
          if (prepBadge && pendingPreps.length > 0) {
            prepBadge.textContent = `${pendingPreps.length} ملفات قيد المراجعة`;
            prepBadge.style.display = "inline-block";
          } else if (prepBadge) {
            prepBadge.style.display = "none";
          }

          updateSubmittedStats();
        } catch (error) {
          console.error("Error loading teacher stats:", error);
        }
      }

      function updateTeacherStats() {
        loadTeacherStats();
      }

      function updateSubmittedStats() {
        try {
          const teacherHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const teacherAssignments = teacherHomeworks.filter(
            (hw) => hw.teacherId === currentTeacherId
          );
          const allSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );

          let submittedCount = 0;
          let totalAssignments = teacherAssignments.length;
          let pendingCount = 0;

          teacherAssignments.forEach((assignment) => {
            const assignmentSubmissions = allSubmissions.filter(
              (sub) => sub.assignmentId === assignment.id
            );
            if (assignmentSubmissions.length > 0) {
              submittedCount++;
            }

            const pendingSubmissions = assignmentSubmissions.filter(
              (sub) => !sub.grade || sub.grade === null
            );
            pendingCount += pendingSubmissions.length;
          });

          document.getElementById("submitted-homeworks").textContent =
            submittedCount;
          document.getElementById("total-homeworks").textContent =
            totalAssignments;

          const pendingBadge = document.getElementById(
            "pending-assignments-badge"
          );
          if (pendingBadge) {
            if (pendingCount > 0) {
              pendingBadge.textContent = `${pendingCount} واجبات قيد الانتظار`;
              pendingBadge.style.display = "inline-block";
            } else {
              pendingBadge.style.display = "none";
            }
          }

          const activeBadge = document.getElementById("hw-active-badge");
          if (activeBadge) {
            activeBadge.textContent = `${totalAssignments} واجبات نشطة`;
          }
        } catch (error) {
          console.error("Error updating submitted stats:", error);
        }
      }

      function filterPrepStatus() {
        const searchQuery = document
          .getElementById("prep-status-search")
          .value.toLowerCase();
        const subjectFilter = document.getElementById(
          "prep-status-subject"
        ).value;
        const activeTab = document.querySelector(
          "#prep-status-modal .tab.active"
        );
        const statusFilter = activeTab
          ? activeTab.getAttribute("onclick").split("'")[1]
          : "pending";
        const prepStatusList = document.getElementById("prep-status-list");
        const emptyState = document.getElementById("prep-status-empty");

        if (!prepStatusList) return;

        prepStatusList.innerHTML = "";

        const savedPreps = JSON.parse(
          localStorage.getItem("teacherPreparations") || "[]"
        );
        let filteredPreps = savedPreps.filter(
          (prep) => prep.teacherId === currentTeacherId
        );

        if (statusFilter !== "pending") {
          filteredPreps = filteredPreps.filter(
            (prep) => prep.status === statusFilter
          );
        }

        if (subjectFilter !== "all") {
          filteredPreps = filteredPreps.filter(
            (prep) => prep.subject === subjectFilter
          );
        }

        if (searchQuery) {
          filteredPreps = filteredPreps.filter(
            (prep) =>
              prep.title.toLowerCase().includes(searchQuery) ||
              prep.subjectName.toLowerCase().includes(searchQuery)
          );
        }

        filteredPreps.sort(
          (a, b) => new Date(b.uploadDate) - new Date(a.uploadDate)
        );

        if (filteredPreps.length === 0) {
          prepStatusList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          prepStatusList.style.display = "block";
          emptyState.style.display = "none";
        }

        filteredPreps.forEach((prep) => {
          const item = document.createElement("li");
          item.className = "content-item";

          let statusText = "";
          let statusClass = "";

          if (prep.status === "pending") {
            statusText = "قيد المراجعة";
            statusClass = "badge-pending";
          } else if (prep.status === "approved") {
            statusText = "مقبولة";
            statusClass = "badge-approved";
          } else if (prep.status === "rejected") {
            statusText = "مرفوضة";
            statusClass = "badge-rejected";
          }

          const prepDate = new Date(prep.date).toLocaleDateString("ar-SA");
          const uploadDate = new Date(prep.uploadDate).toLocaleDateString(
            "ar-SA"
          );

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">${prep.title}</div>
                        <div class="content-meta">
                            <span><strong>المادة:</strong> ${
                              prep.subjectName
                            }</span>
                            <span><strong>تاريخ الدرس:</strong> ${prepDate}</span>
                            <span><strong>تاريخ الرفع:</strong> ${uploadDate}</span>
                            <span><strong>الحالة:</strong> <span class="badge ${statusClass}">${statusText}</span></span>
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="download-btn" onclick="downloadFile('preparation', ${
                          prep.id
                        })">
                            <i class="fas fa-download"></i>
                            تحميل
                        </button>
                        ${
                          prep.status === "pending"
                            ? `<button class="content-btn" onclick="editPreparation(${prep.id})">
                                <i class="fas fa-edit"></i>
                                تعديل
                            </button>`
                            : ""
                        }
                    </div>
                `;
          prepStatusList.appendChild(item);
        });
      }

      function loadSubmittedAssignments() {
        try {
          const filter = document.getElementById("submitted-filter").value;
          const subjectFilter =
            document.getElementById("submitted-subject").value;
          const classFilter = document.getElementById("submitted-class").value;
          const submittedList = document.getElementById("submitted-list");
          const emptyState = document.getElementById("submitted-empty");

          if (!submittedList) return;

          submittedList.innerHTML = "";

          const allSubmissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const teacherHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );

          const teacherAssignmentIds = teacherHomeworks
            .filter((hw) => hw.teacherId === currentTeacherId)
            .map((hw) => hw.id);

          let filteredSubmissions = allSubmissions.filter((sub) =>
            teacherAssignmentIds.includes(sub.assignmentId)
          );

          if (subjectFilter !== "all") {
            const subjectAssignments = teacherHomeworks.filter(
              (hw) =>
                hw.subject === subjectFilter &&
                hw.teacherId === currentTeacherId
            );

            const subjectAssignmentIds = subjectAssignments.map((hw) => hw.id);

            filteredSubmissions = filteredSubmissions.filter((sub) =>
              subjectAssignmentIds.includes(sub.assignmentId)
            );
          }

          if (classFilter !== "all") {
            const classAssignments = teacherHomeworks.filter(
              (hw) =>
                hw.class === classFilter && hw.teacherId === currentTeacherId
            );

            const classAssignmentIds = classAssignments.map((hw) => hw.id);

            filteredSubmissions = filteredSubmissions.filter((sub) =>
              classAssignmentIds.includes(sub.assignmentId)
            );
          }

          if (filter === "pending") {
            filteredSubmissions = filteredSubmissions.filter(
              (sub) => !sub.grade || sub.grade === null
            );
          } else if (filter === "graded") {
            filteredSubmissions = filteredSubmissions.filter(
              (sub) => sub.grade && sub.grade !== null
            );
          } else if (filter === "late") {
            filteredSubmissions = filteredSubmissions.filter((sub) => {
              const assignment = teacherHomeworks.find(
                (hw) => hw.id === sub.assignmentId
              );
              if (!assignment) return false;

              const dueDate = new Date(assignment.dueDate);
              const submitDate = new Date(sub.submissionDate);
              return submitDate > dueDate;
            });
          }

          if (filteredSubmissions.length === 0) {
            submittedList.style.display = "none";
            emptyState.style.display = "block";
            return;
          } else {
            submittedList.style.display = "block";
            emptyState.style.display = "none";
          }

          filteredSubmissions.sort(
            (a, b) => new Date(b.submissionDate) - new Date(a.submissionDate)
          );

          filteredSubmissions.forEach((submission) => {
            const assignment = teacherHomeworks.find(
              (hw) => hw.id === submission.assignmentId
            );

            if (!assignment) return;

            const item = document.createElement("li");
            item.className = "content-item";

            let statusText = "";
            let statusClass = "";

            if (submission.grade) {
              statusText = `مصحح: ${submission.grade}/${assignment.maxGrade}`;
              statusClass = "badge-graded";
            } else {
              statusText = "قيد الانتظار";
              statusClass = "badge-pending";
            }

            const dueDate = new Date(assignment.dueDate);
            const submitDate = new Date(submission.submissionDate);
            const isLate = submitDate > dueDate;

            const submissionDate = new Date(
              submission.submissionDate
            ).toLocaleDateString("ar-SA");

            item.innerHTML = `
                        <div style="flex: 1;">
                            <div class="content-name">${assignment.title}</div>
                            <div class="content-meta">
                                <span><strong>الطالب:</strong> ${
                                  submission.studentName
                                }</span>
                                <span><strong>المادة:</strong> ${
                                  assignment.subjectName
                                }</span>
                                <span><strong>الفصل:</strong> ${
                                  assignment.className
                                }</span>
                                <span><strong>تاريخ التسليم:</strong> ${submissionDate}</span>
                                <span><strong>الحالة:</strong> <span class="badge ${statusClass}">${statusText}${
              isLate ? ` (متأخر)` : ""
            }</span></span>
                            </div>
                        </div>
                        <div class="content-actions">
                            <button class="download-btn" onclick="downloadSubmissionFile(${
                              submission.id
                            })">
                                <i class="fas fa-download"></i>
                                تحميل
                            </button>
                            ${
                              !submission.grade
                                ? `<button class="grade-btn" onclick="openGradeModal(${submission.id})">
                                    <i class="fas fa-check-circle"></i>
                                    تقييم
                                </button>`
                                : ""
                            }
                            <button class="content-btn" onclick="viewSubmissionDetails(${
                              submission.id
                            })">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                        </div>
                    `;
            submittedList.appendChild(item);
          });
        } catch (error) {
          console.error("Error loading submitted assignments:", error);
          showToast("error", "حدث خطأ في تحميل الواجبات المرفوعة");
        }
      }

      // ============================================
      // وظائف مساعدة
      // ============================================

      function removeSelectedFile() {
        document.getElementById("prepFile").value = "";
        document.getElementById("filePreview").classList.remove("active");
        document.getElementById("filePreview").innerHTML = "";
      }

      function resetForm() {
        document.getElementById("upload-prep-form").reset();
        document.getElementById("prepDate").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("filePreview").classList.remove("active");
        document.getElementById("filePreview").innerHTML = "";

        document.querySelectorAll(".type-option").forEach((option) => {
          option.classList.remove("active");
        });
        document
          .querySelector('.type-option[data-type="preparation"]')
          .classList.add("active");
        document.getElementById("prepType").value = "preparation";
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";

        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function getFileTypeText(mimeType) {
        const typeMap = {
          "application/pdf": "PDF",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            "مستند Word",
          "application/vnd.openxmlformats-officedocument.presentationml.presentation":
            "عرض تقديمي",
          "image/jpeg": "صورة JPEG",
          "image/jpg": "صورة JPG",
          "image/png": "صورة PNG",
        };

        return typeMap[mimeType] || "ملف";
      }

      function getFileIcon(mimeType) {
        const iconMap = {
          "application/pdf": "fas fa-file-pdf",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            "fas fa-file-word",
          "application/vnd.openxmlformats-officedocument.presentationml.presentation":
            "fas fa-file-powerpoint",
          "image/jpeg": "fas fa-file-image",
          "image/jpg": "fas fa-file-image",
          "image/png": "fas fa-file-image",
        };

        return iconMap[mimeType] || "fas fa-file";
      }

      function getSubjectName(subjectCode) {
        const subject = subjects[subjectCode];
        return subject ? subject.ar : subjectCode;
      }

      function getTypeText(typeCode) {
        const types = {
          preparation: "التحضير",
          plan: "الخطة",
          other: "الملف",
        };

        return types[typeCode] || "الملف";
      }

      function showToast(type, message, duration = 3000) {
        if (!message) return;

        const existingToasts = document.querySelectorAll(".toast-message");
        existingToasts.forEach((toast) => toast.remove());

        const toast = document.createElement("div");
        toast.className = `toast-message toast-${type}`;

        const icon =
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : type === "warning"
            ? "fa-exclamation-triangle"
            : "fa-info-circle";

        toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;

        document.getElementById("toast-container").appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            if (toast.parentNode) toast.remove();
          }, 300);
        }, duration);
      }

      function toggleDarkMode() {
        darkMode = !darkMode;
        localStorage.setItem("darkMode", darkMode);

        if (darkMode) {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        updateDarkModeText();
      }

      function updateDarkModeText() {
        const darkModeText = darkMode ? "الوضع الفاتح" : "الوضع الداكن";

        document.getElementById("dark-mode-text").textContent = darkModeText;
        document.getElementById("dark-mode-btn-text").textContent =
          darkModeText;

        const icons = document.querySelectorAll(
          "#header-dark-mode-toggle i, #sidebar-dark-mode-toggle i"
        );
        icons.forEach((icon) => {
          icon.className = darkMode ? "fas fa-sun" : "fas fa-moon";
        });
      }

      function updateLanguage() {
        // في تطبيق حقيقي، سيتم تحميل النصوص من ملفات الترجمة
      }

      function checkFileSaver() {
        if (typeof saveAs === "undefined") {
          console.warn("FileSaver.js غير محمل، سيتم استخدام الطريقة البديلة");
        }
      }

      // ============================================
      // وظائف النظام المتكامل
      // ============================================

      function loadAttendanceList() {
        const classValue = document.getElementById("attendance-class").value;
        const attendanceList = document.getElementById("attendance-list");

        if (!attendanceList) return;

        attendanceList.innerHTML = "";

        const filteredStudents = students.filter(
          (student) => student.class === classValue
        );
        currentAttendanceData = {};

        filteredStudents.forEach((student) => {
          currentAttendanceData[student.id] = "present";

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.seat}</td>
                    <td id="status-${student.id}">
                        <span class="status-present">حاضر</span>
                    </td>
                    <td>
                        <button class="status-btn status-present active" onclick="setAttendanceStatus(${student.id}, 'present')">
                            حاضر
                        </button>
                        <button class="status-btn status-absent" onclick="setAttendanceStatus(${student.id}, 'absent')">
                            غائب
                        </button>
                        <button class="status-btn status-late" onclick="setAttendanceStatus(${student.id}, 'late')">
                            متأخر
                        </button>
                    </td>
                `;
          attendanceList.appendChild(row);
        });
      }

      function setAttendanceStatus(studentId, status) {
        currentAttendanceData[studentId] = status;

        const statusElement = document.getElementById(`status-${studentId}`);
        const buttons = document.querySelectorAll(
          `#status-${student.id} + td .status-btn`
        );

        if (!statusElement) return;

        const statusText = {
          present: "حاضر",
          absent: "غائب",
          late: "متأخر",
        };

        const statusClass = {
          present: "status-present",
          absent: "status-absent",
          late: "status-late",
        };

        statusElement.innerHTML = `<span class="${statusClass[status]}">${statusText[status]}</span>`;

        buttons.forEach((btn) => {
          btn.classList.remove("active");
          if (btn.textContent.includes(statusText[status])) {
            btn.classList.add("active");
          }
        });
      }

      function markAllPresent() {
        Object.keys(currentAttendanceData).forEach((studentId) => {
          setAttendanceStatus(parseInt(studentId), "present");
        });
      }

      function saveAttendance() {
        const date = document.getElementById("attendance-date").value;
        const classCode = document.getElementById("attendance-class").value;
        const period = document.getElementById("attendance-period").value;

        if (!date || !classCode) {
          showToast("error", "يرجى تحديد التاريخ والفصل");
          return;
        }

        const attendanceRecord = {
          id: Date.now(),
          teacherId: currentTeacherId,
          date: date,
          class: classCode,
          period: period,
          students: currentAttendanceData,
          recordedAt: new Date().toISOString(),
        };

        const attendanceRecords = JSON.parse(
          localStorage.getItem("attendanceRecords") || "[]"
        );
        attendanceRecords.push(attendanceRecord);
        localStorage.setItem(
          "attendanceRecords",
          JSON.stringify(attendanceRecords)
        );

        showToast("success", "تم حفظ بيانات الحضور بنجاح!");
        closeModal("attendance-modal");
        updateAttendanceStats();
      }

      function updateAttendanceStats() {
        const attendanceRecords = JSON.parse(
          localStorage.getItem("attendanceRecords") || "[]"
        );
        const todayRecords = attendanceRecords.filter(
          (record) =>
            record.date === new Date().toISOString().split("T")[0] &&
            record.teacherId === currentTeacherId
        );

        if (todayRecords.length > 0) {
          const latestRecord = todayRecords[todayRecords.length - 1];
          const presentCount = Object.values(latestRecord.students).filter(
            (status) => status === "present"
          ).length;
          const totalCount = Object.keys(latestRecord.students).length;
          const attendanceRate = Math.round((presentCount / totalCount) * 100);

          document.getElementById(
            "attendance-value"
          ).textContent = `${attendanceRate}%`;
        }
      }

      function loadArchiveList() {
        const activeTab = document.querySelector("#archive-modal .tab.active");
        const tabName = activeTab
          ? activeTab.getAttribute("onclick").split("'")[1]
          : "all";
        const searchQuery = document
          .getElementById("archive-search")
          .value.toLowerCase();
        const sortBy = document.getElementById("archive-sort").value;
        const archiveList = document.getElementById("archive-list");
        const emptyState = document.getElementById("archive-empty");

        if (!archiveList) return;

        archiveList.innerHTML = "";

        archiveFiles = [];

        if (tabName === "all" || tabName === "preparations") {
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );
          const teacherPreps = savedPreps.filter(
            (prep) => prep.teacherId === currentTeacherId
          );

          teacherPreps.forEach((prep) => {
            archiveFiles.push({
              id: prep.id,
              type: "preparation",
              title: prep.title,
              subject: prep.subjectName,
              date: prep.date,
              fileName: prep.fileName,
              fileType: prep.fileType,
              fileSize: prep.fileSize,
              uploadDate: prep.uploadDate,
              status: prep.status,
              data: prep,
            });
          });
        }

        if (tabName === "all" || tabName === "homeworks") {
          const savedHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const teacherHomeworks = savedHomeworks.filter(
            (hw) => hw.teacherId === currentTeacherId
          );

          teacherHomeworks.forEach((hw) => {
            archiveFiles.push({
              id: hw.id,
              type: hw.type === "exam" ? "exam" : "assignment",
              title: hw.title,
              subject: hw.subjectName,
              date: hw.uploadDate,
              fileName: hw.fileName || "بدون ملف",
              fileType: hw.fileType,
              fileSize: hw.fileSize,
              uploadDate: hw.uploadDate,
              status: hw.status,
              data: hw,
            });
          });
        }

        if (tabName === "all" || tabName === "resources") {
          const savedResources = JSON.parse(
            localStorage.getItem("teacherResources") || "[]"
          );
          const teacherResources = savedResources.filter(
            (res) => res.teacherId === currentTeacherId
          );

          teacherResources.forEach((res) => {
            archiveFiles.push({
              id: res.id,
              type: "resource",
              title: res.title,
              subject: res.description,
              date: res.uploadDate,
              fileName: res.fileName,
              fileType: res.fileType,
              fileSize: res.fileSize,
              uploadDate: res.uploadDate,
              status: "active",
              data: res,
            });
          });
        }

        if (searchQuery) {
          archiveFiles = archiveFiles.filter(
            (file) =>
              file.title.toLowerCase().includes(searchQuery) ||
              file.subject.toLowerCase().includes(searchQuery) ||
              file.fileName.toLowerCase().includes(searchQuery)
          );
        }

        archiveFiles.sort((a, b) => {
          switch (sortBy) {
            case "newest":
              return new Date(b.uploadDate) - new Date(a.uploadDate);
            case "oldest":
              return new Date(a.uploadDate) - new Date(b.uploadDate);
            case "name":
              return a.title.localeCompare(b.title);
            case "type":
              return a.type.localeCompare(b.type);
            default:
              return 0;
          }
        });

        if (archiveFiles.length === 0) {
          archiveList.style.display = "none";
          emptyState.style.display = "block";
          return;
        } else {
          archiveList.style.display = "block";
          emptyState.style.display = "none";
        }

        archiveFiles.forEach((file) => {
          const item = document.createElement("li");
          item.className = "content-item";

          const typeText = {
            preparation: "تحضير",
            assignment: "واجب",
            exam: "امتحان",
            resource: "مورد تعليمي",
          };

          const typeIcon = {
            preparation: "fa-file-alt",
            assignment: "fa-tasks",
            exam: "fa-file-signature",
            resource: "fa-book",
          };

          const typeColor = {
            preparation: "#4a6cf7",
            assignment: "#00b894",
            exam: "#e74c3c",
            resource: "#fdcb6e",
          };

          const uploadDate = new Date(file.uploadDate).toLocaleDateString(
            "ar-SA"
          );

          item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="content-name">
                            <i class="fas ${
                              typeIcon[file.type]
                            }" style="color: ${
            typeColor[file.type]
          }; margin-left: 8px;"></i>
                            ${file.title}
                        </div>
                        <div class="content-meta">
                            <span><strong>النوع:</strong> ${
                              typeText[file.type]
                            }</span>
                            <span><strong>المادة:</strong> ${
                              file.subject
                            }</span>
                            <span><strong>اسم الملف:</strong> ${
                              file.fileName
                            }</span>
                            <span><strong>تاريخ الرفع:</strong> ${uploadDate}</span>
                            <span><strong>حجم الملف:</strong> ${formatFileSize(
                              file.fileSize
                            )}</span>
                        </div>
                    </div>
                    <div class="content-actions">
                        <button class="content-btn" onclick="viewArchiveFile('${
                          file.type
                        }', ${file.id})">
                            <i class="fas fa-eye"></i>
                            عرض
                        </button>
                        <button class="download-btn" onclick="downloadArchiveFile('${
                          file.type
                        }', ${file.id})">
                            <i class="fas fa-download"></i>
                            تحميل
                        </button>
                    </div>
                `;
          archiveList.appendChild(item);
        });
      }

      function searchArchive() {
        loadArchiveList();
      }

      function loadStatisticsChart() {
        const activeTab = document.querySelector(
          "#statistics-modal .tab.active"
        );
        const tabName = activeTab
          ? activeTab.getAttribute("onclick").split("'")[1]
          : "attendance";

        if (window.attendanceChart) window.attendanceChart.destroy();
        if (window.homeworkChart) window.homeworkChart.destroy();
        if (window.performanceChart) window.performanceChart.destroy();

        if (tabName === "attendance") loadAttendanceChart();
        else if (tabName === "homework") loadHomeworkChart();
        else if (tabName === "performance") loadPerformanceChart();
      }

      function loadAttendanceChart() {
        const ctx = document
          .getElementById("attendance-chart")
          .getContext("2d");

        const labels = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس"];

        const data = {
          labels: labels,
          datasets: [
            {
              label: "نسبة الحضور %",
              data: [92, 94, 89, 96, 93],
              backgroundColor: "rgba(74, 108, 247, 0.2)",
              borderColor: "rgba(74, 108, 247, 1)",
              borderWidth: 2,
              fill: true,
              tension: 0.4,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "top",
              labels: { font: { size: 14 } },
            },
            tooltip: { mode: "index", intersect: false },
          },
          scales: {
            y: {
              beginAtZero: false,
              min: 80,
              max: 100,
              ticks: {
                callback: function (value) {
                  return value + "%";
                },
              },
            },
          },
        };

        window.attendanceChart = new Chart(ctx, {
          type: "line",
          data: data,
          options: options,
        });
      }

      function loadHomeworkChart() {
        const ctx = document.getElementById("homework-chart").getContext("2d");

        const labels = [
          "الرياضيات",
          "اللغة العربية",
          "العلوم",
          "الإنجليزية",
          "التاريخ",
        ];

        const data = {
          labels: labels,
          datasets: [
            {
              label: "الواجبات المسلمة",
              data: [18, 15, 12, 20, 10],
              backgroundColor: "rgba(0, 184, 148, 0.5)",
              borderColor: "rgba(0, 184, 148, 1)",
              borderWidth: 1,
            },
            {
              label: "المصححة",
              data: [15, 12, 10, 18, 8],
              backgroundColor: "rgba(155, 89, 182, 0.5)",
              borderColor: "rgba(155, 89, 182, 1)",
              borderWidth: 1,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "top", labels: { font: { size: 14 } } },
          },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 5 } } },
        };

        window.homeworkChart = new Chart(ctx, {
          type: "bar",
          data: data,
          options: options,
        });
      }

      function loadPerformanceChart() {
        const ctx = document
          .getElementById("performance-chart")
          .getContext("2d");

        const data = {
          labels: ["< 60%", "60-70%", "70-80%", "80-90%", "90-100%"],
          datasets: [
            {
              label: "عدد الطلاب",
              data: [2, 5, 8, 12, 10],
              backgroundColor: [
                "rgba(231, 76, 60, 0.5)",
                "rgba(243, 156, 18, 0.5)",
                "rgba(241, 196, 15, 0.5)",
                "rgba(46, 204, 113, 0.5)",
                "rgba(39, 174, 96, 0.5)",
              ],
              borderColor: [
                "rgba(231, 76, 60, 1)",
                "rgba(243, 156, 18, 1)",
                "rgba(241, 196, 15, 1)",
                "rgba(46, 204, 113, 1)",
                "rgba(39, 174, 96, 1)",
              ],
              borderWidth: 1,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "top", labels: { font: { size: 14 } } },
          },
        };

        window.performanceChart = new Chart(ctx, {
          type: "doughnut",
          data: data,
          options: options,
        });
      }

      // ============================================
      // وظائف التنزيل والتقييم
      // ============================================

      function downloadSubmissionFile(submissionId) {
        try {
          const submissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submission = submissions.find((sub) => sub.id === submissionId);

          if (!submission || !submission.fileContent) {
            showToast("error", "ملف التسليم غير موجود");
            return;
          }

          downloadBase64File(
            submission.fileContent,
            submission.fileName,
            submission.fileType
          );
        } catch (error) {
          console.error("Error downloading submission file:", error);
          showToast("error", "حدث خطأ في تحميل الملف");
        }
      }

      function downloadFile(fileType, fileId) {
        downloadArchiveFile(fileType, fileId);
      }

      function downloadArchiveFile(fileType, fileId) {
        try {
          let fileData = null;

          if (fileType === "preparation") {
            const savedPreps = JSON.parse(
              localStorage.getItem("teacherPreparations") || "[]"
            );
            fileData = savedPreps.find(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );
          } else if (fileType === "assignment" || fileType === "exam") {
            const savedHomeworks = JSON.parse(
              localStorage.getItem("teacherAssignments") || "[]"
            );
            fileData = savedHomeworks.find(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );
          } else if (fileType === "resource") {
            const savedResources = JSON.parse(
              localStorage.getItem("teacherResources") || "[]"
            );
            fileData = savedResources.find(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );
          }

          if (!fileData || !fileData.fileContent) {
            showToast("error", "الملف غير موجود");
            return;
          }

          downloadBase64File(
            fileData.fileContent,
            fileData.fileName,
            fileData.fileType
          );

          if (fileType === "resource") {
            const savedResources = JSON.parse(
              localStorage.getItem("teacherResources") || "[]"
            );
            const resourceIndex = savedResources.findIndex(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );

            if (resourceIndex !== -1) {
              savedResources[resourceIndex].downloads =
                (savedResources[resourceIndex].downloads || 0) + 1;
              localStorage.setItem(
                "teacherResources",
                JSON.stringify(savedResources)
              );
            }
          }
        } catch (error) {
          console.error("Error downloading archive file:", error);
          showToast("error", "حدث خطأ في تحميل الملف");
        }
      }

      function downloadBase64File(base64Data, fileName, fileType) {
        try {
          let data = base64Data;
          if (base64Data.includes("base64,")) {
            data = base64Data.split("base64,")[1];
          }

          const byteCharacters = atob(data);
          const byteNumbers = new Array(byteCharacters.length);

          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }

          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], {
            type: fileType || "application/octet-stream",
          });

          if (typeof saveAs !== "undefined") {
            saveAs(blob, fileName);
          } else {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            }, 100);
          }

          showToast("success", `جاري تحميل الملف: ${fileName}`);
        } catch (error) {
          console.error("Error processing file for download:", error);
          showToast("error", "خطأ في معالجة الملف للتحميل");

          try {
            const link = document.createElement("a");
            link.href = base64Data;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (fallbackError) {
            console.error("Fallback download also failed:", fallbackError);
          }
        }
      }

      function viewSubmissionDetails(submissionId) {
        try {
          const submissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submission = submissions.find((sub) => sub.id === submissionId);

          const teacherHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignment = teacherHomeworks.find(
            (hw) => hw.id === submission.assignmentId
          );

          if (!submission || !assignment) {
            showToast("error", "التسليم غير موجود");
            return;
          }

          // في تطبيق حقيقي، سيتم فتح نافذة تفاصيل كاملة
          showToast("info", "عرض تفاصيل التسليم (قيد التطوير)");
        } catch (error) {
          console.error("Error viewing submission details:", error);
          showToast("error", "حدث خطأ في عرض التفاصيل");
        }
      }

      function loadSubmissionDetails(submissionId) {
        try {
          const submissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submission = submissions.find((sub) => sub.id === submissionId);

          const teacherHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignment = teacherHomeworks.find(
            (hw) => hw.id === submission.assignmentId
          );

          if (!submission || !assignment) {
            showToast("error", "التسليم غير موجود");
            return;
          }

          currentSubmissionToGrade = submissionId;

          const submissionDetails =
            document.getElementById("submission-details");
          const submissionDate = new Date(
            submission.submissionDate
          ).toLocaleString("ar-SA");
          const dueDate = new Date(assignment.dueDate).toLocaleString("ar-SA");

          submissionDetails.innerHTML = `
                    <div class="file-info">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">تفاصيل التسليم</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <strong>اسم الطالب:</strong>
                                <p>${submission.studentName}</p>
                            </div>
                            <div>
                                <strong>عنوان الواجب:</strong>
                                <p>${assignment.title}</p>
                            </div>
                            <div>
                                <strong>المادة:</strong>
                                <p>${assignment.subjectName}</p>
                            </div>
                            <div>
                                <strong>الفصل:</strong>
                                <p>${assignment.className}</p>
                            </div>
                            <div>
                                <strong>موعد التسليم:</strong>
                                <p>${dueDate}</p>
                            </div>
                            <div>
                                <strong>تاريخ التسليم:</strong>
                                <p>${submissionDate}</p>
                            </div>
                            <div>
                                <strong>اسم الملف:</strong>
                                <p>${submission.fileName}</p>
                            </div>
                            <div>
                                <strong>حجم الملف:</strong>
                                <p>${formatFileSize(submission.fileSize)}</p>
                            </div>
                        </div>
                        
                        ${
                          submission.notes
                            ? `
                            <div style="margin-top: 15px;">
                                <strong>ملاحظات الطالب:</strong>
                                <p style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">${submission.notes}</p>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;

          document.getElementById("max-grade").textContent =
            assignment.maxGrade;
          document.getElementById("grade-score").max = assignment.maxGrade;

          if (submission.grade) {
            document.getElementById("grade-score").value = submission.grade;
            updateGradeProgress();
          }

          if (submission.feedback) {
            document.getElementById("grade-feedback").value =
              submission.feedback;
          }
        } catch (error) {
          console.error("Error loading submission details:", error);
          showToast("error", "حدث خطأ في تحميل التفاصيل");
        }
      }

      function updateGradeProgress() {
        const gradeInput = document.getElementById("grade-score");
        const maxGrade = parseInt(
          document.getElementById("max-grade").textContent
        );
        const grade = parseInt(gradeInput.value) || 0;

        const percentage = Math.min(100, (grade / maxGrade) * 100);
        document.getElementById(
          "grade-progress"
        ).style.width = `${percentage}%`;

        const progressFill = document.getElementById("grade-progress");
        if (percentage >= 80) {
          progressFill.style.background =
            "linear-gradient(90deg, #00b894, #55efc4)";
        } else if (percentage >= 60) {
          progressFill.style.background =
            "linear-gradient(90deg, #fdcb6e, #ffeaa7)";
        } else {
          progressFill.style.background =
            "linear-gradient(90deg, #e74c3c, #fd79a8)";
        }
      }

      function saveGrade() {
        try {
          const grade = document.getElementById("grade-score").value;
          const feedback = document.getElementById("grade-feedback").value;

          if (!currentSubmissionToGrade) {
            showToast("error", "لم يتم تحديد تسليم");
            return;
          }

          if (!grade || grade < 0) {
            showToast("error", "يرجى إدخال درجة صحيحة");
            return;
          }

          const submissions = JSON.parse(
            localStorage.getItem("studentSubmissions") || "[]"
          );
          const submissionIndex = submissions.findIndex(
            (sub) => sub.id === currentSubmissionToGrade
          );

          if (submissionIndex === -1) {
            showToast("error", "التسليم غير موجود");
            return;
          }

          submissions[submissionIndex].grade = parseInt(grade);
          submissions[submissionIndex].feedback = feedback;
          submissions[submissionIndex].gradeDate = new Date().toISOString();
          submissions[submissionIndex].gradedBy = currentTeacherId;

          localStorage.setItem(
            "studentSubmissions",
            JSON.stringify(submissions)
          );

          const teacherHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          const assignmentIndex = teacherHomeworks.findIndex(
            (hw) => hw.id === submissions[submissionIndex].assignmentId
          );

          if (assignmentIndex !== -1) {
            teacherHomeworks[assignmentIndex].graded =
              (teacherHomeworks[assignmentIndex].graded || 0) + 1;
            localStorage.setItem(
              "teacherAssignments",
              JSON.stringify(teacherHomeworks)
            );
          }

          showToast("success", "تم حفظ التقييم بنجاح!");
          closeModal("grade-modal");
          loadSubmittedAssignments();
          updateSubmittedStats();
        } catch (error) {
          console.error("Error saving grade:", error);
          showToast("error", "حدث خطأ في حفظ التقييم");
        }
      }

      // ============================================
      // وظائف رفع الملفات الأخرى
      // ============================================

      function handleFileSelection(event, fileNameElementId) {
        const file = event.target.files[0];
        if (!file) return;

        const fileNameElement = document.getElementById(fileNameElementId);
        if (fileNameElement) {
          fileNameElement.textContent = `${file.name} (${formatFileSize(
            file.size
          )})`;
        }

        if (file.size > 10 * 1024 * 1024) {
          showToast("error", "حجم الملف كبير جداً. الحد الأقصى 10 ميجابايت");
          event.target.value = "";
          if (fileNameElement) fileNameElement.textContent = "";
          return;
        }
      }

      function submitHomeworkForm(e) {
        e.preventDefault();

        const type = document.getElementById("hw-type").value;
        const title = document.getElementById("hw-title").value;
        const subject = document.getElementById("hw-subject").value;
        const classCode = document.getElementById("hw-class").value;
        const description = document.getElementById("hw-description").value;
        const dueDate = document.getElementById("hw-due-date").value;
        const maxGrade = document.getElementById("hw-max-grade").value;
        const file = document.getElementById("hw-file").files[0];
        const notify = document.getElementById("hw-notify").checked;

        if (
          !title ||
          !subject ||
          !classCode ||
          !description ||
          !dueDate ||
          !maxGrade
        ) {
          showToast("error", "يرجى ملء جميع الحقول المطلوبة");
          return;
        }

        const homeworkData = {
          id: Date.now(),
          teacherId: currentTeacherId,
          teacherName: currentUser.name,
          type: type,
          title: title,
          subject: subject,
          subjectName: getSubjectName(subject),
          class: classCode,
          className: getClassName(classCode),
          description: description,
          dueDate: dueDate,
          maxGrade: parseInt(maxGrade),
          uploadDate: new Date().toISOString(),
          status: "active",
          submissions: 0,
          graded: 0,
        };

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            homeworkData.fileName = file.name;
            homeworkData.fileType = file.type;
            homeworkData.fileSize = file.size;
            homeworkData.fileContent = e.target.result;

            saveHomework(homeworkData, notify);
          };

          reader.onerror = function (error) {
            console.error("Error reading file:", error);
            homeworkData.fileName = null;
            homeworkData.fileType = null;
            homeworkData.fileSize = null;
            homeworkData.fileContent = null;

            saveHomework(homeworkData, notify);
          };

          reader.readAsDataURL(file);
        } else {
          openFallbackUpload("homework", {
            type: type,
            title: title,
            subject: subject,
            classCode: classCode,
            description: description,
            dueDate: dueDate,
            maxGrade: maxGrade,
            notify: notify,
          });
        }
      }

      function saveHomework(homeworkData, notify) {
        try {
          const savedHomeworks = JSON.parse(
            localStorage.getItem("teacherAssignments") || "[]"
          );
          savedHomeworks.push(homeworkData);
          localStorage.setItem(
            "teacherAssignments",
            JSON.stringify(savedHomeworks)
          );

          showToast(
            "success",
            `تم إنشاء الواجب "${homeworkData.title}" بنجاح!`
          );
          closeModal("homework-modal");

          document.getElementById("homework-form").reset();
          document.getElementById("hw-file-name").textContent = "";
          document.getElementById("hw-max-grade").value = 100;

          const nextWeek = new Date();
          nextWeek.setDate(nextWeek.getDate() + 7);
          document.getElementById("hw-due-date").value = nextWeek
            .toISOString()
            .slice(0, 16);
        } catch (error) {
          console.error("Error saving homework:", error);
          showToast(
            "error",
            "حدث خطأ أثناء حفظ الواجب. يرجى المحاولة مرة أخرى."
          );
        }
      }

      function submitExamForm(e) {
        e.preventDefault();

        const title = document.getElementById("exam-title").value;
        const subject = document.getElementById("exam-subject").value;
        const date = document.getElementById("exam-date").value;
        const duration = document.getElementById("exam-duration").value;
        const file = document.getElementById("exam-file").files[0];

        if (!title || !subject || !date || !duration) {
          showToast("error", "يرجى ملء جميع الحقول المطلوبة");
          return;
        }

        if (!file) {
          openFallbackUpload("exam", {
            title: title,
            subject: subject,
            date: date,
            duration: duration,
          });
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const examData = {
              id: Date.now(),
              teacherId: currentTeacherId,
              teacherName: currentUser.name,
              type: "exam",
              title: title,
              subject: subject,
              subjectName: getSubjectName(subject),
              date: date,
              duration: parseInt(duration),
              fileName: file.name,
              fileType: file.type,
              fileSize: file.size,
              fileContent: e.target.result,
              uploadDate: new Date().toISOString(),
              status: "scheduled",
            };

            const savedExams = JSON.parse(
              localStorage.getItem("teacherExams") || "[]"
            );
            savedExams.push(examData);
            localStorage.setItem("teacherExams", JSON.stringify(savedExams));

            showToast("success", `تم رفع الامتحان "${file.name}" بنجاح!`);
            closeModal("homework-modal");
            document.getElementById("exam-form").reset();
          } catch (error) {
            console.error("Error saving exam:", error);
            showToast(
              "error",
              "حدث خطأ أثناء حفظ الامتحان. يرجى المحاولة مرة أخرى."
            );
          }
        };

        reader.onerror = function (error) {
          console.error("Error reading file:", error);
          showToast("error", "حدث خطأ في قراءة ملف الامتحان.");
        };

        reader.readAsDataURL(file);
      }

      function submitResourceForm(e) {
        e.preventDefault();

        const title = document.getElementById("resource-title").value;
        const type = document.getElementById("resource-type").value;
        const description = document.getElementById(
          "resource-description"
        ).value;
        const file = document.getElementById("resource-file").files[0];

        if (!title || !type) {
          showToast("error", "يرجى ملء جميع الحقول المطلوبة");
          return;
        }

        if (!file) {
          openFallbackUpload("resource", {
            title: title,
            type: type,
            description: description,
          });
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const resourceData = {
              id: Date.now(),
              teacherId: currentTeacherId,
              teacherName: currentUser.name,
              title: title,
              type: type,
              description: description || "",
              fileName: file.name,
              fileType: file.type,
              fileSize: file.size,
              fileContent: e.target.result,
              uploadDate: new Date().toISOString(),
              downloads: 0,
            };

            const savedResources = JSON.parse(
              localStorage.getItem("teacherResources") || "[]"
            );
            savedResources.push(resourceData);
            localStorage.setItem(
              "teacherResources",
              JSON.stringify(savedResources)
            );

            showToast(
              "success",
              `تم رفع المورد التعليمي "${file.name}" بنجاح!`
            );
            closeModal("resource-modal");
            document.getElementById("resource-form").reset();
          } catch (error) {
            console.error("Error saving resource:", error);
            showToast("error", "حدث خطأ أثناء حفظ المورد التعليمي.");
          }
        };

        reader.onerror = function (error) {
          console.error("Error reading file:", error);
          showToast("error", "حدث خطأ في قراءة ملف المورد التعليمي.");
        };

        reader.readAsDataURL(file);
      }

      function saveFallbackFile() {
        const textarea = document.getElementById("fallback-content");
        const content = textarea.value.trim();

        if (!content) {
          showToast("error", "يرجى إدخال محتوى الملف");
          return;
        }

        const base64Content = btoa(unescape(encodeURIComponent(content)));
        const dataUrl = `data:text/plain;base64,${base64Content}`;

        switch (currentFallbackType) {
          case "preparation":
            savePreparationData(
              dataUrl,
              {
                name: "تحضير_نصي.txt",
                type: "text/plain",
                size: content.length,
              },
              currentFallbackData.subject,
              currentFallbackData.title,
              currentFallbackData.date,
              currentFallbackData.description,
              currentFallbackData.notify
            );
            break;

          case "homework":
            const homeworkData = {
              id: Date.now(),
              teacherId: currentTeacherId,
              teacherName: currentUser.name,
              type: currentFallbackData.type,
              title: currentFallbackData.title,
              subject: currentFallbackData.subject,
              subjectName: getSubjectName(currentFallbackData.subject),
              class: currentFallbackData.classCode,
              className: getClassName(currentFallbackData.classCode),
              description: currentFallbackData.description,
              dueDate: currentFallbackData.dueDate,
              maxGrade: parseInt(currentFallbackData.maxGrade),
              fileName: "واجب_نصي.txt",
              fileType: "text/plain",
              fileSize: content.length,
              fileContent: dataUrl,
              uploadDate: new Date().toISOString(),
              status: "active",
              submissions: 0,
              graded: 0,
            };

            saveHomework(homeworkData, currentFallbackData.notify);
            break;

          case "exam":
            const examData = {
              id: Date.now(),
              teacherId: currentTeacherId,
              teacherName: currentUser.name,
              type: "exam",
              title: currentFallbackData.title,
              subject: currentFallbackData.subject,
              subjectName: getSubjectName(currentFallbackData.subject),
              date: currentFallbackData.date,
              duration: parseInt(currentFallbackData.duration),
              fileName: "امتحان_نصي.txt",
              fileType: "text/plain",
              fileSize: content.length,
              fileContent: dataUrl,
              uploadDate: new Date().toISOString(),
              status: "scheduled",
            };

            const savedExams = JSON.parse(
              localStorage.getItem("teacherExams") || "[]"
            );
            savedExams.push(examData);
            localStorage.setItem("teacherExams", JSON.stringify(savedExams));

            showToast("success", "تم حفظ الامتحان بنجاح!");
            break;

          case "resource":
            const resourceData = {
              id: Date.now(),
              teacherId: currentTeacherId,
              teacherName: currentUser.name,
              title: currentFallbackData.title,
              type: currentFallbackData.type,
              description: currentFallbackData.description || "",
              fileName: "مورد_تعليمي_نصي.txt",
              fileType: "text/plain",
              fileSize: content.length,
              fileContent: dataUrl,
              uploadDate: new Date().toISOString(),
              downloads: 0,
            };

            const savedResources = JSON.parse(
              localStorage.getItem("teacherResources") || "[]"
            );
            savedResources.push(resourceData);
            localStorage.setItem(
              "teacherResources",
              JSON.stringify(savedResources)
            );

            showToast("success", "تم حفظ المورد التعليمي بنجاح!");
            break;
        }

        closeModal("fallback-upload");
      }

      function savePreparationData(
        fileContent,
        file,
        subject,
        title,
        date,
        description,
        notify
      ) {
        try {
          const savedPreps = JSON.parse(
            localStorage.getItem("teacherPreparations") || "[]"
          );

          const prepData = {
            id: Date.now(),
            teacherId: currentTeacherId,
            teacherName: currentUser.name,
            title: title,
            subject: subject,
            subjectName: getSubjectName(subject),
            date: date,
            description: description || "",
            fileName: file ? file.name : "تحضير_بدون_ملف.txt",
            fileType: file ? file.type : "text/plain",
            fileSize: file ? file.size : 1024,
            fileContent: fileContent,
            uploadDate: new Date().toISOString(),
            status: "pending",
            reviewedBy: null,
            reviewDate: null,
            reviewNotes: null,
          };

          savedPreps.push(prepData);
          localStorage.setItem(
            "teacherPreparations",
            JSON.stringify(savedPreps)
          );

          if (notify) {
            const adminNotifications = JSON.parse(
              localStorage.getItem("adminNotifications") || "[]"
            );
            adminNotifications.push({
              id: Date.now(),
              type: "new_preparation",
              title: `ملف تحضير جديد من ${prepData.teacherName}`,
              message: `تم رفع ملف تحضير للمادة: ${prepData.subjectName} بتاريخ ${prepData.date}`,
              data: prepData,
              read: false,
              date: new Date().toISOString(),
            });

            localStorage.setItem(
              "adminNotifications",
              JSON.stringify(adminNotifications)
            );
          }

          updateTeacherStats();
          showToast("success", `تم رفع ملف التحضير "${prepData.title}" بنجاح!`);
          closeModal("upload-prep-modal");
        } catch (error) {
          console.error("Error saving preparation:", error);
          showToast(
            "error",
            "حدث خطأ أثناء حفظ الملف. يرجى المحاولة مرة أخرى."
          );
        }
      }

      function getClassName(classCode) {
        const cls = classes[classCode];
        return cls ? cls.ar : classCode;
      }

      function viewArchiveFile(fileType, fileId) {
        try {
          let fileData = null;

          if (fileType === "preparation") {
            const savedPreps = JSON.parse(
              localStorage.getItem("teacherPreparations") || "[]"
            );
            fileData = savedPreps.find(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );
          } else if (fileType === "assignment" || fileType === "exam") {
            const savedHomeworks = JSON.parse(
              localStorage.getItem("teacherAssignments") || "[]"
            );
            fileData = savedHomeworks.find(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );
          } else if (fileType === "resource") {
            const savedResources = JSON.parse(
              localStorage.getItem("teacherResources") || "[]"
            );
            fileData = savedResources.find(
              (f) => f.id === fileId && f.teacherId === currentTeacherId
            );
          }

          if (!fileData || !fileData.fileContent) {
            showToast("error", "الملف غير موجود");
            return;
          }

          if (fileData.fileContent.startsWith("data:image/")) {
            const imageWindow = window.open();
            imageWindow.document.write(`
                        <html>
                            <head><title>${fileData.fileName}</title>
                            <style>body { margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f5f5f5; }
                            img { max-width: 100%; max-height: 90vh; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 5px; }</style></head>
                            <body><img src="${fileData.fileContent}" alt="${fileData.fileName}"></body>
                        </html>
                    `);
          } else {
            showToast("info", "عرض الملف (قيد التطوير)");
          }
        } catch (error) {
          console.error("Error viewing archive file:", error);
          showToast("error", "حدث خطأ في عرض الملف");
        }
      }

      // ============================================
      // وظائف أخرى
      // ============================================

      function editPreparation(prepId) {
        showToast("info", "ميزة التعديل قيد التطوير");
      }

      function scheduleClass() {
        showToast("info", "سيتم فتح نافذة جدولة الدرس قريباً");
      }

      function generateReport() {
        showToast("info", "جاري إنشاء التقرير...");

        setTimeout(() => {
          showToast("success", "تم إنشاء التقرير بنجاح!");
        }, 1500);
      }

      function logout() {
        localStorage.removeItem("currentUser");
        showToast("success", "تم تسجيل الخروج بنجاح");

        setTimeout(() => {
          window.location.href = "login.html";
        }, 1000);
      }

      // ============================================
      // تهيئة إضافية
      // ============================================

      window.addEventListener("load", function () {
        updateNotificationBadges();
        setInterval(updateTeacherStats, 60000);
      });

      function updateNotificationBadges() {
        const savedPreps = JSON.parse(
          localStorage.getItem("teacherPreparations") || "[]"
        );
        const pendingPreps = savedPreps.filter(
          (prep) =>
            prep.teacherId === currentTeacherId && prep.status === "pending"
        );

        const courseBadge = document.querySelector(
          "#menu-courses + .notification-badge"
        );
        if (courseBadge && pendingPreps.length > 0) {
          courseBadge.textContent = pendingPreps.length;
          courseBadge.style.display = "flex";
        } else if (courseBadge) {
          courseBadge.style.display = "none";
        }
      }

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          const modals = document.querySelectorAll(".modal");
          modals.forEach((modal) => {
            if (modal.style.display === "flex") {
              modal.style.display = "none";
            }
          });
        }
      });
    </script>
  </body>
</html>
