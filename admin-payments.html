<!-- admin-payments.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إدارة المدفوعات - لوحة المدير</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <style>
      :root {
        --primary: #4a6cf7;
        --primary-dark: #3a56d4;
        --secondary: #6c5ce7;
        --accent: #00b894;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --dark: #2d3436;
        --text: #333;
        --text-light: #666;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        --sidebar-width: 260px;
      }

      .dark-mode {
        --light: #1a1a2e;
        --dark: #f8f9fa;
        --text: #e6e6e6;
        --text-light: #b0b0b0;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Tajawal", "Segoe UI", sans-serif;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f8ff 0%, #e1f0fa 100%);
        transition: var(--transition);
      }

      body.dark-mode {
        background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
      }

      body.rtl {
        direction: rtl;
      }
      body.ltr {
        direction: ltr;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(
          180deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        color: white;
        padding: 20px 0;
        box-shadow: var(--shadow);
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: var(--transition);
        z-index: 100;
      }

      body.rtl .sidebar {
        right: 0;
      }
      body.ltr .sidebar {
        left: 0;
      }
      body.rtl .main-content {
        margin-right: var(--sidebar-width);
      }
      body.ltr .main-content {
        margin-left: var(--sidebar-width);
        margin-right: 0;
      }

      .sidebar-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
      }

      .logo {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }
     .logo {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .logo img {
        width: 140px;
        height: auto;
        object-fit: contain;
        display: block;
      }

      .logo-text {
        font-size: 24px;
        font-weight: 800;
        background: linear-gradient(135deg, white, #e1f0fa);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .user-info {
        text-align: center;
        margin-top: 10px;
      }

      .user-name {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
      }

      .user-type {
        background: rgba(52, 152, 219, 0.3);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-block;
      }

      .sidebar-menu {
        list-style: none;
        padding: 0 15px;
      }

      .menu-item {
        margin-bottom: 8px;
        border-radius: 10px;
      }

      .menu-item a {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: white;
        text-decoration: none;
        transition: var(--transition);
      }

      .menu-item a:hover,
      .menu-item.active a {
        background: rgba(255, 255, 255, 0.15);
      }

      body.rtl .menu-item a:hover,
      body.rtl .menu-item.active a {
        transform: translateX(-5px);
      }
      body.ltr .menu-item a:hover,
      body.ltr .menu-item.active a {
        transform: translateX(5px);
      }

      .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
      }

      body.rtl .menu-item i {
        margin-left: 10px;
      }
      body.ltr .menu-item i {
        margin-right: 10px;
      }

      .sidebar-footer {
        padding: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 20px;
      }

      .main-content {
        flex: 1;
        padding: 20px;
        transition: var(--transition);
      }

      .header {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .header {
        background: var(--light);
        color: var(--dark);
      }

      .header h1 {
        color: var(--primary);
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .action-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-success:hover {
        background: #219653;
        transform: translateY(-2px);
      }

      .btn-warning {
        background: var(--warning);
        color: white;
      }

      .btn-warning:hover {
        background: #e67e22;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
        transform: translateY(-2px);
      }

      .dark-mode-toggle,
      .logout-btn {
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dark-mode-toggle {
        background: rgba(52, 152, 219, 0.1);
        color: var(--secondary);
      }

      .dark-mode-toggle:hover {
        background: rgba(52, 152, 219, 0.2);
      }

      .logout-btn {
        background: rgba(231, 76, 60, 0.1);
        color: var(--accent);
      }

      .logout-btn:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        display: flex;
        align-items: center;
        transition: var(--transition);
      }

      body.dark-mode .stat-card {
        background: var(--light);
        color: var(--dark);
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      body.rtl .stat-icon {
        margin-left: 15px;
      }
      body.ltr .stat-icon {
        margin-right: 15px;
      }

      .icon-primary {
        background: var(--primary);
      }
      .icon-success {
        background: var(--success);
      }
      .icon-warning {
        background: var(--warning);
      }
      .icon-danger {
        background: var(--danger);
      }

      .stat-info {
        flex: 1;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 5px;
      }

      .stat-label {
        color: var(--text-light);
        font-size: 14px;
      }

      .control-panel {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        margin-bottom: 25px;
      }

      body.dark-mode .control-panel {
        background: var(--light);
        color: var(--dark);
      }

      .panel-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .search-filter {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .input-group label {
        font-weight: 600;
        color: var(--text-light);
        font-size: 14px;
      }

      .input-group input,
      .input-group select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
      }

      body.dark-mode .input-group input,
      body.dark-mode .input-group select {
        background: #2d3748;
        border-color: #4a5568;
        color: var(--dark);
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
      }

      .tables-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
      }

      .table-card {
        background: white;
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        overflow: hidden;
      }

      body.dark-mode .table-card {
        background: var(--light);
        color: var(--dark);
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .table-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .table-container {
        overflow-x: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
      }

      .data-table th,
      .data-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      body.dark-mode .data-table th,
      body.dark-mode .data-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      body.rtl .data-table th,
      body.rtl .data-table td {
        text-align: right;
      }

      body.ltr .data-table th,
      body.ltr .data-table td {
        text-align: left;
      }

      .data-table th {
        background: rgba(44, 62, 80, 0.1);
        color: var(--primary);
        font-weight: 600;
        white-space: nowrap;
      }

      .data-table tbody tr:hover {
        background: rgba(44, 62, 80, 0.05);
      }

      body.dark-mode .data-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
      }

      .badge-success {
        background: rgba(39, 174, 96, 0.1);
        color: var(--success);
      }
      .badge-warning {
        background: rgba(243, 156, 18, 0.1);
        color: var(--warning);
      }
      .badge-danger {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger);
      }
      .badge-info {
        background: rgba(52, 152, 219, 0.1);
        color: var(--secondary);
      }
      .badge-primary {
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary);
      }

      .table-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .action-icon {
        width: 35px;
        height: 35px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
      }

      .action-edit {
        background: rgba(52, 152, 219, 0.1);
        color: var(--secondary);
      }
      .action-delete {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger);
      }
      .action-view {
        background: rgba(39, 174, 96, 0.1);
        color: var(--success);
      }
      .action-refresh {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
      }

      .action-icon:hover {
        transform: translateY(-2px);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow);
      }

      body.dark-mode .modal-content {
        background: var(--light);
        color: var(--dark);
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      body.dark-mode .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .modal-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
        transition: var(--transition);
      }

      .modal-close:hover {
        color: var(--accent);
      }

      .modal-body {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-light);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
      }

      body.dark-mode .form-group input,
      body.dark-mode .form-group select,
      body.dark-mode .form-group textarea {
        background: #2d3748;
        border-color: #4a5568;
        color: var(--dark);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      body.dark-mode .modal-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
      }

      .page-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        background: #f8f9fa;
        color: var(--text);
        border: 1px solid #dee2e6;
      }

      body.dark-mode .page-btn {
        background: #2d3748;
        border-color: #4a5568;
        color: var(--dark);
      }

      .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .page-btn:hover:not(.active) {
        background: #e9ecef;
      }

      body.dark-mode .page-btn:hover:not(.active) {
        background: #4a5568;
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        font-weight: 600;
        animation: slideDown 0.3s ease;
      }

      .toast-success {
        background: #00b894;
        color: white;
      }

      .toast-warning {
        background: #f39c12;
        color: white;
      }

      .toast-info {
        background: #3498db;
        color: white;
      }

      .toast-danger {
        background: #e74c3c;
        color: white;
      }

      @keyframes slideDown {
        from {
          transform: translate(-50%, -100%);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translate(-50%, 0);
          opacity: 1;
        }
        to {
          transform: translate(-50%, -100%);
          opacity: 0;
        }
      }

      @media (max-width: 992px) {
        .sidebar {
          width: 80px;
        }
        .sidebar-header .logo-text,
        .user-info,
        .menu-item span {
          display: none;
        }
        body.rtl .main-content {
          margin-right: 80px;
        }
        body.ltr .main-content {
          margin-left: 80px;
        }
        .menu-item a {
          justify-content: center;
          padding: 15px;
        }
        .menu-item i {
          margin: 0;
          font-size: 20px;
        }
      }

      @media (max-width: 768px) {
        .stats-cards {
          grid-template-columns: 1fr;
        }
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }
        .header-actions {
          flex-wrap: wrap;
          justify-content: center;
        }
        .search-filter {
          grid-template-columns: 1fr;
        }
        .table-header {
          flex-direction: column;
          gap: 15px;
          align-items: stretch;
        }
      }

      @media (max-width: 576px) {
        .main-content {
          padding: 15px;
        }
        .sidebar {
          width: 70px;
        }
        body.rtl .main-content {
          margin-right: 70px;
        }
        body.ltr .main-content {
          margin-left: 70px;
        }
        .table-actions {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body class="rtl">
    <div class="dashboard-container">
      <!-- الشريط الجانبي -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="logo.png" alt="Logo" />
          </div>
          <div class="logo-text">DT Edu</div>
          <div class="user-info">
            <div class="user-name">أحمد محمد</div>
            <div class="user-type">مدير النظام</div>
          </div>
        </div>

        <ul class="sidebar-menu">
          <li class="menu-item">
            <a href="admin-dashboard.html">
              <i class="fas fa-home"></i>
              <span>لوحة التحكم</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-users.html">
              <i class="fas fa-users-cog"></i>
              <span>إدارة المستخدمين</span>
            </a>
          </li>
          <li class="menu-item active">
            <a href="admin-payments.html">
              <i class="fas fa-money-bill-wave"></i>
              <span>المدفوعات والرسوم</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-reports.html">
              <i class="fas fa-chart-bar"></i>
              <span>التقارير والإحصائيات</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-schedule.html">
              <i class="fas fa-calendar-alt"></i>
              <span>الجدول المدرسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="classroom.html">
              <i class="fas fa-chalkboard"></i>
              <span>الفصل الدراسي</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-messages.html">
              <i class="fas fa-comments"></i>
              <span>الرسائل</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="admin-settings.html">
              <i class="fas fa-cog"></i>
              <span>الإعدادات</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <ul class="sidebar-menu">
            <li class="menu-item">
              <a href="#" id="sidebar-dark-mode-toggle">
                <i class="fas fa-moon"></i>
                <span>الوضع الداكن</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="#" id="sidebar-language-toggle">
                <i class="fas fa-language"></i>
                <span>English</span>
              </a>
            </li>
            <li class="menu-item">
              <a href="index.html">
                <i class="fas fa-sign-out-alt"></i>
                <span>تسجيل الخروج</span>
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- المحتوى الرئيسي -->
      <div class="main-content">
        <!-- رأس الصفحة -->
        <div class="header">
          <h1>
            <i class="fas fa-money-bill-wave"></i>
            إدارة المدفوعات والرسوم
          </h1>
          <div class="header-actions">
            <button class="action-btn btn-success" id="btn-add-payment">
              <i class="fas fa-plus-circle"></i>
              إضافة دفعة
            </button>
            <button class="action-btn btn-primary" id="btn-refresh">
              <i class="fas fa-sync-alt"></i>
              تحديث البيانات
            </button>
            <button class="dark-mode-toggle" id="header-dark-mode-toggle">
              <i class="fas fa-moon"></i>
              <span>الوضع الداكن</span>
            </button>
            <button
              class="logout-btn"
              onclick="window.location.href='index.html'"
            >
              <i class="fas fa-sign-out-alt"></i>
              <span>تسجيل الخروج</span>
            </button>
          </div>
        </div>

        <!-- إحصائيات سريعة -->
        <div class="stats-cards">
          <div class="stat-card">
            <div class="stat-icon icon-primary">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-info">
              <div class="stat-value" id="total-collected">0 مصري</div>
              <div class="stat-label">إجمالي المبالغ المحصلة</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon icon-success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-value" id="total-paid">0</div>
              <div class="stat-label">عدد المدفوعات المكتملة</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon icon-warning">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <div class="stat-value" id="total-pending">0</div>
              <div class="stat-label">المدفوعات المنتظرة</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon icon-danger">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
              <div class="stat-value" id="total-parents">0</div>
              <div class="stat-label">أولياء الأمور المسجلين</div>
            </div>
          </div>
        </div>

        <!-- لوحة التحكم -->
        <div class="control-panel">
          <div class="panel-title">
            <i class="fas fa-search"></i>
            البحث والتصفية
          </div>
          <div class="search-filter">
            <div class="input-group">
              <label>بحث عن ولي أمر</label>
              <input
                type="text"
                id="search-parent"
                placeholder="أدخل اسم ولي الأمر..."
              />
            </div>
            <div class="input-group">
              <label>بحث عن طالب</label>
              <input
                type="text"
                id="search-student"
                placeholder="أدخل اسم الطالب..."
              />
            </div>
            <div class="input-group">
              <label>تصفية حسب الحالة</label>
              <select id="filter-status">
                <option value="all">جميع الحالات</option>
                <option value="paid">مدفوع</option>
                <option value="pending">مستحق</option>
              </select>
            </div>
            <div class="input-group">
              <label>من تاريخ</label>
              <input type="date" id="filter-from-date" />
            </div>
            <div class="input-group">
              <label>إلى تاريخ</label>
              <input type="date" id="filter-to-date" />
            </div>
          </div>
          <div class="header-actions">
            <button class="action-btn btn-primary" id="btn-apply-filters">
              <i class="fas fa-filter"></i>
              تطبيق الفلاتر
            </button>
            <button class="action-btn btn-secondary" id="btn-reset-filters">
              <i class="fas fa-redo"></i>
              إعادة تعيين
            </button>
            <button class="action-btn btn-warning" id="btn-export-data">
              <i class="fas fa-file-export"></i>
              تصدير البيانات
            </button>
          </div>
        </div>

        <!-- الجداول -->
        <div class="tables-container">
          <!-- جدول المدفوعات -->
          <div class="table-card">
            <div class="table-header">
              <div class="table-title">
                <i class="fas fa-receipt"></i>
                سجل المدفوعات
              </div>
              <div class="table-actions">
                <div
                  class="action-icon action-refresh"
                  id="refresh-payments"
                  title="تحديث البيانات"
                >
                  <i class="fas fa-sync-alt"></i>
                </div>
              </div>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>اسم ولي الأمر</th>
                    <th>اسم الطالب</th>
                    <th>المبلغ</th>
                    <th>رقم الفاتورة</th>
                    <th>الحالة</th>
                    <th>تاريخ الدفع</th>
                    <th>طريقة الدفع</th>
                    <th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="payments-table-body">
                  <!-- البيانات سيتم إضافتها بواسطة JavaScript -->
                </tbody>
              </table>
            </div>
            <div class="pagination" id="payments-pagination">
              <!-- Pagination سيتم إضافتها بواسطة JavaScript -->
            </div>
          </div>

          <!-- جدول الإحصائيات -->
          <div class="table-card">
            <div class="table-header">
              <div class="table-title">
                <i class="fas fa-chart-pie"></i>
                إحصائيات المدفوعات
              </div>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>اسم الطالب</th>
                    <th>ولي الأمر</th>
                    <th>إجمالي المستحق</th>
                    <th>المدفوع</th>
                    <th>المتبقي</th>
                    <th>آخر دفعة</th>
                    <th>الحالة</th>
                  </tr>
                </thead>
                <tbody id="statistics-table-body">
                  <!-- البيانات سيتم إضافتها بواسطة JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- نافذة إضافة دفعة -->
    <div class="modal" id="addPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">إضافة دفعة جديدة</div>
          <button class="modal-close" id="closeAddPaymentModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="addPaymentForm">
            <div class="form-group">
              <label for="addParentName">اسم ولي الأمر</label>
              <input
                type="text"
                id="addParentName"
                placeholder="أدخل اسم ولي الأمر"
                required
              />
            </div>
            <div class="form-group">
              <label for="addStudentName">اسم الطالب</label>
              <input
                type="text"
                id="addStudentName"
                placeholder="أدخل اسم الطالب"
                required
              />
            </div>
            <div class="form-group">
              <label for="addInvoiceId">رقم الفاتورة</label>
              <input
                type="text"
                id="addInvoiceId"
                placeholder="أدخل رقم الفاتورة"
                required
              />
            </div>
            <div class="form-group">
              <label for="addAmount">المبلغ (مصري)</label>
              <input
                type="number"
                id="addAmount"
                placeholder="أدخل المبلغ"
                step="0.01"
                min="0"
                required
              />
            </div>
            <div class="form-group">
              <label for="addStatus">حالة الدفع</label>
              <select id="addStatus" required>
                <option value="paid">مدفوع</option>
                <option value="pending">مستحق</option>
              </select>
            </div>
            <div class="form-group">
              <label for="addDate">تاريخ الدفع</label>
              <input type="date" id="addDate" required />
            </div>
            <div class="form-group">
              <label for="addPaymentMethod">طريقة الدفع</label>
              <select id="addPaymentMethod" required>
                <option value="cash">نقدي</option>
                <option value="bank_transfer">تحويل بنكي</option>
                <option value="credit_card">بطاقة ائتمان</option>
                <option value="check">شيك</option>
                <option value="online">دفع إلكتروني</option>
              </select>
            </div>
            <div class="form-group">
              <label for="addDescription">الوصف (اختياري)</label>
              <textarea
                id="addDescription"
                rows="3"
                placeholder="وصف تفصيلي للدفعة"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelAddPayment">إلغاء</button>
          <button class="btn btn-success" id="submitAddPayment">
            إضافة الدفعة
          </button>
        </div>
      </div>
    </div>

    <!-- نافذة تعديل دفعة -->
    <div class="modal" id="editPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">تعديل الدفعة</div>
          <button class="modal-close" id="closeEditPaymentModal">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="editPaymentForm">
            <input type="hidden" id="editPaymentId" />
            <div class="form-group">
              <label for="editParentName">اسم ولي الأمر</label>
              <input
                type="text"
                id="editParentName"
                placeholder="أدخل اسم ولي الأمر"
                required
              />
            </div>
            <div class="form-group">
              <label for="editStudentName">اسم الطالب</label>
              <input
                type="text"
                id="editStudentName"
                placeholder="أدخل اسم الطالب"
                required
              />
            </div>
            <div class="form-group">
              <label for="editInvoiceId">رقم الفاتورة</label>
              <input
                type="text"
                id="editInvoiceId"
                placeholder="أدخل رقم الفاتورة"
                required
              />
            </div>
            <div class="form-group">
              <label for="editAmount">المبلغ (مصري)</label>
              <input
                type="number"
                id="editAmount"
                placeholder="أدخل المبلغ"
                step="0.01"
                min="0"
                required
              />
            </div>
            <div class="form-group">
              <label for="editStatus">حالة الدفع</label>
              <select id="editStatus" required>
                <option value="paid">مدفوع</option>
                <option value="pending">مستحق</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editDate">تاريخ الدفع</label>
              <input type="date" id="editDate" required />
            </div>
            <div class="form-group">
              <label for="editPaymentMethod">طريقة الدفع</label>
              <select id="editPaymentMethod" required>
                <option value="cash">نقدي</option>
                <option value="bank_transfer">تحويل بنكي</option>
                <option value="credit-card">بطاقة ائتمان</option>
                <option value="check">شيك</option>
                <option value="online">دفع إلكتروني</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editDescription">الوصف (اختياري)</label>
              <textarea
                id="editDescription"
                rows="3"
                placeholder="وصف تفصيلي للدفعة"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelEditPayment">
            إلغاء
          </button>
          <button class="btn btn-primary" id="submitEditPayment">
            حفظ التعديلات
          </button>
        </div>
      </div>
    </div>

    <!-- نافذة تفاصيل الدفعة -->
    <div class="modal" id="viewPaymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">تفاصيل الدفعة</div>
          <button class="modal-close" id="closeViewPaymentModal">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div id="paymentDetails">
            <!-- التفاصيل سيتم إضافتها بواسطة JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="closeViewPayment">إغلاق</button>
          <button class="btn btn-primary" id="printReceipt">
            <i class="fas fa-print"></i>
            طباعة الإيصال
          </button>
        </div>
      </div>
    </div>

    <script>
      // تهيئة قاعدة البيانات (نفس قاعدة بيانات ولي الأمر)
      let paymentsDB;

      function initDatabase() {
        paymentsDB = new Dexie("PaymentsDB");
        paymentsDB.version(1).stores({
          payments:
            "++id, parentName, studentName, amount, status, date, invoiceId, description, paymentMethod, timestamp",
        });
        return paymentsDB.open();
      }

      // المتغيرات العامة
      let currentPage = 1;
      const itemsPerPage = 10;
      let allPayments = [];
      let filteredPayments = [];
      let editingPaymentId = null;

      // الترجمة
      const translations = {
        ar: {
          darkMode: "الوضع الداكن",
          logout: "تسجيل الخروج",
          language: "English",
          addPayment: "إضافة دفعة",
          refresh: "تحديث البيانات",
          searchParent: "بحث عن ولي أمر",
          searchStudent: "بحث عن طالب",
          filterStatus: "تصفية حسب الحالة",
          allStatus: "جميع الحالات",
          paid: "مدفوع",
          pending: "مستحق",
          applyFilters: "تطبيق الفلاتر",
          resetFilters: "إعادة تعيين",
          exportData: "تصدير البيانات",
          paymentsLog: "سجل المدفوعات",
          paymentStatistics: "إحاصصيات المدفوعات",
          studentName: "اسم الطالب",
          parentName: "ولي الأمر",
          totalDue: "إجمالي المستحق",
          paidAmount: "المدفوع",
          remaining: "المتبقي",
          lastPayment: "آخر دفعة",
          status: "الحالة",
          amount: "المبلغ",
          invoiceNumber: "رقم الفاتورة",
          paymentDate: "تاريخ الدفع",
          paymentMethod: "طريقة الدفع",
          actions: "الإجراءات",
          view: "عرض",
          edit: "تعديل",
          delete: "حذف",
          addNewPayment: "إضافة دفعة جديدة",
          editPayment: "تعديل الدفعة",
          paymentDetails: "تفاصيل الدفعة",
          cancel: "إلغاء",
          save: "حفظ",
          close: "إغلاق",
          printReceipt: "طباعة الإيصال",
        },
        en: {
          darkMode: "Dark Mode",
          logout: "Logout",
          language: "العربية",
          addPayment: "Add Payment",
          refresh: "Refresh Data",
          searchParent: "Search Parent",
          searchStudent: "Search Student",
          filterStatus: "Filter by Status",
          allStatus: "All Statuses",
          paid: "Paid",
          pending: "Pending",
          applyFilters: "Apply Filters",
          resetFilters: "Reset",
          exportData: "Export Data",
          paymentsLog: "Payments Log",
          paymentStatistics: "Payment Statistics",
          studentName: "Student Name",
          parentName: "Parent Name",
          totalDue: "Total Due",
          paidAmount: "Paid",
          remaining: "Remaining",
          lastPayment: "Last Payment",
          status: "Status",
          amount: "Amount",
          invoiceNumber: "Invoice Number",
          paymentDate: "Payment Date",
          paymentMethod: "Payment Method",
          actions: "Actions",
          view: "View",
          edit: "Edit",
          delete: "Delete",
          addNewPayment: "Add New Payment",
          editPayment: "Edit Payment",
          paymentDetails: "Payment Details",
          cancel: "Cancel",
          save: "Save",
          close: "Close",
          printReceipt: "Print Receipt",
        },
      };

      let currentLanguage = "ar";

      // تحديث اللغة
      function updateLanguage(lang) {
        currentLanguage = lang;
        const t = translations[lang];

        // تحديث عناصر الواجهة
        document.querySelectorAll("[data-translate]").forEach((element) => {
          const key = element.getAttribute("data-translate");
          if (t[key]) {
            element.textContent = t[key];
          }
        });

        // تحديث عناصر إضافية
        document.getElementById(
          "btn-add-payment"
        ).innerHTML = `<i class="fas fa-plus-circle"></i> ${t.addPayment}`;
        document.getElementById(
          "btn-refresh"
        ).innerHTML = `<i class="fas fa-sync-alt"></i> ${t.refresh}`;
        document.getElementById(
          "header-dark-mode-toggle"
        ).innerHTML = `<i class="fas fa-moon"></i> <span>${t.darkMode}</span>`;
        document.querySelector(
          ".logout-btn"
        ).innerHTML = `<i class="fas fa-sign-out-alt"></i> <span>${t.logout}</span>`;
        document.getElementById(
          "sidebar-dark-mode-toggle"
        ).innerHTML = `<i class="fas fa-moon"></i> <span>${t.darkMode}</span>`;
        document.getElementById(
          "sidebar-language-toggle"
        ).innerHTML = `<i class="fas fa-language"></i> <span>${t.language}</span>`;

        // إعادة تحميل البيانات لعكس التغييرات
        loadPayments();
      }

      // عرض رسائل Toast
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideUp 0.3s ease";
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 3000);
      }

      // تنسيق التاريخ
      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleDateString("ar-SA", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      // تنسيق العملة
      function formatCurrency(amount) {
        return new Intl.NumberFormat("ar-EG", {
          style: "currency",
          currency: "EGP",
        }).format(amount);
      }

      // تحميل المدفوعات من IndexedDB
      async function loadPayments() {
        try {
          await initDatabase();
          allPayments = await paymentsDB.payments.toArray();

          // ترتيب المدفوعات حسب التاريخ (الأحدث أولاً)
          allPayments.sort(
            (a, b) =>
              new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date)
          );

          // تطبيق الفلاتر الحالية
          applyFilters();

          // تحديث الإحصائيات
          updateStatistics();

          // عرض الجداول
          renderPaymentsTable();
          renderStatisticsTable();

          showToast("تم تحديث البيانات بنجاح", "success");
        } catch (error) {
          console.error("Error loading payments:", error);
          showToast("حدث خطأ في تحميل البيانات", "danger");
        }
      }

      // تطبيق الفلاتر
      function applyFilters() {
        const searchParent = document
          .getElementById("search-parent")
          .value.toLowerCase();
        const searchStudent = document
          .getElementById("search-student")
          .value.toLowerCase();
        const filterStatus = document.getElementById("filter-status").value;
        const fromDate = document.getElementById("filter-from-date").value;
        const toDate = document.getElementById("filter-to-date").value;

        filteredPayments = allPayments.filter((payment) => {
          // فلترة حسب اسم ولي الأمر
          if (
            searchParent &&
            !payment.parentName.toLowerCase().includes(searchParent)
          ) {
            return false;
          }

          // فلترة حسب اسم الطالب
          if (
            searchStudent &&
            !payment.studentName.toLowerCase().includes(searchStudent)
          ) {
            return false;
          }

          // فلترة حسب الحالة
          if (filterStatus !== "all" && payment.status !== filterStatus) {
            return false;
          }

          // فلترة حسب النطاق الزمني
          if (fromDate && new Date(payment.date) < new Date(fromDate)) {
            return false;
          }

          if (toDate && new Date(payment.date) > new Date(toDate)) {
            return false;
          }

          return true;
        });

        currentPage = 1; // العودة للصفحة الأولى بعد التصفية
      }

      // تحديث الإحصائيات
      function updateStatistics() {
        const t = translations[currentLanguage];

        // حساب الإحصائيات
        const totalCollected = allPayments
          .filter((p) => p.status === "paid")
          .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);

        const totalPaid = allPayments.filter((p) => p.status === "paid").length;
        const totalPending = allPayments.filter(
          (p) => p.status === "pending"
        ).length;

        // الحصول على عدد أولياء الأمور الفريدين
        const uniqueParents = [...new Set(allPayments.map((p) => p.parentName))]
          .length;

        // تحديث بطاقات الإحصائيات
        document.getElementById("total-collected").textContent =
          formatCurrency(totalCollected);
        document.getElementById("total-paid").textContent = totalPaid;
        document.getElementById("total-pending").textContent = totalPending;
        document.getElementById("total-parents").textContent = uniqueParents;
      }

      // عرض جدول المدفوعات
      function renderPaymentsTable() {
        const tbody = document.getElementById("payments-table-body");
        tbody.innerHTML = "";

        const t = translations[currentLanguage];

        // حساب الصفحات
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pagePayments = filteredPayments.slice(startIndex, endIndex);

        if (pagePayments.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="9" style="text-align: center; padding: 40px; color: var(--text-light);">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                    لا توجد مدفوعات لعرضها
                </td>`;
          tbody.appendChild(row);
        } else {
          pagePayments.forEach((payment, index) => {
            const row = document.createElement("tr");

            const statusText = payment.status === "paid" ? t.paid : t.pending;
            const statusClass =
              payment.status === "paid" ? "badge-success" : "badge-warning";

            // الحصول على اسم طريقة الدفع بالعربية
            const paymentMethodText = getPaymentMethodText(
              payment.paymentMethod
            );

            row.innerHTML = `
                        <td>${startIndex + index + 1}</td>
                        <td><strong>${payment.parentName || "-"}</strong></td>
                        <td>${payment.studentName || "-"}</td>
                        <td><strong>${formatCurrency(
                          payment.amount || 0
                        )}</strong></td>
                        <td><span class="badge badge-primary">${
                          payment.invoiceId || "-"
                        }</span></td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(payment.date)}</td>
                        <td>${paymentMethodText}</td>
                        <td>
                            <div class="table-actions">
                                <div class="action-icon action-view" onclick="viewPayment(${
                                  payment.id
                                })" title="${t.view}">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="action-icon action-edit" onclick="editPayment(${
                                  payment.id
                                })" title="${t.edit}">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-icon action-delete" onclick="deletePayment(${
                                  payment.id
                                })" title="${t.delete}">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </td>
                    `;

            tbody.appendChild(row);
          });
        }

        // عرض أرقام الصفحات
        renderPagination();
      }

      // عرض أرقام الصفحات
      function renderPagination() {
        const pagination = document.getElementById("payments-pagination");
        pagination.innerHTML = "";

        const totalPages = Math.ceil(filteredPayments.length / itemsPerPage);

        if (totalPages <= 1) return;

        // زر الصفحة السابقة
        if (currentPage > 1) {
          const prevBtn = document.createElement("button");
          prevBtn.className = "page-btn";
          prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
          prevBtn.onclick = () => {
            currentPage--;
            renderPaymentsTable();
          };
          pagination.appendChild(prevBtn);
        }

        // أرقام الصفحات
        for (let i = 1; i <= totalPages; i++) {
          const pageBtn = document.createElement("button");
          pageBtn.className = `page-btn ${i === currentPage ? "active" : ""}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => {
            currentPage = i;
            renderPaymentsTable();
          };
          pagination.appendChild(pageBtn);
        }

        // زر الصفحة التالية
        if (currentPage < totalPages) {
          const nextBtn = document.createElement("button");
          nextBtn.className = "page-btn";
          nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
          nextBtn.onclick = () => {
            currentPage++;
            renderPaymentsTable();
          };
          pagination.appendChild(nextBtn);
        }
      }

      // عرض جدول الإحصائيات
      function renderStatisticsTable() {
        const tbody = document.getElementById("statistics-table-body");
        tbody.innerHTML = "";

        const t = translations[currentLanguage];

        // تجميع البيانات حسب الطالب
        const studentStats = {};

        allPayments.forEach((payment) => {
          const studentName = payment.studentName;
          if (!studentStats[studentName]) {
            studentStats[studentName] = {
              parentName: payment.parentName,
              totalDue: 0,
              totalPaid: 0,
              lastPayment: null,
            };
          }

          studentStats[studentName].totalDue += payment.amount || 0;

          if (payment.status === "paid") {
            studentStats[studentName].totalPaid += payment.amount || 0;
          }

          // تحديث آخر دفعة
          const paymentDate = new Date(payment.timestamp || payment.date);
          if (
            !studentStats[studentName].lastPayment ||
            paymentDate > studentStats[studentName].lastPayment
          ) {
            studentStats[studentName].lastPayment = paymentDate;
          }
        });

        // عرض الإحصائيات
        Object.entries(studentStats).forEach(([studentName, stats]) => {
          const remaining = stats.totalDue - stats.totalPaid;
          const statusClass =
            remaining === 0 ? "badge-success" : "badge-warning";
          const statusText = remaining === 0 ? t.paid : t.pending;

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td><strong>${studentName}</strong></td>
                    <td>${stats.parentName || "-"}</td>
                    <td><strong>${formatCurrency(stats.totalDue)}</strong></td>
                    <td><span class="badge badge-success">${formatCurrency(
                      stats.totalPaid
                    )}</span></td>
                    <td><span class="badge badge-danger">${formatCurrency(
                      remaining
                    )}</span></td>
                    <td>${
                      stats.lastPayment ? formatDate(stats.lastPayment) : "-"
                    }</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                `;

          tbody.appendChild(row);
        });
      }

      // الحصول على نص طريقة الدفع
      function getPaymentMethodText(method) {
        const methods = {
          cash: "نقدي",
          bank_transfer: "تحويل بنكي",
          credit_card: "بطاقة ائتمان",
          check: "شيك",
          online: "دفع إلكتروني",
        };
        return methods[method] || method;
      }

      // فتح نافذة إضافة دفعة
      function openAddPaymentModal() {
        document.getElementById("addPaymentModal").classList.add("active");

        // تعيين تاريخ اليوم كافتراضي
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("addDate").value = today;

        // إضافة بعض البيانات الافتراضية للمساعدة
        document.getElementById("addParentName").value = "ولي الأمر";
        document.getElementById("addStudentName").value = "أحمد محمد";
        document.getElementById("addInvoiceId").value =
          "INV-" +
          new Date().getFullYear() +
          "-" +
          Math.floor(Math.random() * 1000)
            .toString()
            .padStart(3, "0");
      }

      // إغلاق نافذة إضافة دفعة
      function closeAddPaymentModal() {
        document.getElementById("addPaymentModal").classList.remove("active");
        document.getElementById("addPaymentForm").reset();
      }

      // فتح نافذة تعديل دفعة
      async function editPayment(paymentId) {
        try {
          const payment = await paymentsDB.payments.get(paymentId);
          if (!payment) {
            showToast("لم يتم العثور على الدفعة", "warning");
            return;
          }

          editingPaymentId = paymentId;

          // تعبئة النموذج بالبيانات
          document.getElementById("editPaymentId").value = payment.id;
          document.getElementById("editParentName").value =
            payment.parentName || "";
          document.getElementById("editStudentName").value =
            payment.studentName || "";
          document.getElementById("editInvoiceId").value =
            payment.invoiceId || "";
          document.getElementById("editAmount").value = payment.amount || "";
          document.getElementById("editStatus").value =
            payment.status || "pending";
          document.getElementById("editDate").value = payment.date || "";
          document.getElementById("editPaymentMethod").value =
            payment.paymentMethod || "cash";
          document.getElementById("editDescription").value =
            payment.description || "";

          // فتح النافذة
          document.getElementById("editPaymentModal").classList.add("active");
        } catch (error) {
          console.error("Error loading payment:", error);
          showToast("حدث خطأ في تحميل البيانات", "danger");
        }
      }

      // إغلاق نافذة تعديل دفعة
      function closeEditPaymentModal() {
        document.getElementById("editPaymentModal").classList.remove("active");
        document.getElementById("editPaymentForm").reset();
        editingPaymentId = null;
      }

      // عرض تفاصيل الدفعة
      async function viewPayment(paymentId) {
        try {
          const payment = await paymentsDB.payments.get(paymentId);
          if (!payment) {
            showToast("لم يتم العثور على الدفعة", "warning");
            return;
          }

          const t = translations[currentLanguage];
          const paymentMethodText = getPaymentMethodText(payment.paymentMethod);

          const detailsHTML = `
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(74, 108, 247, 0.1); border-radius: 10px;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">رقم الفاتورة</div>
                                <div style="font-size: 18px; font-weight: bold; color: var(--primary);">${
                                  payment.invoiceId || "-"
                                }</div>
                            </div>
                            <span class="badge ${
                              payment.status === "paid"
                                ? "badge-success"
                                : "badge-warning"
                            }">
                                ${
                                  payment.status === "paid" ? t.paid : t.pending
                                }
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 15px; background: var(--light); border-radius: 10px;">
                                <div style="font-size: 12px; color: var(--text-light);">${
                                  t.parentName
                                }</div>
                                <div style="font-size: 16px; font-weight: bold;">${
                                  payment.parentName || "-"
                                }</div>
                            </div>
                            <div style="padding: 15px; background: var(--light); border-radius: 10px;">
                                <div style="font-size: 12px; color: var(--text-light);">${
                                  t.studentName
                                }</div>
                                <div style="font-size: 16px; font-weight: bold;">${
                                  payment.studentName || "-"
                                }</div>
                            </div>
                        </div>
                        
                        <div style="padding: 20px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; color: rgba(255, 255, 255, 0.9);">${
                              t.amount
                            }</div>
                            <div style="font-size: 32px; font-weight: bold; color: white;">${formatCurrency(
                              payment.amount || 0
                            )}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 15px; background: var(--light); border-radius: 10px;">
                                <div style="font-size: 12px; color: var(--text-light);">${
                                  t.paymentDate
                                }</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatDate(
                                  payment.date
                                )}</div>
                            </div>
                            <div style="padding: 15px; background: var(--light); border-radius: 10px;">
                                <div style="font-size: 12px; color: var(--text-light);">${
                                  t.paymentMethod
                                }</div>
                                <div style="font-size: 16px; font-weight: bold;">${paymentMethodText}</div>
                            </div>
                        </div>
                        
                        ${
                          payment.description
                            ? `
                        <div style="padding: 15px; background: var(--light); border-radius: 10px;">
                            <div style="font-size: 12px; color: var(--text-light); margin-bottom: 8px;">الوصف</div>
                            <div style="font-size: 14px; line-height: 1.6;">${payment.description}</div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                `;

          document.getElementById("paymentDetails").innerHTML = detailsHTML;
          document.getElementById("viewPaymentModal").classList.add("active");
        } catch (error) {
          console.error("Error loading payment details:", error);
          showToast("حدث خطأ في تحميل التفاصيل", "danger");
        }
      }

      // إغلاق نافذة التفاصيل
      function closeViewPaymentModal() {
        document.getElementById("viewPaymentModal").classList.remove("active");
      }

      // حذف دفعة
      async function deletePayment(paymentId) {
        const t = translations[currentLanguage];
        if (!confirm("هل أنت متأكد من حذف هذه الدفعة؟")) return;

        try {
          await paymentsDB.payments.delete(paymentId);
          showToast("تم حذف الدفعة بنجاح", "success");
          await loadPayments();
        } catch (error) {
          console.error("Error deleting payment:", error);
          showToast("حدث خطأ في حذف الدفعة", "danger");
        }
      }

      // طباعة الإيصال
      function printReceipt() {
        const t = translations[currentLanguage];
        showToast("جاري تحضير الإيصال للطباعة...", "info");
        // في التطبيق الحقيقي، هنا سيتم فتح نافذة طباعة أو إنشاء PDF
      }

      // تصدير البيانات
      function exportData() {
        const t = translations[currentLanguage];
        showToast("جاري تصدير البيانات...", "info");

        // إنشاء بيانات CSV
        let csv =
          "اسم ولي الأمر,اسم الطالب,المبلغ,رقم الفاتورة,الحالة,تاريخ الدفع,طريقة الدفع\n";

        filteredPayments.forEach((payment) => {
          const paymentMethodText = getPaymentMethodText(payment.paymentMethod);
          csv += `"${payment.parentName || ""}","${
            payment.studentName || ""
          }",${payment.amount || 0},"${payment.invoiceId || ""}","${
            payment.status || ""
          }","${payment.date || ""}","${paymentMethodText}"\n`;
        });

        // إنشاء ملف وتنزيله
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `مدفوعات_${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // إعادة تعيين الفلاتر
      function resetFilters() {
        document.getElementById("search-parent").value = "";
        document.getElementById("search-student").value = "";
        document.getElementById("filter-status").value = "all";
        document.getElementById("filter-from-date").value = "";
        document.getElementById("filter-to-date").value = "";

        applyFilters();
        renderPaymentsTable();
        showToast("تم إعادة تعيين الفلاتر", "info");
      }

      // تهيئة الصفحة
      document.addEventListener("DOMContentLoaded", async function () {
        // تحميل الإعدادات من localStorage
        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark-mode");
        }

        if (localStorage.getItem("language") === "en") {
          document.body.classList.remove("rtl");
          document.body.classList.add("ltr");
          document.documentElement.lang = "en";
          document.documentElement.dir = "ltr";
          currentLanguage = "en";
        }

        updateLanguage(currentLanguage);

        // تعيين تاريخ اليوم كافتراضي لحقول التاريخ
        const today = new Date().toISOString().split("T")[0];
        const firstDay = new Date();
        firstDay.setDate(1);
        const firstDayStr = firstDay.toISOString().split("T")[0];

        document.getElementById("filter-from-date").value = firstDayStr;
        document.getElementById("filter-to-date").value = today;

        // تعيين التواريخ في النماذج
        document.getElementById("addDate").value = today;
        document.getElementById("editDate").value = today;

        // تحميل البيانات
        await loadPayments();

        // تعيين الأحداث
        // أحداث الوضع الداكن
        document
          .getElementById("header-dark-mode-toggle")
          .addEventListener("click", toggleDarkMode);
        document
          .getElementById("sidebar-dark-mode-toggle")
          .addEventListener("click", toggleDarkMode);

        // أحداث تبديل اللغة
        document
          .getElementById("sidebar-language-toggle")
          .addEventListener("click", toggleLanguage);

        // أحداث الأزرار الرئيسية
        document
          .getElementById("btn-add-payment")
          .addEventListener("click", openAddPaymentModal);
        document
          .getElementById("btn-refresh")
          .addEventListener("click", loadPayments);
        document
          .getElementById("refresh-payments")
          .addEventListener("click", loadPayments);

        // أحداث الفلاتر
        document
          .getElementById("btn-apply-filters")
          .addEventListener("click", () => {
            applyFilters();
            renderPaymentsTable();
            showToast("تم تطبيق الفلاتر", "info");
          });

        document
          .getElementById("btn-reset-filters")
          .addEventListener("click", resetFilters);
        document
          .getElementById("btn-export-data")
          .addEventListener("click", exportData);

        // أحداث النماذج
        document
          .getElementById("closeAddPaymentModal")
          .addEventListener("click", closeAddPaymentModal);
        document
          .getElementById("cancelAddPayment")
          .addEventListener("click", closeAddPaymentModal);
        document
          .getElementById("closeEditPaymentModal")
          .addEventListener("click", closeEditPaymentModal);
        document
          .getElementById("cancelEditPayment")
          .addEventListener("click", closeEditPaymentModal);
        document
          .getElementById("closeViewPaymentModal")
          .addEventListener("click", closeViewPaymentModal);
        document
          .getElementById("closeViewPayment")
          .addEventListener("click", closeViewPaymentModal);
        document
          .getElementById("printReceipt")
          .addEventListener("click", printReceipt);

        // إرسال نموذج إضافة دفعة
        document
          .getElementById("submitAddPayment")
          .addEventListener("click", async () => {
            try {
              const parentName = document
                .getElementById("addParentName")
                .value.trim();
              const studentName = document
                .getElementById("addStudentName")
                .value.trim();
              const invoiceId = document
                .getElementById("addInvoiceId")
                .value.trim();
              const amount = parseFloat(
                document.getElementById("addAmount").value
              );
              const status = document.getElementById("addStatus").value;
              const date = document.getElementById("addDate").value;
              const paymentMethod =
                document.getElementById("addPaymentMethod").value;
              const description =
                document.getElementById("addDescription").value;

              if (
                !parentName ||
                !studentName ||
                !invoiceId ||
                !amount ||
                !date
              ) {
                showToast("يرجى ملء جميع الحقول المطلوبة", "warning");
                return;
              }

              await paymentsDB.payments.add({
                parentName,
                studentName,
                invoiceId,
                amount,
                status,
                date,
                paymentMethod,
                description,
                timestamp: new Date().getTime(),
              });

              showToast("تم إضافة الدفعة بنجاح", "success");
              closeAddPaymentModal();
              await loadPayments();
            } catch (error) {
              console.error("Error adding payment:", error);
              showToast("حدث خطأ في إضافة الدفعة", "danger");
            }
          });

        // إرسال نموذج تعديل دفعة
        document
          .getElementById("submitEditPayment")
          .addEventListener("click", async () => {
            try {
              const paymentId = parseInt(
                document.getElementById("editPaymentId").value
              );
              const parentName = document
                .getElementById("editParentName")
                .value.trim();
              const studentName = document
                .getElementById("editStudentName")
                .value.trim();
              const invoiceId = document
                .getElementById("editInvoiceId")
                .value.trim();
              const amount = parseFloat(
                document.getElementById("editAmount").value
              );
              const status = document.getElementById("editStatus").value;
              const date = document.getElementById("editDate").value;
              const paymentMethod =
                document.getElementById("editPaymentMethod").value;
              const description =
                document.getElementById("editDescription").value;

              if (
                !parentName ||
                !studentName ||
                !invoiceId ||
                !amount ||
                !date
              ) {
                showToast("يرجى ملء جميع الحقول المطلوبة", "warning");
                return;
              }

              await paymentsDB.payments.update(paymentId, {
                parentName,
                studentName,
                invoiceId,
                amount,
                status,
                date,
                paymentMethod,
                description,
                timestamp: new Date().getTime(),
              });

              showToast("تم تحديث الدفعة بنجاح", "success");
              closeEditPaymentModal();
              await loadPayments();
            } catch (error) {
              console.error("Error updating payment:", error);
              showToast("حدث خطأ في تحديث الدفعة", "danger");
            }
          });

        // إغلاق النوافذ عند النقر خارجها
        document
          .getElementById("addPaymentModal")
          .addEventListener("click", function (e) {
            if (e.target === this) closeAddPaymentModal();
          });

        document
          .getElementById("editPaymentModal")
          .addEventListener("click", function (e) {
            if (e.target === this) closeEditPaymentModal();
          });

        document
          .getElementById("viewPaymentModal")
          .addEventListener("click", function (e) {
            if (e.target === this) closeViewPaymentModal();
          });

        // تحديث تلقائي كل 30 ثانية
        setInterval(async () => {
          await loadPayments();
        }, 30000);
      });

      // تبديل الوضع الداكن
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem(
          "darkMode",
          document.body.classList.contains("dark-mode")
        );
      }

      // تبديل اللغة
      function toggleLanguage() {
        const isRTL = document.body.classList.contains("rtl");

        if (isRTL) {
          // التبديل إلى الإنجليزية
          document.body.classList.remove("rtl");
          document.body.classList.add("ltr");
          document.documentElement.lang = "en";
          document.documentElement.dir = "ltr";
          updateLanguage("en");
          localStorage.setItem("language", "en");
        } else {
          // التبديل إلى العربية
          document.body.classList.remove("ltr");
          document.body.classList.add("rtl");
          document.documentElement.lang = "ar";
          document.documentElement.dir = "rtl";
          updateLanguage("ar");
          localStorage.setItem("language", "ar");
        }
      }
    </script>
  </body>
</html>
